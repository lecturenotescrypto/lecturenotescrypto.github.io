<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>E SageMath Cookbook | Cryptography lecture notes</title>
  <meta name="description" content="E SageMath Cookbook | Cryptography lecture notes" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="E SageMath Cookbook | Cryptography lecture notes" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="E SageMath Cookbook | Cryptography lecture notes" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="refreshers.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="part"><span><b>I Introduction to modern cryptography</b></span></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Front page</a></li>
<li class="chapter" data-level="1" data-path="introduction-to-security.html"><a href="introduction-to-security.html"><i class="fa fa-check"></i><b>1</b> Introduction to security</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction-to-security.html"><a href="introduction-to-security.html#what-cryptography-is-and-is-not"><i class="fa fa-check"></i><b>1.1</b> What cryptography is and is not</a></li>
<li class="chapter" data-level="1.2" data-path="introduction-to-security.html"><a href="introduction-to-security.html#fundamental-security-principles"><i class="fa fa-check"></i><b>1.2</b> Fundamental security principles</a></li>
<li class="chapter" data-level="1.3" data-path="introduction-to-security.html"><a href="introduction-to-security.html#security-parameter"><i class="fa fa-check"></i><b>1.3</b> Security parameter</a></li>
<li class="chapter" data-level="1.4" data-path="introduction-to-security.html"><a href="introduction-to-security.html#security-level"><i class="fa fa-check"></i><b>1.4</b> Security level</a></li>
<li class="chapter" data-level="" data-path="introduction-to-security.html"><a href="introduction-to-security.html#solved-exercises"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="part"><span><b>II Symmetric cryptography</b></span></li>
<li class="chapter" data-level="2" data-path="randomness-in-cryptography.html"><a href="randomness-in-cryptography.html"><i class="fa fa-check"></i><b>2</b> Randomness in cryptography</a>
<ul>
<li class="chapter" data-level="2.1" data-path="randomness-in-cryptography.html"><a href="randomness-in-cryptography.html#one-time-pad"><i class="fa fa-check"></i><b>2.1</b> One-time pad</a></li>
<li class="chapter" data-level="2.2" data-path="randomness-in-cryptography.html"><a href="randomness-in-cryptography.html#sec:prngs"><i class="fa fa-check"></i><b>2.2</b> Pseudorandom generators</a></li>
<li class="chapter" data-level="2.3" data-path="randomness-in-cryptography.html"><a href="randomness-in-cryptography.html#true-randomness"><i class="fa fa-check"></i><b>2.3</b> True randomness</a></li>
<li class="chapter" data-level="" data-path="randomness-in-cryptography.html"><a href="randomness-in-cryptography.html#solved-exercises-1"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="block-ciphers.html"><a href="block-ciphers.html"><i class="fa fa-check"></i><b>3</b> Block ciphers</a>
<ul>
<li class="chapter" data-level="3.1" data-path="block-ciphers.html"><a href="block-ciphers.html#overview-of-block-ciphers"><i class="fa fa-check"></i><b>3.1</b> Overview of block ciphers</a></li>
<li class="chapter" data-level="3.2" data-path="block-ciphers.html"><a href="block-ciphers.html#modes-of-operation"><i class="fa fa-check"></i><b>3.2</b> Modes of operation</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="block-ciphers.html"><a href="block-ciphers.html#electronic-codebook-ecb-mode"><i class="fa fa-check"></i><b>3.2.1</b> Electronic codebook (ECB) mode</a></li>
<li class="chapter" data-level="3.2.2" data-path="block-ciphers.html"><a href="block-ciphers.html#cipher-block-chaining-cbc-mode"><i class="fa fa-check"></i><b>3.2.2</b> Cipher block chaining (CBC) mode</a></li>
<li class="chapter" data-level="3.2.3" data-path="block-ciphers.html"><a href="block-ciphers.html#output-feedback-ofb-mode"><i class="fa fa-check"></i><b>3.2.3</b> Output feedback (OFB) mode</a></li>
<li class="chapter" data-level="3.2.4" data-path="block-ciphers.html"><a href="block-ciphers.html#counter-ctr-mode"><i class="fa fa-check"></i><b>3.2.4</b> Counter (CTR) mode</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="block-ciphers.html"><a href="block-ciphers.html#des-and-aes"><i class="fa fa-check"></i><b>3.3</b> DES and AES</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="block-ciphers.html"><a href="block-ciphers.html#data-encryption-standard-des"><i class="fa fa-check"></i><b>3.3.1</b> Data Encryption Standard (DES)</a></li>
<li class="chapter" data-level="3.3.2" data-path="block-ciphers.html"><a href="block-ciphers.html#advanced-encryption-standard-aes"><i class="fa fa-check"></i><b>3.3.2</b> Advanced Encryption Standard (AES)</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="block-ciphers.html"><a href="block-ciphers.html#solved-exercises-2"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="security-definitions.html"><a href="security-definitions.html"><i class="fa fa-check"></i><b>4</b> Security definitions</a>
<ul>
<li class="chapter" data-level="4.1" data-path="security-definitions.html"><a href="security-definitions.html#key-recovery-experiment"><i class="fa fa-check"></i><b>4.1</b> Key recovery experiment</a></li>
<li class="chapter" data-level="4.2" data-path="security-definitions.html"><a href="security-definitions.html#indistinguishability-under-ciphertext-only-experiment"><i class="fa fa-check"></i><b>4.2</b> Indistinguishability under ciphertext only experiment</a></li>
<li class="chapter" data-level="4.3" data-path="security-definitions.html"><a href="security-definitions.html#indistinguishability-under-chosen-plaintext-attack"><i class="fa fa-check"></i><b>4.3</b> Indistinguishability under chosen plaintext attack</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="security-definitions.html"><a href="security-definitions.html#casestudy-the-battle-of-midway"><i class="fa fa-check"></i><b>4.3.1</b> Casestudy: the battle of Midway</a></li>
<li class="chapter" data-level="4.3.2" data-path="security-definitions.html"><a href="security-definitions.html#the-ind-cpa-experiment"><i class="fa fa-check"></i><b>4.3.2</b> The IND-CPA experiment</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="security-definitions.html"><a href="security-definitions.html#indistinguishability-under-chosen-ciphertext-attack"><i class="fa fa-check"></i><b>4.4</b> Indistinguishability under chosen ciphertext attack</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="security-definitions.html"><a href="security-definitions.html#malleability-of-cbc-mode"><i class="fa fa-check"></i><b>4.4.1</b> Malleability of CBC mode</a></li>
<li class="chapter" data-level="4.4.2" data-path="security-definitions.html"><a href="security-definitions.html#padding-oracle-attack"><i class="fa fa-check"></i><b>4.4.2</b> Padding oracle attack</a></li>
<li class="chapter" data-level="4.4.3" data-path="security-definitions.html"><a href="security-definitions.html#the-ind-cca-experiment"><i class="fa fa-check"></i><b>4.4.3</b> The IND-CCA experiment</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="security-definitions.html"><a href="security-definitions.html#notes-on-defining-and-interpreting-security"><i class="fa fa-check"></i><b>4.5</b> Notes on defining and interpreting security</a></li>
<li class="chapter" data-level="" data-path="security-definitions.html"><a href="security-definitions.html#solved-exercises-3"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="hash-functions.html"><a href="hash-functions.html"><i class="fa fa-check"></i><b>5</b> Hash functions</a>
<ul>
<li class="chapter" data-level="5.1" data-path="hash-functions.html"><a href="hash-functions.html#some-issues-in-cryptocurrencies"><i class="fa fa-check"></i><b>5.1</b> Some issues in cryptocurrencies</a></li>
<li class="chapter" data-level="5.2" data-path="hash-functions.html"><a href="hash-functions.html#sec:hash_def"><i class="fa fa-check"></i><b>5.2</b> Hash functions</a></li>
<li class="chapter" data-level="5.3" data-path="hash-functions.html"><a href="hash-functions.html#birthday-attacks"><i class="fa fa-check"></i><b>5.3</b> Birthday attacks</a></li>
<li class="chapter" data-level="5.4" data-path="hash-functions.html"><a href="hash-functions.html#the-merkle-damgård-transformation"><i class="fa fa-check"></i><b>5.4</b> The Merkle-Damgård transformation</a></li>
<li class="chapter" data-level="" data-path="hash-functions.html"><a href="hash-functions.html#solved-exercises-4"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="part"><span><b>III Asymmetric cryptography</b></span></li>
<li class="chapter" data-level="6" data-path="elementary-number-theory.html"><a href="elementary-number-theory.html"><i class="fa fa-check"></i><b>6</b> Elementary number theory</a>
<ul>
<li class="chapter" data-level="6.1" data-path="elementary-number-theory.html"><a href="elementary-number-theory.html#integer-arithmetic"><i class="fa fa-check"></i><b>6.1</b> Integer arithmetic</a></li>
<li class="chapter" data-level="6.2" data-path="elementary-number-theory.html"><a href="elementary-number-theory.html#the-euclidean-algorithm"><i class="fa fa-check"></i><b>6.2</b> The euclidean algorithm</a></li>
<li class="chapter" data-level="6.3" data-path="elementary-number-theory.html"><a href="elementary-number-theory.html#modular-arithmetic"><i class="fa fa-check"></i><b>6.3</b> Modular arithmetic</a></li>
<li class="chapter" data-level="6.4" data-path="elementary-number-theory.html"><a href="elementary-number-theory.html#efficient-modular"><i class="fa fa-check"></i><b>6.4</b> Modular arithmetic, but efficient</a></li>
<li class="chapter" data-level="" data-path="elementary-number-theory.html"><a href="elementary-number-theory.html#solved-exercises-5"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="algebraic-structures.html"><a href="algebraic-structures.html"><i class="fa fa-check"></i><b>7</b> Algebraic structures</a>
<ul>
<li class="chapter" data-level="7.1" data-path="algebraic-structures.html"><a href="algebraic-structures.html#groups"><i class="fa fa-check"></i><b>7.1</b> Groups</a></li>
<li class="chapter" data-level="7.2" data-path="algebraic-structures.html"><a href="algebraic-structures.html#finite-fields"><i class="fa fa-check"></i><b>7.2</b> Finite fields</a></li>
<li class="chapter" data-level="" data-path="algebraic-structures.html"><a href="algebraic-structures.html#solved-exercises-6"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="public-key-encryption.html"><a href="public-key-encryption.html"><i class="fa fa-check"></i><b>8</b> Public-key encryption</a>
<ul>
<li class="chapter" data-level="8.1" data-path="public-key-encryption.html"><a href="public-key-encryption.html#public-key-cryptography"><i class="fa fa-check"></i><b>8.1</b> Public-key cryptography</a></li>
<li class="chapter" data-level="8.2" data-path="public-key-encryption.html"><a href="public-key-encryption.html#the-rsa-encryption-scheme"><i class="fa fa-check"></i><b>8.2</b> The RSA encryption scheme</a></li>
<li class="chapter" data-level="8.3" data-path="public-key-encryption.html"><a href="public-key-encryption.html#security-of-rsa"><i class="fa fa-check"></i><b>8.3</b> Security of RSA</a></li>
<li class="chapter" data-level="8.4" data-path="public-key-encryption.html"><a href="public-key-encryption.html#rsa-optimization"><i class="fa fa-check"></i><b>8.4</b> Efficiency optimizations</a></li>
<li class="chapter" data-level="" data-path="public-key-encryption.html"><a href="public-key-encryption.html#solved-exercises-7"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="discrete-logarithm-cryptosystems.html"><a href="discrete-logarithm-cryptosystems.html"><i class="fa fa-check"></i><b>9</b> Discrete logarithm cryptosystems</a>
<ul>
<li class="chapter" data-level="9.1" data-path="discrete-logarithm-cryptosystems.html"><a href="discrete-logarithm-cryptosystems.html#the-discrete-logarithm-problem"><i class="fa fa-check"></i><b>9.1</b> The discrete logarithm problem</a></li>
<li class="chapter" data-level="9.2" data-path="discrete-logarithm-cryptosystems.html"><a href="discrete-logarithm-cryptosystems.html#the-diffie-hellman-key-exchange"><i class="fa fa-check"></i><b>9.2</b> The Diffie-Hellman key exchange</a></li>
<li class="chapter" data-level="9.3" data-path="discrete-logarithm-cryptosystems.html"><a href="discrete-logarithm-cryptosystems.html#the-elgamal-encryption-scheme"><i class="fa fa-check"></i><b>9.3</b> The ElGamal encryption scheme</a></li>
<li class="chapter" data-level="9.4" data-path="discrete-logarithm-cryptosystems.html"><a href="discrete-logarithm-cryptosystems.html#formal-security-for-public-key-encryption"><i class="fa fa-check"></i><b>9.4</b> Formal security for public key encryption</a></li>
<li class="chapter" data-level="" data-path="discrete-logarithm-cryptosystems.html"><a href="discrete-logarithm-cryptosystems.html#solved-exercises-8"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="digital-signatures.html"><a href="digital-signatures.html"><i class="fa fa-check"></i><b>10</b> Digital signatures</a>
<ul>
<li class="chapter" data-level="10.1" data-path="digital-signatures.html"><a href="digital-signatures.html#signature-schemes"><i class="fa fa-check"></i><b>10.1</b> Signature schemes</a></li>
<li class="chapter" data-level="10.2" data-path="digital-signatures.html"><a href="digital-signatures.html#rsa-signatures"><i class="fa fa-check"></i><b>10.2</b> RSA signatures</a></li>
<li class="chapter" data-level="10.3" data-path="digital-signatures.html"><a href="digital-signatures.html#signing-large-messages"><i class="fa fa-check"></i><b>10.3</b> Signing large messages</a></li>
<li class="chapter" data-level="" data-path="digital-signatures.html"><a href="digital-signatures.html#solved-exercises-9"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="secret-sharing.html"><a href="secret-sharing.html"><i class="fa fa-check"></i><b>11</b> Secret sharing</a>
<ul>
<li class="chapter" data-level="11.1" data-path="secret-sharing.html"><a href="secret-sharing.html#secret-sharing-1"><i class="fa fa-check"></i><b>11.1</b> Secret sharing</a></li>
<li class="chapter" data-level="11.2" data-path="secret-sharing.html"><a href="secret-sharing.html#sec:ssss"><i class="fa fa-check"></i><b>11.2</b> The Shamir secret sharing scheme</a></li>
<li class="chapter" data-level="11.3" data-path="secret-sharing.html"><a href="secret-sharing.html#threshold-decryption-in-the-elgamal-encryption-scheme"><i class="fa fa-check"></i><b>11.3</b> Threshold decryption in the ElGamal encryption scheme</a></li>
<li class="chapter" data-level="" data-path="secret-sharing.html"><a href="secret-sharing.html#solved-exercises-10"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="zero-knowledge-proofs.html"><a href="zero-knowledge-proofs.html"><i class="fa fa-check"></i><b>12</b> Zero knowledge Proofs</a>
<ul>
<li class="chapter" data-level="12.1" data-path="zero-knowledge-proofs.html"><a href="zero-knowledge-proofs.html#sec:schnorr"><i class="fa fa-check"></i><b>12.1</b> The Schnorr Protocol</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="zero-knowledge-proofs.html"><a href="zero-knowledge-proofs.html#simulation-vs-soundness"><i class="fa fa-check"></i><b>12.1.1</b> Simulation vs Soundness</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="zero-knowledge-proofs.html"><a href="zero-knowledge-proofs.html#solved-exercises-11"><i class="fa fa-check"></i>Solved exercises</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="chapter" data-level="A" data-path="ring-theory.html"><a href="ring-theory.html"><i class="fa fa-check"></i><b>A</b> Ring theory</a></li>
<li class="chapter" data-level="B" data-path="primality-testing.html"><a href="primality-testing.html"><i class="fa fa-check"></i><b>B</b> Primality testing</a></li>
<li class="chapter" data-level="C" data-path="polynomial-interpolation.html"><a href="polynomial-interpolation.html"><i class="fa fa-check"></i><b>C</b> Polynomial interpolation</a></li>
<li class="chapter" data-level="D" data-path="refreshers.html"><a href="refreshers.html"><i class="fa fa-check"></i><b>D</b> Refreshers</a>
<ul>
<li class="chapter" data-level="D.1" data-path="refreshers.html"><a href="refreshers.html#set-notation"><i class="fa fa-check"></i><b>D.1</b> Set notation</a></li>
<li class="chapter" data-level="D.2" data-path="refreshers.html"><a href="refreshers.html#probability-theory"><i class="fa fa-check"></i><b>D.2</b> Probability theory</a></li>
<li class="chapter" data-level="D.3" data-path="refreshers.html"><a href="refreshers.html#asymptotic-notation"><i class="fa fa-check"></i><b>D.3</b> Asymptotic notation</a></li>
<li class="chapter" data-level="D.4" data-path="refreshers.html"><a href="refreshers.html#polydiv"><i class="fa fa-check"></i><b>D.4</b> Polynomial division</a></li>
</ul></li>
<li class="chapter" data-level="E" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html"><i class="fa fa-check"></i><b>E</b> SageMath Cookbook</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#installing-and-running"><i class="fa fa-check"></i>Installing and running</a></li>
<li class="chapter" data-level="E.1" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#basic-operations"><i class="fa fa-check"></i><b>E.1</b> Basic Operations</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#arithmetic-operations"><i class="fa fa-check"></i>Arithmetic Operations</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#comparison-operations"><i class="fa fa-check"></i>Comparison Operations</a></li>
</ul></li>
<li class="chapter" data-level="E.2" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#bits-bytes-and-encoding"><i class="fa fa-check"></i><b>E.2</b> Bits, Bytes and Encoding</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#bitwise-operations"><i class="fa fa-check"></i>Bitwise Operations</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#encodedecode-ascii"><i class="fa fa-check"></i>Encode/Decode ASCII</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-random-bitstring"><i class="fa fa-check"></i>Sampling Random Bitstring</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-random-bytes"><i class="fa fa-check"></i>Sampling Random Bytes</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#xoring-bytes"><i class="fa fa-check"></i>Xoring bytes</a></li>
</ul></li>
<li class="chapter" data-level="E.3" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#symmetric-key-cryptography"><i class="fa fa-check"></i><b>E.3</b> Symmetric Key Cryptography</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#one-time-pad-1"><i class="fa fa-check"></i>One-Time-Pad</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#prng-sha256"><i class="fa fa-check"></i>PRNG: SHA256</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#block-ciphers-aes128"><i class="fa fa-check"></i>Block Ciphers: AES128</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#modes-of-operation-aes128-cbc"><i class="fa fa-check"></i>Modes of Operation: AES128-CBC</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#modes-of-operation-aes128-counter"><i class="fa fa-check"></i>Modes of Operation: AES128-Counter</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#hash-functions-1"><i class="fa fa-check"></i>Hash Functions</a></li>
</ul></li>
<li class="chapter" data-level="E.4" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#number-theory"><i class="fa fa-check"></i><b>E.4</b> Number theory</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-random-primes"><i class="fa fa-check"></i>Sampling Random Primes</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#factoring"><i class="fa fa-check"></i>Factoring</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#primality-testing-1"><i class="fa fa-check"></i>Primality Testing</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#extended-euclidian-algorithm"><i class="fa fa-check"></i>Extended Euclidian Algorithm</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#modular-arithmetic-1"><i class="fa fa-check"></i>Modular Arithmetic</a></li>
</ul></li>
<li class="chapter" data-level="E.5" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#groups-and-fields"><i class="fa fa-check"></i><b>E.5</b> Groups and Fields</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#additive-groups"><i class="fa fa-check"></i>Additive Groups</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#unit-groups"><i class="fa fa-check"></i>Unit Groups</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#finite-fields-1"><i class="fa fa-check"></i>Finite Fields</a></li>
</ul></li>
<li class="chapter" data-level="E.6" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#polynomials"><i class="fa fa-check"></i><b>E.6</b> Polynomials</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#basic-polynomials-operations"><i class="fa fa-check"></i>Basic Polynomials Operations</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#extended-euclidian-algorithm-for-polynomials"><i class="fa fa-check"></i>Extended Euclidian Algorithm for Polynomials</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#polynomial-interpolation-1"><i class="fa fa-check"></i>Polynomial Interpolation</a></li>
</ul></li>
<li class="chapter" data-level="E.7" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#rsa"><i class="fa fa-check"></i><b>E.7</b> RSA</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-an-rsa-modulus"><i class="fa fa-check"></i>Sampling an RSA Modulus</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-an-rsa-key-pair"><i class="fa fa-check"></i>Sampling an RSA key-pair</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#textbook-rsa-encryption"><i class="fa fa-check"></i>Textbook RSA Encryption</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#rsa-fdh-signatures"><i class="fa fa-check"></i>RSA-FDH Signatures</a></li>
</ul></li>
<li class="chapter" data-level="E.8" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#safe-prime-groups"><i class="fa fa-check"></i><b>E.8</b> Safe Prime Groups</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-safe-primes"><i class="fa fa-check"></i>Sampling Safe Primes</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-a-safe-prime-subgroup"><i class="fa fa-check"></i>Sampling a safe prime subgroup</a></li>
</ul></li>
<li class="chapter" data-level="E.9" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#diffie-hellman-key-exchange"><i class="fa fa-check"></i><b>E.9</b> Diffie Hellman Key Exchange</a></li>
<li class="chapter" data-level="E.10" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#elgamal-over-safe-prime-groups"><i class="fa fa-check"></i><b>E.10</b> ElGamal over Safe Prime Groups</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#sampling-elgamal-keys"><i class="fa fa-check"></i>Sampling ElGamal Keys</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#elgamal-encryption"><i class="fa fa-check"></i>ElGamal Encryption</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#lifted-elgamal-encryption"><i class="fa fa-check"></i>Lifted ElGamal Encryption</a></li>
</ul></li>
<li class="chapter" data-level="E.11" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#elliptic-curve-cryptography-secp256k1-curve"><i class="fa fa-check"></i><b>E.11</b> Elliptic Curve Cryptography: secp256k1 Curve</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#secp256k1-basic-operations"><i class="fa fa-check"></i>secp256k1 Basic Operations</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#diffie-hellman-key-exchange-over-secp256k1"><i class="fa fa-check"></i>Diffie Hellman Key Exchange over secp256k1</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#elgamal-encryption-over-secp256k1"><i class="fa fa-check"></i>ElGamal Encryption over secp256k1</a></li>
</ul></li>
<li class="chapter" data-level="E.12" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#secret-sharing-2"><i class="fa fa-check"></i><b>E.12</b> Secret Sharing</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#simple-secret-sharing"><i class="fa fa-check"></i>Simple Secret Sharing</a></li>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#shamir-secret-sharing"><i class="fa fa-check"></i>Shamir Secret Sharing</a></li>
</ul></li>
<li class="chapter" data-level="E.13" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#threshold-cryptography"><i class="fa fa-check"></i><b>E.13</b> Threshold Cryptography</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#threshold-elgamal"><i class="fa fa-check"></i>Threshold ElGamal</a></li>
</ul></li>
<li class="chapter" data-level="E.14" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#zero-knowledge-proofs-1"><i class="fa fa-check"></i><b>E.14</b> Zero Knowledge Proofs</a>
<ul>
<li class="chapter" data-level="" data-path="sagemath-cookbook.html"><a href="sagemath-cookbook.html#schnorr-protocol-over-secp256k1"><i class="fa fa-check"></i>Schnorr Protocol over secp256k1</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Cryptography lecture notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sagemath-cookbook" class="section level1 hasAnchor" number="17">
<h1><span class="header-section-number">E</span> SageMath Cookbook<a href="sagemath-cookbook.html#sagemath-cookbook" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this appendix we provide a <a href="https://www.sagemath.org">SageMath</a> “cookbook” that contains small self-contained code snippets that are usefull for the course.</p>
<p>You can refer to the <a href="https://doc.sagemath.org">docs</a> for a more in-depth documentation.</p>
<p>We emphasize that the “recipes” presented in this Appendix should <em>under no circumstances be used in the real world</em>. Creating secure cryptographic protocols is a notoriously hard task which needs to follow very specific guidelines. These code snippets make a lot of simplifications and are meant to be used only for educational purposes in the context of this course.</p>
<div id="installing-and-running" class="section level2 unnumbered hasAnchor">
<h2>Installing and running<a href="sagemath-cookbook.html#installing-and-running" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Installation depends on the operating system you are using. Pleaser refer to <a href="https://doc.sagemath.org/html/en/installation/index.html">this guide</a> for detailed instructions.</p>
<p>To launch SageMath simply type <code>sage</code> on a terminal/command prompt. If you are familiar with python’s <a href="https://jupyter.org/">Jupyter Notebook</a> you can run <code>sage -n jupyter</code> to use it.</p>
<p>When in the sage environment, you can simply start coding interactively. You can also edit and save <code>.sage</code> files with any text editor/IDE. To load <code>.sage</code> files, open an interactive sage shell and type
<code>load('filename.sage')</code>.</p>
<p>You can look into the <a href="https://doc.sagemath.org/html/en/tutorial/tour.html">Guided Tour</a> to get familiarized with sage. If you have little familiarity with python, chances are that you won’t need to study anything more to understand and write code!</p>
</div>
<div id="basic-operations" class="section level2 hasAnchor" number="17.1">
<h2><span class="header-section-number">E.1</span> Basic Operations<a href="sagemath-cookbook.html#basic-operations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we give a short overview for handling basic arithmetic and comparison operations.</p>
<div id="arithmetic-operations" class="section level3 unnumbered hasAnchor">
<h3>Arithmetic Operations<a href="sagemath-cookbook.html#arithmetic-operations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the next recipe we show how to perform arithmetic operations in sage. Note that exponentiation can also be done using the <code>^</code> operator
(in contrast to python that uses the <code>**</code> operator).</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="sagemath-cookbook.html#cb16-1" tabindex="-1"></a>a <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb16-2"><a href="sagemath-cookbook.html#cb16-2" tabindex="-1"></a>b <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb16-3"><a href="sagemath-cookbook.html#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="sagemath-cookbook.html#cb16-4" tabindex="-1"></a><span class="co"># Basic arithmetic operations</span></span>
<span id="cb16-5"><a href="sagemath-cookbook.html#cb16-5" tabindex="-1"></a></span>
<span id="cb16-6"><a href="sagemath-cookbook.html#cb16-6" tabindex="-1"></a>add <span class="op">=</span> a <span class="op">+</span> b</span>
<span id="cb16-7"><a href="sagemath-cookbook.html#cb16-7" tabindex="-1"></a><span class="cf">assert</span> add <span class="op">==</span> <span class="dv">51</span></span>
<span id="cb16-8"><a href="sagemath-cookbook.html#cb16-8" tabindex="-1"></a></span>
<span id="cb16-9"><a href="sagemath-cookbook.html#cb16-9" tabindex="-1"></a>sub <span class="op">=</span> a <span class="op">-</span> b </span>
<span id="cb16-10"><a href="sagemath-cookbook.html#cb16-10" tabindex="-1"></a><span class="cf">assert</span> sub <span class="op">==</span> <span class="dv">33</span></span>
<span id="cb16-11"><a href="sagemath-cookbook.html#cb16-11" tabindex="-1"></a></span>
<span id="cb16-12"><a href="sagemath-cookbook.html#cb16-12" tabindex="-1"></a>mul <span class="op">=</span> a <span class="op">*</span> b</span>
<span id="cb16-13"><a href="sagemath-cookbook.html#cb16-13" tabindex="-1"></a><span class="cf">assert</span> mul <span class="op">==</span> <span class="dv">378</span></span>
<span id="cb16-14"><a href="sagemath-cookbook.html#cb16-14" tabindex="-1"></a></span>
<span id="cb16-15"><a href="sagemath-cookbook.html#cb16-15" tabindex="-1"></a>div <span class="op">=</span> a <span class="op">/</span> b</span>
<span id="cb16-16"><a href="sagemath-cookbook.html#cb16-16" tabindex="-1"></a><span class="cf">assert</span> div <span class="op">==</span> <span class="dv">14</span><span class="op">/</span><span class="dv">3</span> </span>
<span id="cb16-17"><a href="sagemath-cookbook.html#cb16-17" tabindex="-1"></a></span>
<span id="cb16-18"><a href="sagemath-cookbook.html#cb16-18" tabindex="-1"></a><span class="co"># We can convert a to a float</span></span>
<span id="cb16-19"><a href="sagemath-cookbook.html#cb16-19" tabindex="-1"></a>div_float <span class="op">=</span> <span class="bu">float</span>(a <span class="op">/</span> b)</span>
<span id="cb16-20"><a href="sagemath-cookbook.html#cb16-20" tabindex="-1"></a></span>
<span id="cb16-21"><a href="sagemath-cookbook.html#cb16-21" tabindex="-1"></a>quot <span class="op">=</span> a <span class="op">//</span> b</span>
<span id="cb16-22"><a href="sagemath-cookbook.html#cb16-22" tabindex="-1"></a><span class="cf">assert</span> quot <span class="op">==</span> <span class="dv">4</span> </span>
<span id="cb16-23"><a href="sagemath-cookbook.html#cb16-23" tabindex="-1"></a></span>
<span id="cb16-24"><a href="sagemath-cookbook.html#cb16-24" tabindex="-1"></a>mod <span class="op">=</span> a <span class="op">%</span> b</span>
<span id="cb16-25"><a href="sagemath-cookbook.html#cb16-25" tabindex="-1"></a><span class="cf">assert</span> mod <span class="op">==</span> <span class="dv">6</span> </span>
<span id="cb16-26"><a href="sagemath-cookbook.html#cb16-26" tabindex="-1"></a></span>
<span id="cb16-27"><a href="sagemath-cookbook.html#cb16-27" tabindex="-1"></a><span class="co"># can also use a**4</span></span>
<span id="cb16-28"><a href="sagemath-cookbook.html#cb16-28" tabindex="-1"></a>exp <span class="op">=</span> <span class="dv">2</span><span class="op">^</span><span class="dv">10</span></span>
<span id="cb16-29"><a href="sagemath-cookbook.html#cb16-29" tabindex="-1"></a><span class="cf">assert</span> exp <span class="op">==</span> <span class="dv">1024</span> </span>
<span id="cb16-30"><a href="sagemath-cookbook.html#cb16-30" tabindex="-1"></a></span>
<span id="cb16-31"><a href="sagemath-cookbook.html#cb16-31" tabindex="-1"></a><span class="co"># the second argument is the base. </span></span>
<span id="cb16-32"><a href="sagemath-cookbook.html#cb16-32" tabindex="-1"></a><span class="co"># default is e</span></span>
<span id="cb16-33"><a href="sagemath-cookbook.html#cb16-33" tabindex="-1"></a>lg <span class="op">=</span> log(<span class="dv">1024</span>, <span class="dv">2</span>) </span>
<span id="cb16-34"><a href="sagemath-cookbook.html#cb16-34" tabindex="-1"></a><span class="cf">assert</span> lg <span class="op">==</span> <span class="dv">10</span> </span>
<span id="cb16-35"><a href="sagemath-cookbook.html#cb16-35" tabindex="-1"></a></span>
<span id="cb16-36"><a href="sagemath-cookbook.html#cb16-36" tabindex="-1"></a><span class="co"># computing n-th roots</span></span>
<span id="cb16-37"><a href="sagemath-cookbook.html#cb16-37" tabindex="-1"></a><span class="co"># sqrt is for symbolic calculations</span></span>
<span id="cb16-38"><a href="sagemath-cookbook.html#cb16-38" tabindex="-1"></a>sq4 <span class="op">=</span> <span class="dv">81</span><span class="op">^</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">4</span>)</span>
<span id="cb16-39"><a href="sagemath-cookbook.html#cb16-39" tabindex="-1"></a><span class="cf">assert</span> sq4 <span class="op">==</span> <span class="dv">3</span> </span></code></pre></div>
</div>
<div id="comparison-operations" class="section level3 unnumbered hasAnchor">
<h3>Comparison Operations<a href="sagemath-cookbook.html#comparison-operations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As demonstrated in the next recipe, comparison operations work as expected.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="sagemath-cookbook.html#cb17-1" tabindex="-1"></a>res <span class="op">=</span> (<span class="dv">1</span> <span class="op">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb17-2"><a href="sagemath-cookbook.html#cb17-2" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> res </span>
<span id="cb17-3"><a href="sagemath-cookbook.html#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="sagemath-cookbook.html#cb17-4" tabindex="-1"></a>res <span class="op">=</span> (<span class="dv">1</span> <span class="op">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb17-5"><a href="sagemath-cookbook.html#cb17-5" tabindex="-1"></a><span class="cf">assert</span> res </span>
<span id="cb17-6"><a href="sagemath-cookbook.html#cb17-6" tabindex="-1"></a></span>
<span id="cb17-7"><a href="sagemath-cookbook.html#cb17-7" tabindex="-1"></a>res <span class="op">=</span> (<span class="dv">12</span> <span class="op">&lt;</span> <span class="dv">15</span>)</span>
<span id="cb17-8"><a href="sagemath-cookbook.html#cb17-8" tabindex="-1"></a><span class="cf">assert</span> res </span>
<span id="cb17-9"><a href="sagemath-cookbook.html#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="sagemath-cookbook.html#cb17-10" tabindex="-1"></a>res <span class="op">=</span> (<span class="dv">10</span> <span class="op">&lt;=</span> <span class="dv">15</span>)</span>
<span id="cb17-11"><a href="sagemath-cookbook.html#cb17-11" tabindex="-1"></a><span class="cf">assert</span> res </span>
<span id="cb17-12"><a href="sagemath-cookbook.html#cb17-12" tabindex="-1"></a></span>
<span id="cb17-13"><a href="sagemath-cookbook.html#cb17-13" tabindex="-1"></a>res <span class="op">=</span> (<span class="dv">20</span> <span class="op">==</span> <span class="dv">21</span>)</span>
<span id="cb17-14"><a href="sagemath-cookbook.html#cb17-14" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> res </span>
<span id="cb17-15"><a href="sagemath-cookbook.html#cb17-15" tabindex="-1"></a></span>
<span id="cb17-16"><a href="sagemath-cookbook.html#cb17-16" tabindex="-1"></a>res <span class="op">=</span> (<span class="va">True</span> <span class="op">!=</span> <span class="va">False</span>)</span>
<span id="cb17-17"><a href="sagemath-cookbook.html#cb17-17" tabindex="-1"></a><span class="cf">assert</span> res </span></code></pre></div>
</div>
</div>
<div id="bits-bytes-and-encoding" class="section level2 hasAnchor" number="17.2">
<h2><span class="header-section-number">E.2</span> Bits, Bytes and Encoding<a href="sagemath-cookbook.html#bits-bytes-and-encoding" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we present ways to handle low level builiding blocks such as bits, bytes and
ASCII Encoding.</p>
<div id="bitwise-operations" class="section level3 unnumbered hasAnchor">
<h3>Bitwise Operations<a href="sagemath-cookbook.html#bitwise-operations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to perform bitwise logical operations (AND, OR, XOR etc).</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="sagemath-cookbook.html#cb18-1" tabindex="-1"></a><span class="co"># 0b0101 represent a binary number </span></span>
<span id="cb18-2"><a href="sagemath-cookbook.html#cb18-2" tabindex="-1"></a><span class="co"># 0x65 represents a hexadecimal number</span></span>
<span id="cb18-3"><a href="sagemath-cookbook.html#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a href="sagemath-cookbook.html#cb18-4" tabindex="-1"></a><span class="co"># to see different representations use the functions bin(n) and hex(n)</span></span>
<span id="cb18-5"><a href="sagemath-cookbook.html#cb18-5" tabindex="-1"></a></span>
<span id="cb18-6"><a href="sagemath-cookbook.html#cb18-6" tabindex="-1"></a><span class="co"># a = 11, b = 12</span></span>
<span id="cb18-7"><a href="sagemath-cookbook.html#cb18-7" tabindex="-1"></a>a <span class="op">=</span> <span class="bn">0b1011</span></span>
<span id="cb18-8"><a href="sagemath-cookbook.html#cb18-8" tabindex="-1"></a>b <span class="op">=</span> <span class="bn">0b1100</span></span>
<span id="cb18-9"><a href="sagemath-cookbook.html#cb18-9" tabindex="-1"></a></span>
<span id="cb18-10"><a href="sagemath-cookbook.html#cb18-10" tabindex="-1"></a><span class="co"># AND</span></span>
<span id="cb18-11"><a href="sagemath-cookbook.html#cb18-11" tabindex="-1"></a>log_and <span class="op">=</span> a <span class="op">&amp;</span> b </span>
<span id="cb18-12"><a href="sagemath-cookbook.html#cb18-12" tabindex="-1"></a><span class="cf">assert</span> log_and <span class="op">==</span> <span class="bn">0b1000</span></span>
<span id="cb18-13"><a href="sagemath-cookbook.html#cb18-13" tabindex="-1"></a></span>
<span id="cb18-14"><a href="sagemath-cookbook.html#cb18-14" tabindex="-1"></a><span class="co"># OR</span></span>
<span id="cb18-15"><a href="sagemath-cookbook.html#cb18-15" tabindex="-1"></a>log_or <span class="op">=</span> a <span class="op">|</span> b </span>
<span id="cb18-16"><a href="sagemath-cookbook.html#cb18-16" tabindex="-1"></a><span class="cf">assert</span> log_or <span class="op">==</span> <span class="bn">0b1111</span></span>
<span id="cb18-17"><a href="sagemath-cookbook.html#cb18-17" tabindex="-1"></a></span>
<span id="cb18-18"><a href="sagemath-cookbook.html#cb18-18" tabindex="-1"></a><span class="co"># XOR</span></span>
<span id="cb18-19"><a href="sagemath-cookbook.html#cb18-19" tabindex="-1"></a><span class="co"># SageMath uses &quot;^^&quot; for xor since &quot;^&quot; is used for exponentiation</span></span>
<span id="cb18-20"><a href="sagemath-cookbook.html#cb18-20" tabindex="-1"></a>log_xor <span class="op">=</span> a <span class="op">^^</span> b </span>
<span id="cb18-21"><a href="sagemath-cookbook.html#cb18-21" tabindex="-1"></a><span class="cf">assert</span> log_xor <span class="op">==</span> <span class="bn">0b0111</span></span>
<span id="cb18-22"><a href="sagemath-cookbook.html#cb18-22" tabindex="-1"></a></span>
<span id="cb18-23"><a href="sagemath-cookbook.html#cb18-23" tabindex="-1"></a><span class="co"># left and right shift</span></span>
<span id="cb18-24"><a href="sagemath-cookbook.html#cb18-24" tabindex="-1"></a>lshift <span class="op">=</span> a <span class="op">&lt;&lt;</span> <span class="dv">2</span></span>
<span id="cb18-25"><a href="sagemath-cookbook.html#cb18-25" tabindex="-1"></a><span class="cf">assert</span> lshift <span class="op">==</span> <span class="bn">0b101100</span></span>
<span id="cb18-26"><a href="sagemath-cookbook.html#cb18-26" tabindex="-1"></a></span>
<span id="cb18-27"><a href="sagemath-cookbook.html#cb18-27" tabindex="-1"></a>rshift <span class="op">=</span> a <span class="op">&gt;&gt;</span> <span class="dv">2</span></span>
<span id="cb18-28"><a href="sagemath-cookbook.html#cb18-28" tabindex="-1"></a><span class="cf">assert</span> rshift <span class="op">==</span> <span class="bn">0b10</span></span></code></pre></div>
</div>
<div id="encodedecode-ascii" class="section level3 unnumbered hasAnchor">
<h3>Encode/Decode ASCII<a href="sagemath-cookbook.html#encodedecode-ascii" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to encode/decode to ASCII. You can find an ASCII table <a href="https://www.asciitable.com/">here</a>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="sagemath-cookbook.html#cb19-1" tabindex="-1"></a><span class="im">from</span> sage.crypto.util <span class="im">import</span> bin_to_ascii, ascii_to_bin</span>
<span id="cb19-2"><a href="sagemath-cookbook.html#cb19-2" tabindex="-1"></a></span>
<span id="cb19-3"><a href="sagemath-cookbook.html#cb19-3" tabindex="-1"></a>msg <span class="op">=</span> <span class="st">&quot;I need to be encoded&quot;</span></span>
<span id="cb19-4"><a href="sagemath-cookbook.html#cb19-4" tabindex="-1"></a></span>
<span id="cb19-5"><a href="sagemath-cookbook.html#cb19-5" tabindex="-1"></a>ascii_bits <span class="op">=</span> ascii_to_bin(msg) </span>
<span id="cb19-6"><a href="sagemath-cookbook.html#cb19-6" tabindex="-1"></a>msg_prime <span class="op">=</span> bin_to_ascii(ascii_bits)</span>
<span id="cb19-7"><a href="sagemath-cookbook.html#cb19-7" tabindex="-1"></a></span>
<span id="cb19-8"><a href="sagemath-cookbook.html#cb19-8" tabindex="-1"></a><span class="cf">assert</span> msg <span class="op">==</span> msg_prime</span></code></pre></div>
</div>
<div id="sampling-random-bitstring" class="section level3 unnumbered hasAnchor">
<h3>Sampling Random Bitstring<a href="sagemath-cookbook.html#sampling-random-bitstring" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to sample random bitstrings. There are many ways to do this actually. We use a more functional
style when possible to keep the code cleaner.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="sagemath-cookbook.html#cb20-1" tabindex="-1"></a><span class="im">import</span> random </span>
<span id="cb20-2"><a href="sagemath-cookbook.html#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="sagemath-cookbook.html#cb20-3" tabindex="-1"></a>length <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb20-4"><a href="sagemath-cookbook.html#cb20-4" tabindex="-1"></a><span class="kw">def</span> rand_bitstring(n): </span>
<span id="cb20-5"><a href="sagemath-cookbook.html#cb20-5" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb20-6"><a href="sagemath-cookbook.html#cb20-6" tabindex="-1"></a><span class="co">  Samples n random bits and represents them as str. </span></span>
<span id="cb20-7"><a href="sagemath-cookbook.html#cb20-7" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb20-8"><a href="sagemath-cookbook.html#cb20-8" tabindex="-1"></a></span>
<span id="cb20-9"><a href="sagemath-cookbook.html#cb20-9" tabindex="-1"></a>  <span class="co"># loop length times and in each loop sample a 0/1 value.</span></span>
<span id="cb20-10"><a href="sagemath-cookbook.html#cb20-10" tabindex="-1"></a>  <span class="co"># Then join the sampled values </span></span>
<span id="cb20-11"><a href="sagemath-cookbook.html#cb20-11" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">&#39;&#39;</span>.join(<span class="bu">str</span>(random.choice([<span class="dv">0</span>, <span class="dv">1</span>])) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n))</span></code></pre></div>
</div>
<div id="sampling-random-bytes" class="section level3 unnumbered hasAnchor">
<h3>Sampling Random Bytes<a href="sagemath-cookbook.html#sampling-random-bytes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Same thing, but this time with bytes.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="sagemath-cookbook.html#cb21-1" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb21-2"><a href="sagemath-cookbook.html#cb21-2" tabindex="-1"></a></span>
<span id="cb21-3"><a href="sagemath-cookbook.html#cb21-3" tabindex="-1"></a><span class="kw">def</span> rand_bytes(n): </span>
<span id="cb21-4"><a href="sagemath-cookbook.html#cb21-4" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-5"><a href="sagemath-cookbook.html#cb21-5" tabindex="-1"></a><span class="co">  Samples n random byte. </span></span>
<span id="cb21-6"><a href="sagemath-cookbook.html#cb21-6" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb21-7"><a href="sagemath-cookbook.html#cb21-7" tabindex="-1"></a></span>
<span id="cb21-8"><a href="sagemath-cookbook.html#cb21-8" tabindex="-1"></a>  <span class="co"># loop length times and in each loop sample a [0..256) value.</span></span>
<span id="cb21-9"><a href="sagemath-cookbook.html#cb21-9" tabindex="-1"></a>  <span class="co"># Then join the sampled values </span></span>
<span id="cb21-10"><a href="sagemath-cookbook.html#cb21-10" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">b&#39;&#39;</span>.join(randrange(<span class="dv">0</span>,<span class="dv">256</span>).to_bytes() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n))</span></code></pre></div>
</div>
<div id="xoring-bytes" class="section level3 unnumbered hasAnchor">
<h3>Xoring bytes<a href="sagemath-cookbook.html#xoring-bytes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the next recipe we show how we can XOR two byte strings. Recall that for binary numbers, one can directly
use the operator <code>^^</code> (but be carefull to first convert to numbers if needed!).</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="sagemath-cookbook.html#cb22-1" tabindex="-1"></a><span class="kw">def</span> xor_bytes(lbytes, rbytes):</span>
<span id="cb22-2"><a href="sagemath-cookbook.html#cb22-2" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb22-3"><a href="sagemath-cookbook.html#cb22-3" tabindex="-1"></a><span class="co">  XORs two sets of bytes. It assumes they have the same length.</span></span>
<span id="cb22-4"><a href="sagemath-cookbook.html#cb22-4" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb22-5"><a href="sagemath-cookbook.html#cb22-5" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(lbytes) <span class="op">!=</span> <span class="bu">len</span>(rbytes):</span>
<span id="cb22-6"><a href="sagemath-cookbook.html#cb22-6" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;Bytes must have equal length&quot;</span>)</span>
<span id="cb22-7"><a href="sagemath-cookbook.html#cb22-7" tabindex="-1"></a></span>
<span id="cb22-8"><a href="sagemath-cookbook.html#cb22-8" tabindex="-1"></a>  <span class="co"># Apply the XOR (^^) operator for each pair of bytes</span></span>
<span id="cb22-9"><a href="sagemath-cookbook.html#cb22-9" tabindex="-1"></a>  <span class="co"># and collect the result in bytes</span></span>
<span id="cb22-10"><a href="sagemath-cookbook.html#cb22-10" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">bytes</span>(x <span class="op">^^</span> y <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(lbytes, rbytes))</span></code></pre></div>
</div>
</div>
<div id="symmetric-key-cryptography" class="section level2 hasAnchor" number="17.3">
<h2><span class="header-section-number">E.3</span> Symmetric Key Cryptography<a href="sagemath-cookbook.html#symmetric-key-cryptography" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we present various recipes that are related to symmetric key cryptography.</p>
<div id="one-time-pad-1" class="section level3 unnumbered hasAnchor">
<h3>One-Time-Pad<a href="sagemath-cookbook.html#one-time-pad-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to implement OTP in sage. As you can see, it is quite easy! The only difficulty is
handling the types (ascii encodings, bytes etc). Depending on semantics, you might want to modify the following code snippet,
for example you might want to directly apply one-time-pad on binary numbers.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="sagemath-cookbook.html#cb23-1" tabindex="-1"></a><span class="im">import</span> random </span>
<span id="cb23-2"><a href="sagemath-cookbook.html#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="sagemath-cookbook.html#cb23-3" tabindex="-1"></a><span class="co"># For ascii encoding/decoding</span></span>
<span id="cb23-4"><a href="sagemath-cookbook.html#cb23-4" tabindex="-1"></a><span class="im">from</span> sage.crypto.util <span class="im">import</span> bin_to_ascii, ascii_to_bin</span>
<span id="cb23-5"><a href="sagemath-cookbook.html#cb23-5" tabindex="-1"></a></span>
<span id="cb23-6"><a href="sagemath-cookbook.html#cb23-6" tabindex="-1"></a><span class="kw">def</span> xor(a, b): </span>
<span id="cb23-7"><a href="sagemath-cookbook.html#cb23-7" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb23-8"><a href="sagemath-cookbook.html#cb23-8" tabindex="-1"></a><span class="co">  Helper function to apply the xor function to two strings representing binary numbers. </span></span>
<span id="cb23-9"><a href="sagemath-cookbook.html#cb23-9" tabindex="-1"></a><span class="co">  It returns an str with the result.</span></span>
<span id="cb23-10"><a href="sagemath-cookbook.html#cb23-10" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb23-11"><a href="sagemath-cookbook.html#cb23-11" tabindex="-1"></a></span>
<span id="cb23-12"><a href="sagemath-cookbook.html#cb23-12" tabindex="-1"></a>  <span class="co"># apply the function xor (^^) elementwise to a and b and collects the result</span></span>
<span id="cb23-13"><a href="sagemath-cookbook.html#cb23-13" tabindex="-1"></a>  <span class="co"># we need first to convert the elements to ints to apply the ^^ function</span></span>
<span id="cb23-14"><a href="sagemath-cookbook.html#cb23-14" tabindex="-1"></a>  <span class="co"># note that the bigger list is trimmed by the list map</span></span>
<span id="cb23-15"><a href="sagemath-cookbook.html#cb23-15" tabindex="-1"></a>  c <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> a_i, b_i: <span class="bu">str</span>(<span class="bu">int</span>(a_i) <span class="op">^^</span> <span class="bu">int</span>(b_i)), a, b))</span>
<span id="cb23-16"><a href="sagemath-cookbook.html#cb23-16" tabindex="-1"></a></span>
<span id="cb23-17"><a href="sagemath-cookbook.html#cb23-17" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">&quot;&quot;</span>.join(c)</span>
<span id="cb23-18"><a href="sagemath-cookbook.html#cb23-18" tabindex="-1"></a></span>
<span id="cb23-19"><a href="sagemath-cookbook.html#cb23-19" tabindex="-1"></a></span>
<span id="cb23-20"><a href="sagemath-cookbook.html#cb23-20" tabindex="-1"></a><span class="kw">def</span> otp_keygen(length):</span>
<span id="cb23-21"><a href="sagemath-cookbook.html#cb23-21" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb23-22"><a href="sagemath-cookbook.html#cb23-22" tabindex="-1"></a><span class="co">  Sample an OTP key. This is a random bitstring of length &quot;length&quot; </span></span>
<span id="cb23-23"><a href="sagemath-cookbook.html#cb23-23" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb23-24"><a href="sagemath-cookbook.html#cb23-24" tabindex="-1"></a></span>
<span id="cb23-25"><a href="sagemath-cookbook.html#cb23-25" tabindex="-1"></a>  <span class="co"># loop length times and in each loop sample a 0,1 value.</span></span>
<span id="cb23-26"><a href="sagemath-cookbook.html#cb23-26" tabindex="-1"></a>  <span class="co"># Then join the sampled values </span></span>
<span id="cb23-27"><a href="sagemath-cookbook.html#cb23-27" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">&#39;&#39;</span>.join(<span class="bu">str</span>(random.choice([<span class="dv">0</span>, <span class="dv">1</span>])) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(length))</span>
<span id="cb23-28"><a href="sagemath-cookbook.html#cb23-28" tabindex="-1"></a></span>
<span id="cb23-29"><a href="sagemath-cookbook.html#cb23-29" tabindex="-1"></a></span>
<span id="cb23-30"><a href="sagemath-cookbook.html#cb23-30" tabindex="-1"></a><span class="kw">def</span> otp_encrypt(key, message):</span>
<span id="cb23-31"><a href="sagemath-cookbook.html#cb23-31" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb23-32"><a href="sagemath-cookbook.html#cb23-32" tabindex="-1"></a><span class="co">  One time pad encryption. The key is an str representing binary values </span></span>
<span id="cb23-33"><a href="sagemath-cookbook.html#cb23-33" tabindex="-1"></a><span class="co">  and the message an str. The outputted ciphertext is an ASCII encoded str.</span></span>
<span id="cb23-34"><a href="sagemath-cookbook.html#cb23-34" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb23-35"><a href="sagemath-cookbook.html#cb23-35" tabindex="-1"></a></span>
<span id="cb23-36"><a href="sagemath-cookbook.html#cb23-36" tabindex="-1"></a>  <span class="co"># Get the ascii bits of the message</span></span>
<span id="cb23-37"><a href="sagemath-cookbook.html#cb23-37" tabindex="-1"></a>  message_bits <span class="op">=</span> <span class="bu">str</span>(ascii_to_bin(message))</span>
<span id="cb23-38"><a href="sagemath-cookbook.html#cb23-38" tabindex="-1"></a></span>
<span id="cb23-39"><a href="sagemath-cookbook.html#cb23-39" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(key) <span class="op">&lt;</span> <span class="bu">len</span>(message_bits):</span>
<span id="cb23-40"><a href="sagemath-cookbook.html#cb23-40" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;OTP Key is too small for the message&quot;</span>, message)</span>
<span id="cb23-41"><a href="sagemath-cookbook.html#cb23-41" tabindex="-1"></a>    <span class="cf">return</span></span>
<span id="cb23-42"><a href="sagemath-cookbook.html#cb23-42" tabindex="-1"></a></span>
<span id="cb23-43"><a href="sagemath-cookbook.html#cb23-43" tabindex="-1"></a>  <span class="co"># apply the bitwise xor function</span></span>
<span id="cb23-44"><a href="sagemath-cookbook.html#cb23-44" tabindex="-1"></a>  ciphertext <span class="op">=</span> xor(message_bits, key)</span>
<span id="cb23-45"><a href="sagemath-cookbook.html#cb23-45" tabindex="-1"></a></span>
<span id="cb23-46"><a href="sagemath-cookbook.html#cb23-46" tabindex="-1"></a>  <span class="co"># We decode the ciphertext so that the types of m, c are the same. </span></span>
<span id="cb23-47"><a href="sagemath-cookbook.html#cb23-47" tabindex="-1"></a>  <span class="co">#This way we can implement decryption by simply calling encrypt(key, ciphertext)</span></span>
<span id="cb23-48"><a href="sagemath-cookbook.html#cb23-48" tabindex="-1"></a>  <span class="cf">return</span> bin_to_ascii(<span class="st">&quot;&quot;</span>.join(ciphertext))</span>
<span id="cb23-49"><a href="sagemath-cookbook.html#cb23-49" tabindex="-1"></a></span>
<span id="cb23-50"><a href="sagemath-cookbook.html#cb23-50" tabindex="-1"></a><span class="kw">def</span> otp_decrypt(key, ciphertext):</span>
<span id="cb23-51"><a href="sagemath-cookbook.html#cb23-51" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb23-52"><a href="sagemath-cookbook.html#cb23-52" tabindex="-1"></a><span class="co">  One time pad decryption. This simply calls encrypt on the same arguments.</span></span>
<span id="cb23-53"><a href="sagemath-cookbook.html#cb23-53" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb23-54"><a href="sagemath-cookbook.html#cb23-54" tabindex="-1"></a>  <span class="cf">return</span> otp_encrypt(key, ciphertext)</span></code></pre></div>
<p>Here is how one could use the above otp implementation.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="sagemath-cookbook.html#cb24-1" tabindex="-1"></a><span class="co"># We use the otp.sage recipe</span></span>
<span id="cb24-2"><a href="sagemath-cookbook.html#cb24-2" tabindex="-1"></a>load(<span class="st">&#39;otp.sage&#39;</span>)</span>
<span id="cb24-3"><a href="sagemath-cookbook.html#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="sagemath-cookbook.html#cb24-4" tabindex="-1"></a><span class="co"># sample a long OTP key</span></span>
<span id="cb24-5"><a href="sagemath-cookbook.html#cb24-5" tabindex="-1"></a>k <span class="op">=</span> otp_keygen(<span class="dv">32768</span>)</span>
<span id="cb24-6"><a href="sagemath-cookbook.html#cb24-6" tabindex="-1"></a></span>
<span id="cb24-7"><a href="sagemath-cookbook.html#cb24-7" tabindex="-1"></a>m <span class="op">=</span> <span class="st">&quot;I need to be encrypted with perfect secrecy!&quot;</span> </span>
<span id="cb24-8"><a href="sagemath-cookbook.html#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="sagemath-cookbook.html#cb24-9" tabindex="-1"></a><span class="co"># encrypt</span></span>
<span id="cb24-10"><a href="sagemath-cookbook.html#cb24-10" tabindex="-1"></a>c <span class="op">=</span> otp_encrypt(k, m)</span>
<span id="cb24-11"><a href="sagemath-cookbook.html#cb24-11" tabindex="-1"></a></span>
<span id="cb24-12"><a href="sagemath-cookbook.html#cb24-12" tabindex="-1"></a><span class="co"># decrypt</span></span>
<span id="cb24-13"><a href="sagemath-cookbook.html#cb24-13" tabindex="-1"></a>m_prime <span class="op">=</span> otp_decrypt(k, c)</span>
<span id="cb24-14"><a href="sagemath-cookbook.html#cb24-14" tabindex="-1"></a></span>
<span id="cb24-15"><a href="sagemath-cookbook.html#cb24-15" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
<div id="prng-sha256" class="section level3 unnumbered hasAnchor">
<h3>PRNG: SHA256<a href="sagemath-cookbook.html#prng-sha256" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to construct a PRNG. There are various ways to do this. A simple one, that is presented here,
consists of taking a seed s and compute <code>H(s||1)||H(s||2)||...||H(s||k)</code> where <span class="math inline">\(H\)</span> is a cryptographic hash function. You choose an
appropriate <code>k</code> to define the desired PRNG output length. For the hash function, we use the <a href="https://en.wikipedia.org/wiki/SHA-2">SHA256</a>
hash function. The implementation is taken from the <code>hashlib</code> library. You can use a hash function of your choice instead, just make sure
it is <em>cryptographically secure</em>!</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="sagemath-cookbook.html#cb25-1" tabindex="-1"></a><span class="im">from</span> hashlib <span class="im">import</span> sha256</span>
<span id="cb25-2"><a href="sagemath-cookbook.html#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="sagemath-cookbook.html#cb25-3" tabindex="-1"></a><span class="kw">def</span> sample_seed(n):</span>
<span id="cb25-4"><a href="sagemath-cookbook.html#cb25-4" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb25-5"><a href="sagemath-cookbook.html#cb25-5" tabindex="-1"></a><span class="co">  Samples a random seed. The length represents the number of bytes of the seed.</span></span>
<span id="cb25-6"><a href="sagemath-cookbook.html#cb25-6" tabindex="-1"></a><span class="co">  The output is given in bytes.</span></span>
<span id="cb25-7"><a href="sagemath-cookbook.html#cb25-7" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb25-8"><a href="sagemath-cookbook.html#cb25-8" tabindex="-1"></a>  </span>
<span id="cb25-9"><a href="sagemath-cookbook.html#cb25-9" tabindex="-1"></a>  <span class="co"># sample n random bytes</span></span>
<span id="cb25-10"><a href="sagemath-cookbook.html#cb25-10" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">b&#39;&#39;</span>.join(randrange(<span class="dv">0</span>,<span class="dv">256</span>).to_bytes() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n))</span>
<span id="cb25-11"><a href="sagemath-cookbook.html#cb25-11" tabindex="-1"></a></span>
<span id="cb25-12"><a href="sagemath-cookbook.html#cb25-12" tabindex="-1"></a><span class="kw">def</span> sha256_prg(seed, length):</span>
<span id="cb25-13"><a href="sagemath-cookbook.html#cb25-13" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb25-14"><a href="sagemath-cookbook.html#cb25-14" tabindex="-1"></a><span class="co">    Uses hash function sha256 to construct a PRNG. </span></span>
<span id="cb25-15"><a href="sagemath-cookbook.html#cb25-15" tabindex="-1"></a><span class="co">    sha256 maps bytes of arbitrary lengths to a fixed 256 bit (=32 byte) output. </span></span>
<span id="cb25-16"><a href="sagemath-cookbook.html#cb25-16" tabindex="-1"></a><span class="co">    To construct a PRNG using a seed s compute:</span></span>
<span id="cb25-17"><a href="sagemath-cookbook.html#cb25-17" tabindex="-1"></a><span class="co">      sha256(seed||0), sha256(seed||1), ..., sha256(seed||k) </span></span>
<span id="cb25-18"><a href="sagemath-cookbook.html#cb25-18" tabindex="-1"></a><span class="co">    until the length is greater than or equal to length. </span></span>
<span id="cb25-19"><a href="sagemath-cookbook.html#cb25-19" tabindex="-1"></a><span class="co">    Then truncate any remaining bytes to get the desired output.</span></span>
<span id="cb25-20"><a href="sagemath-cookbook.html#cb25-20" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb25-21"><a href="sagemath-cookbook.html#cb25-21" tabindex="-1"></a></span>
<span id="cb25-22"><a href="sagemath-cookbook.html#cb25-22" tabindex="-1"></a>    <span class="co"># Initialize output as an empty byte string</span></span>
<span id="cb25-23"><a href="sagemath-cookbook.html#cb25-23" tabindex="-1"></a>    output <span class="op">=</span> <span class="st">b&#39;&#39;</span></span>
<span id="cb25-24"><a href="sagemath-cookbook.html#cb25-24" tabindex="-1"></a></span>
<span id="cb25-25"><a href="sagemath-cookbook.html#cb25-25" tabindex="-1"></a>    <span class="co"># The counter concatenated to seed in each iteration</span></span>
<span id="cb25-26"><a href="sagemath-cookbook.html#cb25-26" tabindex="-1"></a>    counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb25-27"><a href="sagemath-cookbook.html#cb25-27" tabindex="-1"></a></span>
<span id="cb25-28"><a href="sagemath-cookbook.html#cb25-28" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">len</span>(output) <span class="op">&lt;</span> length:</span>
<span id="cb25-29"><a href="sagemath-cookbook.html#cb25-29" tabindex="-1"></a>        <span class="co"># prepare the input seed || counter </span></span>
<span id="cb25-30"><a href="sagemath-cookbook.html#cb25-30" tabindex="-1"></a>        hash_input <span class="op">=</span> seed <span class="op">+</span> counter.to_bytes()</span>
<span id="cb25-31"><a href="sagemath-cookbook.html#cb25-31" tabindex="-1"></a></span>
<span id="cb25-32"><a href="sagemath-cookbook.html#cb25-32" tabindex="-1"></a>        <span class="co"># hash (seed || counter) using sha256</span></span>
<span id="cb25-33"><a href="sagemath-cookbook.html#cb25-33" tabindex="-1"></a>        hash_output <span class="op">=</span> sha256(hash_input).digest()</span>
<span id="cb25-34"><a href="sagemath-cookbook.html#cb25-34" tabindex="-1"></a></span>
<span id="cb25-35"><a href="sagemath-cookbook.html#cb25-35" tabindex="-1"></a>        <span class="co"># add to output and prepare counter for next round</span></span>
<span id="cb25-36"><a href="sagemath-cookbook.html#cb25-36" tabindex="-1"></a>        output <span class="op">+=</span> hash_output</span>
<span id="cb25-37"><a href="sagemath-cookbook.html#cb25-37" tabindex="-1"></a>        counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb25-38"><a href="sagemath-cookbook.html#cb25-38" tabindex="-1"></a>    </span>
<span id="cb25-39"><a href="sagemath-cookbook.html#cb25-39" tabindex="-1"></a>    <span class="cf">return</span> output[:length]</span></code></pre></div>
<p>Here how you can actually use the above code.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="sagemath-cookbook.html#cb26-1" tabindex="-1"></a><span class="co"># We use the sha256_prng.sage recipe</span></span>
<span id="cb26-2"><a href="sagemath-cookbook.html#cb26-2" tabindex="-1"></a>load(<span class="st">&#39;sha256_prng.sage&#39;</span>)</span>
<span id="cb26-3"><a href="sagemath-cookbook.html#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="sagemath-cookbook.html#cb26-4" tabindex="-1"></a><span class="co"># sample a 256bit (=32 byte) length seed </span></span>
<span id="cb26-5"><a href="sagemath-cookbook.html#cb26-5" tabindex="-1"></a>seed <span class="op">=</span> sample_seed(<span class="dv">32</span>)</span>
<span id="cb26-6"><a href="sagemath-cookbook.html#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="sagemath-cookbook.html#cb26-7" tabindex="-1"></a><span class="co"># output a 8192bit (1024 bytes) pseudorandom byte stream</span></span>
<span id="cb26-8"><a href="sagemath-cookbook.html#cb26-8" tabindex="-1"></a>output <span class="op">=</span>  sha256_prg(seed, <span class="dv">1024</span>)</span></code></pre></div>
</div>
<div id="block-ciphers-aes128" class="section level3 unnumbered hasAnchor">
<h3>Block Ciphers: AES128<a href="sagemath-cookbook.html#block-ciphers-aes128" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the next recipe, we show how to use <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES128</a> block cipher via the
<code>Crypto.Cipher</code> implementation.</p>
<p>As we have discussed, <em>you should <strong>NEVER</strong> use block ciphers in ECB mode!</em> In the following implementation we seem to be using AES with
ECB mode but this is not the case. We simply do that to get access to the “pure” (i.e. no mode of operation) AES block cipher. Whenever we use
it, we always encrypt a single block (equivalent to running AES).</p>
<p>The reason for doing it this way, is because the libraries that implement block ciphers also implement modes of operations and the interface
requires to choose which mode we want to use. On our usecase, we want to demonstrate later how to implement modes of operations ourselves and utilizing the existing library this way is the easiest way to do this. Alternatively, we could re-implement AES, but this is a fairly complex construction on its own.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="sagemath-cookbook.html#cb27-1" tabindex="-1"></a><span class="co"># We use the Crypto implementation of AES</span></span>
<span id="cb27-2"><a href="sagemath-cookbook.html#cb27-2" tabindex="-1"></a><span class="im">from</span> Crypto.Cipher <span class="im">import</span> AES</span>
<span id="cb27-3"><a href="sagemath-cookbook.html#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="sagemath-cookbook.html#cb27-4" tabindex="-1"></a><span class="co"># We use the random_bytes.sage and xor_bytes recipes</span></span>
<span id="cb27-5"><a href="sagemath-cookbook.html#cb27-5" tabindex="-1"></a>load(<span class="st">&#39;random_bytes.sage&#39;</span>)</span>
<span id="cb27-6"><a href="sagemath-cookbook.html#cb27-6" tabindex="-1"></a>load(<span class="st">&#39;xor_bytes.sage&#39;</span>)</span>
<span id="cb27-7"><a href="sagemath-cookbook.html#cb27-7" tabindex="-1"></a></span>
<span id="cb27-8"><a href="sagemath-cookbook.html#cb27-8" tabindex="-1"></a><span class="kw">def</span> aes_keygen():</span>
<span id="cb27-9"><a href="sagemath-cookbook.html#cb27-9" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb27-10"><a href="sagemath-cookbook.html#cb27-10" tabindex="-1"></a><span class="co">  Samples random 16 bytes (=128 bits) for an AES128 key</span></span>
<span id="cb27-11"><a href="sagemath-cookbook.html#cb27-11" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb27-12"><a href="sagemath-cookbook.html#cb27-12" tabindex="-1"></a>  <span class="cf">return</span> rand_bytes(<span class="dv">16</span>)</span>
<span id="cb27-13"><a href="sagemath-cookbook.html#cb27-13" tabindex="-1"></a></span>
<span id="cb27-14"><a href="sagemath-cookbook.html#cb27-14" tabindex="-1"></a><span class="kw">def</span> aes_enc(key, message_block):</span>
<span id="cb27-15"><a href="sagemath-cookbook.html#cb27-15" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb27-16"><a href="sagemath-cookbook.html#cb27-16" tabindex="-1"></a><span class="co">  Runs the AES128 encryption on message_block with the specified key.</span></span>
<span id="cb27-17"><a href="sagemath-cookbook.html#cb27-17" tabindex="-1"></a><span class="co">  The length of message_block must be 16.</span></span>
<span id="cb27-18"><a href="sagemath-cookbook.html#cb27-18" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb27-19"><a href="sagemath-cookbook.html#cb27-19" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(message_block) <span class="op">!=</span> <span class="dv">16</span>: </span>
<span id="cb27-20"><a href="sagemath-cookbook.html#cb27-20" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;AES message must be exactly 16 bytes!&quot;</span>)</span>
<span id="cb27-21"><a href="sagemath-cookbook.html#cb27-21" tabindex="-1"></a></span>
<span id="cb27-22"><a href="sagemath-cookbook.html#cb27-22" tabindex="-1"></a>  <span class="co"># </span><span class="al">CAUTION</span><span class="co">: We do not actually use ECB mode! The cipher object needs a mode in order </span></span>
<span id="cb27-23"><a href="sagemath-cookbook.html#cb27-23" tabindex="-1"></a>  <span class="co"># to be initialized and since we want the &quot;pure&quot; permutation we initialize with ECB Mode </span></span>
<span id="cb27-24"><a href="sagemath-cookbook.html#cb27-24" tabindex="-1"></a>  <span class="co"># and always use it to encrypt blocks of size exactly 16. This is equivalent to running </span></span>
<span id="cb27-25"><a href="sagemath-cookbook.html#cb27-25" tabindex="-1"></a>  <span class="co"># the AES128 block cipher</span></span>
<span id="cb27-26"><a href="sagemath-cookbook.html#cb27-26" tabindex="-1"></a>  cipher <span class="op">=</span> AES.new(key, AES.MODE_ECB)</span>
<span id="cb27-27"><a href="sagemath-cookbook.html#cb27-27" tabindex="-1"></a>  <span class="cf">return</span> cipher.encrypt(message_block)</span>
<span id="cb27-28"><a href="sagemath-cookbook.html#cb27-28" tabindex="-1"></a></span>
<span id="cb27-29"><a href="sagemath-cookbook.html#cb27-29" tabindex="-1"></a><span class="kw">def</span> aes_dec(key, ciphertext_block):</span>
<span id="cb27-30"><a href="sagemath-cookbook.html#cb27-30" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(ciphertext_block) <span class="op">!=</span> <span class="dv">16</span>: </span>
<span id="cb27-31"><a href="sagemath-cookbook.html#cb27-31" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;AES message must be exactly 16 bytes!&quot;</span>)</span>
<span id="cb27-32"><a href="sagemath-cookbook.html#cb27-32" tabindex="-1"></a></span>
<span id="cb27-33"><a href="sagemath-cookbook.html#cb27-33" tabindex="-1"></a>  <span class="co"># </span><span class="al">CAUTION</span><span class="co">: We do not actually use ECB mode! The cipher object needs a mode in order </span></span>
<span id="cb27-34"><a href="sagemath-cookbook.html#cb27-34" tabindex="-1"></a>  <span class="co"># to be initialized and since we want the &quot;pure&quot; permutation we initialize with ECB Mode </span></span>
<span id="cb27-35"><a href="sagemath-cookbook.html#cb27-35" tabindex="-1"></a>  <span class="co"># and always use it to encrypt blocks of size exactly 16. This is equivalent to running </span></span>
<span id="cb27-36"><a href="sagemath-cookbook.html#cb27-36" tabindex="-1"></a>  <span class="co"># the AES128 block cipher</span></span>
<span id="cb27-37"><a href="sagemath-cookbook.html#cb27-37" tabindex="-1"></a>  cipher <span class="op">=</span> AES.new(key, AES.MODE_ECB)</span>
<span id="cb27-38"><a href="sagemath-cookbook.html#cb27-38" tabindex="-1"></a>  <span class="cf">return</span> cipher.decrypt(ciphertext_block)</span></code></pre></div>
<p>Note in the above how we make sure that we always encrypt one block (32 bytes). Next we show how to use
the above code.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="sagemath-cookbook.html#cb28-1" tabindex="-1"></a><span class="co"># We use the aes128.sage recipe</span></span>
<span id="cb28-2"><a href="sagemath-cookbook.html#cb28-2" tabindex="-1"></a>load(<span class="st">&#39;aes128.sage&#39;</span>)</span>
<span id="cb28-3"><a href="sagemath-cookbook.html#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="sagemath-cookbook.html#cb28-4" tabindex="-1"></a><span class="co"># sample an aes128 key</span></span>
<span id="cb28-5"><a href="sagemath-cookbook.html#cb28-5" tabindex="-1"></a>k <span class="op">=</span> aes_keygen()</span>
<span id="cb28-6"><a href="sagemath-cookbook.html#cb28-6" tabindex="-1"></a></span>
<span id="cb28-7"><a href="sagemath-cookbook.html#cb28-7" tabindex="-1"></a><span class="co"># choose a random 16-byte long message to encrypt</span></span>
<span id="cb28-8"><a href="sagemath-cookbook.html#cb28-8" tabindex="-1"></a>m <span class="op">=</span> rand_bytes(<span class="dv">16</span>)</span>
<span id="cb28-9"><a href="sagemath-cookbook.html#cb28-9" tabindex="-1"></a></span>
<span id="cb28-10"><a href="sagemath-cookbook.html#cb28-10" tabindex="-1"></a><span class="co"># encrypt</span></span>
<span id="cb28-11"><a href="sagemath-cookbook.html#cb28-11" tabindex="-1"></a>c <span class="op">=</span> aes_enc(k, m)</span>
<span id="cb28-12"><a href="sagemath-cookbook.html#cb28-12" tabindex="-1"></a></span>
<span id="cb28-13"><a href="sagemath-cookbook.html#cb28-13" tabindex="-1"></a><span class="co"># decrypt</span></span>
<span id="cb28-14"><a href="sagemath-cookbook.html#cb28-14" tabindex="-1"></a>m_prime <span class="op">=</span> aes_dec(k, c)</span>
<span id="cb28-15"><a href="sagemath-cookbook.html#cb28-15" tabindex="-1"></a></span>
<span id="cb28-16"><a href="sagemath-cookbook.html#cb28-16" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
<div id="modes-of-operation-aes128-cbc" class="section level3 unnumbered hasAnchor">
<h3>Modes of Operation: AES128-CBC<a href="sagemath-cookbook.html#modes-of-operation-aes128-cbc" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next we show how to use AES128 in CBC mode. Note that we do not handle padding for the sake of simplicity. We make sure that
we always encrypt a multiple of block size bytes (32 in this case).</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="sagemath-cookbook.html#cb29-1" tabindex="-1"></a><span class="co"># We use the aes128.sage recipe</span></span>
<span id="cb29-2"><a href="sagemath-cookbook.html#cb29-2" tabindex="-1"></a>load(<span class="st">&#39;aes128.sage&#39;</span>)</span>
<span id="cb29-3"><a href="sagemath-cookbook.html#cb29-3" tabindex="-1"></a></span>
<span id="cb29-4"><a href="sagemath-cookbook.html#cb29-4" tabindex="-1"></a><span class="kw">def</span> aes_cbc_enc(key, message):</span>
<span id="cb29-5"><a href="sagemath-cookbook.html#cb29-5" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb29-6"><a href="sagemath-cookbook.html#cb29-6" tabindex="-1"></a><span class="co">  Runs the AES128 encryption on a message using CBC mode with the specified key.</span></span>
<span id="cb29-7"><a href="sagemath-cookbook.html#cb29-7" tabindex="-1"></a><span class="co">  The length of message must be a multiple of 16.</span></span>
<span id="cb29-8"><a href="sagemath-cookbook.html#cb29-8" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb29-9"><a href="sagemath-cookbook.html#cb29-9" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(message) <span class="op">%</span> <span class="dv">16</span> <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb29-10"><a href="sagemath-cookbook.html#cb29-10" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;Message length must be a multiple of 16&quot;</span>)</span>
<span id="cb29-11"><a href="sagemath-cookbook.html#cb29-11" tabindex="-1"></a></span>
<span id="cb29-12"><a href="sagemath-cookbook.html#cb29-12" tabindex="-1"></a>  block_size <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb29-13"><a href="sagemath-cookbook.html#cb29-13" tabindex="-1"></a></span>
<span id="cb29-14"><a href="sagemath-cookbook.html#cb29-14" tabindex="-1"></a>  <span class="co"># Sample a random IV</span></span>
<span id="cb29-15"><a href="sagemath-cookbook.html#cb29-15" tabindex="-1"></a>  iv <span class="op">=</span> rand_bytes(block_size) </span>
<span id="cb29-16"><a href="sagemath-cookbook.html#cb29-16" tabindex="-1"></a></span>
<span id="cb29-17"><a href="sagemath-cookbook.html#cb29-17" tabindex="-1"></a>  n_blocks <span class="op">=</span> <span class="bu">len</span>(message) <span class="op">/</span> block_size</span>
<span id="cb29-18"><a href="sagemath-cookbook.html#cb29-18" tabindex="-1"></a></span>
<span id="cb29-19"><a href="sagemath-cookbook.html#cb29-19" tabindex="-1"></a>  <span class="co"># Initialize ciphertext with the iv (corresponding to c_0)</span></span>
<span id="cb29-20"><a href="sagemath-cookbook.html#cb29-20" tabindex="-1"></a>  ciphertext <span class="op">=</span> iv </span>
<span id="cb29-21"><a href="sagemath-cookbook.html#cb29-21" tabindex="-1"></a></span>
<span id="cb29-22"><a href="sagemath-cookbook.html#cb29-22" tabindex="-1"></a>  <span class="co"># We need to compute c_i = Enc_k(m_i XOR c_{i-1})</span></span>
<span id="cb29-23"><a href="sagemath-cookbook.html#cb29-23" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_blocks):</span>
<span id="cb29-24"><a href="sagemath-cookbook.html#cb29-24" tabindex="-1"></a>    <span class="co"># c_{i-1}</span></span>
<span id="cb29-25"><a href="sagemath-cookbook.html#cb29-25" tabindex="-1"></a>    c_prev <span class="op">=</span> ciphertext[i <span class="op">*</span> block_size : (i<span class="op">+</span><span class="dv">1</span>) <span class="op">*</span> block_size]</span>
<span id="cb29-26"><a href="sagemath-cookbook.html#cb29-26" tabindex="-1"></a></span>
<span id="cb29-27"><a href="sagemath-cookbook.html#cb29-27" tabindex="-1"></a>    <span class="co"># m_i</span></span>
<span id="cb29-28"><a href="sagemath-cookbook.html#cb29-28" tabindex="-1"></a>    m_chunck <span class="op">=</span> message[i <span class="op">*</span> block_size : (i<span class="op">+</span><span class="dv">1</span>) <span class="op">*</span> block_size]</span>
<span id="cb29-29"><a href="sagemath-cookbook.html#cb29-29" tabindex="-1"></a></span>
<span id="cb29-30"><a href="sagemath-cookbook.html#cb29-30" tabindex="-1"></a>    <span class="co"># m_i XOR c_{i-1}</span></span>
<span id="cb29-31"><a href="sagemath-cookbook.html#cb29-31" tabindex="-1"></a>    block_input <span class="op">=</span> xor_bytes(c_prev, m_chunck)    </span>
<span id="cb29-32"><a href="sagemath-cookbook.html#cb29-32" tabindex="-1"></a></span>
<span id="cb29-33"><a href="sagemath-cookbook.html#cb29-33" tabindex="-1"></a>    <span class="co"># Enc(k, m_i XOR c_{i-1}) and add it to the ciphertext</span></span>
<span id="cb29-34"><a href="sagemath-cookbook.html#cb29-34" tabindex="-1"></a>    ciphertext <span class="op">+=</span> aes_enc(key, block_input)</span>
<span id="cb29-35"><a href="sagemath-cookbook.html#cb29-35" tabindex="-1"></a></span>
<span id="cb29-36"><a href="sagemath-cookbook.html#cb29-36" tabindex="-1"></a>  <span class="cf">return</span> ciphertext</span>
<span id="cb29-37"><a href="sagemath-cookbook.html#cb29-37" tabindex="-1"></a></span>
<span id="cb29-38"><a href="sagemath-cookbook.html#cb29-38" tabindex="-1"></a></span>
<span id="cb29-39"><a href="sagemath-cookbook.html#cb29-39" tabindex="-1"></a><span class="kw">def</span> aes_cbc_dec(key, ciphertext):</span>
<span id="cb29-40"><a href="sagemath-cookbook.html#cb29-40" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb29-41"><a href="sagemath-cookbook.html#cb29-41" tabindex="-1"></a><span class="co">  Runs the AES128 decryption on a message using CBC mode with the specified key.</span></span>
<span id="cb29-42"><a href="sagemath-cookbook.html#cb29-42" tabindex="-1"></a><span class="co">  The length of the ciphertext must be a multiple of 16.</span></span>
<span id="cb29-43"><a href="sagemath-cookbook.html#cb29-43" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb29-44"><a href="sagemath-cookbook.html#cb29-44" tabindex="-1"></a></span>
<span id="cb29-45"><a href="sagemath-cookbook.html#cb29-45" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(ciphertext) <span class="op">%</span> <span class="dv">16</span> <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb29-46"><a href="sagemath-cookbook.html#cb29-46" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;ciphertext length must be a multiple of 16&quot;</span>)</span>
<span id="cb29-47"><a href="sagemath-cookbook.html#cb29-47" tabindex="-1"></a></span>
<span id="cb29-48"><a href="sagemath-cookbook.html#cb29-48" tabindex="-1"></a>  block_size <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb29-49"><a href="sagemath-cookbook.html#cb29-49" tabindex="-1"></a></span>
<span id="cb29-50"><a href="sagemath-cookbook.html#cb29-50" tabindex="-1"></a>  <span class="co"># To compute the number of block we subtract 1 corresponding to the IV</span></span>
<span id="cb29-51"><a href="sagemath-cookbook.html#cb29-51" tabindex="-1"></a>  n_blocks <span class="op">=</span> <span class="bu">len</span>(ciphertext) <span class="op">/</span> block_size <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb29-52"><a href="sagemath-cookbook.html#cb29-52" tabindex="-1"></a></span>
<span id="cb29-53"><a href="sagemath-cookbook.html#cb29-53" tabindex="-1"></a>  message <span class="op">=</span> <span class="st">b&#39;&#39;</span> </span>
<span id="cb29-54"><a href="sagemath-cookbook.html#cb29-54" tabindex="-1"></a>  </span>
<span id="cb29-55"><a href="sagemath-cookbook.html#cb29-55" tabindex="-1"></a>  <span class="co"># We need to compute m_i = Dec_k(c_i) XOR c_{i-1}</span></span>
<span id="cb29-56"><a href="sagemath-cookbook.html#cb29-56" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_blocks):</span>
<span id="cb29-57"><a href="sagemath-cookbook.html#cb29-57" tabindex="-1"></a>    <span class="co"># c_{i-1}</span></span>
<span id="cb29-58"><a href="sagemath-cookbook.html#cb29-58" tabindex="-1"></a>    c_prev <span class="op">=</span> ciphertext[i <span class="op">*</span> block_size : (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> block_size]</span>
<span id="cb29-59"><a href="sagemath-cookbook.html#cb29-59" tabindex="-1"></a></span>
<span id="cb29-60"><a href="sagemath-cookbook.html#cb29-60" tabindex="-1"></a>    <span class="co"># c_{i}</span></span>
<span id="cb29-61"><a href="sagemath-cookbook.html#cb29-61" tabindex="-1"></a>    c <span class="op">=</span> ciphertext[(i <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> block_size : (i <span class="op">+</span> <span class="dv">2</span>) <span class="op">*</span> block_size]</span>
<span id="cb29-62"><a href="sagemath-cookbook.html#cb29-62" tabindex="-1"></a></span>
<span id="cb29-63"><a href="sagemath-cookbook.html#cb29-63" tabindex="-1"></a>    <span class="co"># Dec_k(c_i)</span></span>
<span id="cb29-64"><a href="sagemath-cookbook.html#cb29-64" tabindex="-1"></a>    dec_c <span class="op">=</span> aes_dec(key, c)</span>
<span id="cb29-65"><a href="sagemath-cookbook.html#cb29-65" tabindex="-1"></a></span>
<span id="cb29-66"><a href="sagemath-cookbook.html#cb29-66" tabindex="-1"></a>    <span class="co"># Dec_k(c_i) XOR c_{i-1} and add it to the message</span></span>
<span id="cb29-67"><a href="sagemath-cookbook.html#cb29-67" tabindex="-1"></a>    message <span class="op">+=</span> xor_bytes(dec_c, c_prev)</span>
<span id="cb29-68"><a href="sagemath-cookbook.html#cb29-68" tabindex="-1"></a>  <span class="cf">return</span> message</span></code></pre></div>
<p>Next, we demonstrate how to use the above code.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="sagemath-cookbook.html#cb30-1" tabindex="-1"></a><span class="co"># We use the aes_cbc.sage recipe</span></span>
<span id="cb30-2"><a href="sagemath-cookbook.html#cb30-2" tabindex="-1"></a>load(<span class="st">&#39;aes_cbc.sage&#39;</span>)</span>
<span id="cb30-3"><a href="sagemath-cookbook.html#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="sagemath-cookbook.html#cb30-4" tabindex="-1"></a><span class="co"># sample an aes128 key</span></span>
<span id="cb30-5"><a href="sagemath-cookbook.html#cb30-5" tabindex="-1"></a>k <span class="op">=</span> aes_keygen()</span>
<span id="cb30-6"><a href="sagemath-cookbook.html#cb30-6" tabindex="-1"></a></span>
<span id="cb30-7"><a href="sagemath-cookbook.html#cb30-7" tabindex="-1"></a><span class="co"># choose a random 100 * 16-byte long message to encrypt</span></span>
<span id="cb30-8"><a href="sagemath-cookbook.html#cb30-8" tabindex="-1"></a>m <span class="op">=</span> rand_bytes(<span class="dv">100</span> <span class="op">*</span> <span class="dv">16</span>)</span>
<span id="cb30-9"><a href="sagemath-cookbook.html#cb30-9" tabindex="-1"></a></span>
<span id="cb30-10"><a href="sagemath-cookbook.html#cb30-10" tabindex="-1"></a><span class="co"># encrypt</span></span>
<span id="cb30-11"><a href="sagemath-cookbook.html#cb30-11" tabindex="-1"></a>c <span class="op">=</span> aes_cbc_enc(k, m)</span>
<span id="cb30-12"><a href="sagemath-cookbook.html#cb30-12" tabindex="-1"></a></span>
<span id="cb30-13"><a href="sagemath-cookbook.html#cb30-13" tabindex="-1"></a><span class="co"># decrypt</span></span>
<span id="cb30-14"><a href="sagemath-cookbook.html#cb30-14" tabindex="-1"></a>m_prime <span class="op">=</span> aes_cbc_dec(k, c)</span>
<span id="cb30-15"><a href="sagemath-cookbook.html#cb30-15" tabindex="-1"></a></span>
<span id="cb30-16"><a href="sagemath-cookbook.html#cb30-16" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
<div id="modes-of-operation-aes128-counter" class="section level3 unnumbered hasAnchor">
<h3>Modes of Operation: AES128-Counter<a href="sagemath-cookbook.html#modes-of-operation-aes128-counter" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We do the same thing but for counter mode of operation.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="sagemath-cookbook.html#cb31-1" tabindex="-1"></a><span class="co"># We use the aes128.sage recipe</span></span>
<span id="cb31-2"><a href="sagemath-cookbook.html#cb31-2" tabindex="-1"></a>load(<span class="st">&#39;aes128.sage&#39;</span>)</span>
<span id="cb31-3"><a href="sagemath-cookbook.html#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="sagemath-cookbook.html#cb31-4" tabindex="-1"></a><span class="kw">def</span> aes_counter_enc(key, message):</span>
<span id="cb31-5"><a href="sagemath-cookbook.html#cb31-5" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-6"><a href="sagemath-cookbook.html#cb31-6" tabindex="-1"></a><span class="co">  Runs the AES128 encryption on a message using counter mode with the specified key.</span></span>
<span id="cb31-7"><a href="sagemath-cookbook.html#cb31-7" tabindex="-1"></a><span class="co">  The length of message must be a multiple of 16.</span></span>
<span id="cb31-8"><a href="sagemath-cookbook.html#cb31-8" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb31-9"><a href="sagemath-cookbook.html#cb31-9" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(message) <span class="op">%</span> <span class="dv">16</span> <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb31-10"><a href="sagemath-cookbook.html#cb31-10" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;Message length must be a multiple of 16&quot;</span>)</span>
<span id="cb31-11"><a href="sagemath-cookbook.html#cb31-11" tabindex="-1"></a></span>
<span id="cb31-12"><a href="sagemath-cookbook.html#cb31-12" tabindex="-1"></a>  block_size <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb31-13"><a href="sagemath-cookbook.html#cb31-13" tabindex="-1"></a></span>
<span id="cb31-14"><a href="sagemath-cookbook.html#cb31-14" tabindex="-1"></a>  <span class="co"># Sample a random IV used as the counter</span></span>
<span id="cb31-15"><a href="sagemath-cookbook.html#cb31-15" tabindex="-1"></a>  iv <span class="op">=</span> rand_bytes(block_size) </span>
<span id="cb31-16"><a href="sagemath-cookbook.html#cb31-16" tabindex="-1"></a></span>
<span id="cb31-17"><a href="sagemath-cookbook.html#cb31-17" tabindex="-1"></a>  n_blocks <span class="op">=</span> <span class="bu">len</span>(message) <span class="op">/</span> block_size</span>
<span id="cb31-18"><a href="sagemath-cookbook.html#cb31-18" tabindex="-1"></a></span>
<span id="cb31-19"><a href="sagemath-cookbook.html#cb31-19" tabindex="-1"></a>  <span class="co"># Initialize ciphertext with the counter </span></span>
<span id="cb31-20"><a href="sagemath-cookbook.html#cb31-20" tabindex="-1"></a>  ciphertext <span class="op">=</span> iv </span>
<span id="cb31-21"><a href="sagemath-cookbook.html#cb31-21" tabindex="-1"></a></span>
<span id="cb31-22"><a href="sagemath-cookbook.html#cb31-22" tabindex="-1"></a>  <span class="co"># We need to compute c_i = m_i XOR Enc_k(counter + i)</span></span>
<span id="cb31-23"><a href="sagemath-cookbook.html#cb31-23" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_blocks):</span>
<span id="cb31-24"><a href="sagemath-cookbook.html#cb31-24" tabindex="-1"></a>    <span class="co"># m_i</span></span>
<span id="cb31-25"><a href="sagemath-cookbook.html#cb31-25" tabindex="-1"></a>    m_chunk <span class="op">=</span> message[i <span class="op">*</span> block_size : (i<span class="op">+</span><span class="dv">1</span>) <span class="op">*</span> block_size]</span>
<span id="cb31-26"><a href="sagemath-cookbook.html#cb31-26" tabindex="-1"></a></span>
<span id="cb31-27"><a href="sagemath-cookbook.html#cb31-27" tabindex="-1"></a>    <span class="co"># counter + i </span></span>
<span id="cb31-28"><a href="sagemath-cookbook.html#cb31-28" tabindex="-1"></a>    counter <span class="op">=</span> (<span class="bu">int</span>.from_bytes(iv) <span class="op">+</span> i).to_bytes(<span class="dv">16</span>)</span>
<span id="cb31-29"><a href="sagemath-cookbook.html#cb31-29" tabindex="-1"></a></span>
<span id="cb31-30"><a href="sagemath-cookbook.html#cb31-30" tabindex="-1"></a>    <span class="co"># Enc_k(counter + i)</span></span>
<span id="cb31-31"><a href="sagemath-cookbook.html#cb31-31" tabindex="-1"></a>    encrypted_counter <span class="op">=</span> aes_enc(key, counter)</span>
<span id="cb31-32"><a href="sagemath-cookbook.html#cb31-32" tabindex="-1"></a></span>
<span id="cb31-33"><a href="sagemath-cookbook.html#cb31-33" tabindex="-1"></a>    <span class="co"># m_i XOR Enc_k(counter + i)</span></span>
<span id="cb31-34"><a href="sagemath-cookbook.html#cb31-34" tabindex="-1"></a>    ciphertext <span class="op">+=</span> xor_bytes(m_chunk, encrypted_counter)</span>
<span id="cb31-35"><a href="sagemath-cookbook.html#cb31-35" tabindex="-1"></a></span>
<span id="cb31-36"><a href="sagemath-cookbook.html#cb31-36" tabindex="-1"></a>  <span class="cf">return</span> ciphertext</span>
<span id="cb31-37"><a href="sagemath-cookbook.html#cb31-37" tabindex="-1"></a></span>
<span id="cb31-38"><a href="sagemath-cookbook.html#cb31-38" tabindex="-1"></a><span class="kw">def</span> aes_counter_dec(key, ciphertext):</span>
<span id="cb31-39"><a href="sagemath-cookbook.html#cb31-39" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-40"><a href="sagemath-cookbook.html#cb31-40" tabindex="-1"></a><span class="co">  Runs the AES128 decryption on a ciphertext using counter mode with the specified key.</span></span>
<span id="cb31-41"><a href="sagemath-cookbook.html#cb31-41" tabindex="-1"></a><span class="co">  The length of ciphertext must be a multiple of 16.</span></span>
<span id="cb31-42"><a href="sagemath-cookbook.html#cb31-42" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb31-43"><a href="sagemath-cookbook.html#cb31-43" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(ciphertext) <span class="op">%</span> <span class="dv">16</span> <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb31-44"><a href="sagemath-cookbook.html#cb31-44" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;Ciphertext length must be a multiple of 16&quot;</span>)</span>
<span id="cb31-45"><a href="sagemath-cookbook.html#cb31-45" tabindex="-1"></a></span>
<span id="cb31-46"><a href="sagemath-cookbook.html#cb31-46" tabindex="-1"></a>  block_size <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb31-47"><a href="sagemath-cookbook.html#cb31-47" tabindex="-1"></a></span>
<span id="cb31-48"><a href="sagemath-cookbook.html#cb31-48" tabindex="-1"></a>  <span class="co"># extract the iv </span></span>
<span id="cb31-49"><a href="sagemath-cookbook.html#cb31-49" tabindex="-1"></a>  iv <span class="op">=</span> ciphertext[:block_size] </span>
<span id="cb31-50"><a href="sagemath-cookbook.html#cb31-50" tabindex="-1"></a></span>
<span id="cb31-51"><a href="sagemath-cookbook.html#cb31-51" tabindex="-1"></a>  <span class="co"># To compute the number of block we subtract 1 corresponding to the counter</span></span>
<span id="cb31-52"><a href="sagemath-cookbook.html#cb31-52" tabindex="-1"></a>  n_blocks <span class="op">=</span> <span class="bu">len</span>(ciphertext) <span class="op">/</span> block_size <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb31-53"><a href="sagemath-cookbook.html#cb31-53" tabindex="-1"></a></span>
<span id="cb31-54"><a href="sagemath-cookbook.html#cb31-54" tabindex="-1"></a>  message <span class="op">=</span> <span class="st">b&#39;&#39;</span> </span>
<span id="cb31-55"><a href="sagemath-cookbook.html#cb31-55" tabindex="-1"></a></span>
<span id="cb31-56"><a href="sagemath-cookbook.html#cb31-56" tabindex="-1"></a>  <span class="co"># We need to compute m_i = c_i XOR Enc_k(counter + i)</span></span>
<span id="cb31-57"><a href="sagemath-cookbook.html#cb31-57" tabindex="-1"></a>  <span class="co"># Note that counter mode does not need decryption.</span></span>
<span id="cb31-58"><a href="sagemath-cookbook.html#cb31-58" tabindex="-1"></a></span>
<span id="cb31-59"><a href="sagemath-cookbook.html#cb31-59" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_blocks):</span>
<span id="cb31-60"><a href="sagemath-cookbook.html#cb31-60" tabindex="-1"></a>    <span class="co"># c_i</span></span>
<span id="cb31-61"><a href="sagemath-cookbook.html#cb31-61" tabindex="-1"></a>    c_chunk <span class="op">=</span> ciphertext[(i <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> block_size : (i <span class="op">+</span> <span class="dv">2</span>) <span class="op">*</span> block_size]</span>
<span id="cb31-62"><a href="sagemath-cookbook.html#cb31-62" tabindex="-1"></a></span>
<span id="cb31-63"><a href="sagemath-cookbook.html#cb31-63" tabindex="-1"></a>    <span class="co"># counter + i </span></span>
<span id="cb31-64"><a href="sagemath-cookbook.html#cb31-64" tabindex="-1"></a>    counter <span class="op">=</span> (<span class="bu">int</span>.from_bytes(iv) <span class="op">+</span> i).to_bytes(<span class="dv">16</span>)</span>
<span id="cb31-65"><a href="sagemath-cookbook.html#cb31-65" tabindex="-1"></a></span>
<span id="cb31-66"><a href="sagemath-cookbook.html#cb31-66" tabindex="-1"></a>    <span class="co"># Enc_k(counter + i) </span></span>
<span id="cb31-67"><a href="sagemath-cookbook.html#cb31-67" tabindex="-1"></a>    encrypted_counter <span class="op">=</span> aes_enc(key, counter)</span>
<span id="cb31-68"><a href="sagemath-cookbook.html#cb31-68" tabindex="-1"></a></span>
<span id="cb31-69"><a href="sagemath-cookbook.html#cb31-69" tabindex="-1"></a>    <span class="co"># c_i XOR Enc_k(counter + i)</span></span>
<span id="cb31-70"><a href="sagemath-cookbook.html#cb31-70" tabindex="-1"></a>    message <span class="op">+=</span> xor_bytes(c_chunk, encrypted_counter)</span>
<span id="cb31-71"><a href="sagemath-cookbook.html#cb31-71" tabindex="-1"></a></span>
<span id="cb31-72"><a href="sagemath-cookbook.html#cb31-72" tabindex="-1"></a>  <span class="cf">return</span> message </span></code></pre></div>
<p>And here is how you can use the above code:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="sagemath-cookbook.html#cb32-1" tabindex="-1"></a><span class="co"># We use the aes128.sage recipe</span></span>
<span id="cb32-2"><a href="sagemath-cookbook.html#cb32-2" tabindex="-1"></a>load(<span class="st">&#39;aes_counter.sage&#39;</span>)</span>
<span id="cb32-3"><a href="sagemath-cookbook.html#cb32-3" tabindex="-1"></a></span>
<span id="cb32-4"><a href="sagemath-cookbook.html#cb32-4" tabindex="-1"></a><span class="co"># sample an aes128 key</span></span>
<span id="cb32-5"><a href="sagemath-cookbook.html#cb32-5" tabindex="-1"></a>k <span class="op">=</span> aes_keygen()</span>
<span id="cb32-6"><a href="sagemath-cookbook.html#cb32-6" tabindex="-1"></a></span>
<span id="cb32-7"><a href="sagemath-cookbook.html#cb32-7" tabindex="-1"></a><span class="co"># choose a random 100 * 16-byte long message to encrypt</span></span>
<span id="cb32-8"><a href="sagemath-cookbook.html#cb32-8" tabindex="-1"></a>m <span class="op">=</span> rand_bytes(<span class="dv">100</span> <span class="op">*</span> <span class="dv">16</span>)</span>
<span id="cb32-9"><a href="sagemath-cookbook.html#cb32-9" tabindex="-1"></a></span>
<span id="cb32-10"><a href="sagemath-cookbook.html#cb32-10" tabindex="-1"></a><span class="co"># encrypt</span></span>
<span id="cb32-11"><a href="sagemath-cookbook.html#cb32-11" tabindex="-1"></a>c <span class="op">=</span> aes_counter_enc(k, m)</span>
<span id="cb32-12"><a href="sagemath-cookbook.html#cb32-12" tabindex="-1"></a></span>
<span id="cb32-13"><a href="sagemath-cookbook.html#cb32-13" tabindex="-1"></a><span class="co"># decrypt</span></span>
<span id="cb32-14"><a href="sagemath-cookbook.html#cb32-14" tabindex="-1"></a>m_prime <span class="op">=</span> aes_counter_dec(k, c)</span>
<span id="cb32-15"><a href="sagemath-cookbook.html#cb32-15" tabindex="-1"></a></span>
<span id="cb32-16"><a href="sagemath-cookbook.html#cb32-16" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
<div id="hash-functions-1" class="section level3 unnumbered hasAnchor">
<h3>Hash Functions<a href="sagemath-cookbook.html#hash-functions-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, we show how to use hash functions with the help of <code>hashlib</code> library.
The library supports various different functions so you can easily change the hash
function choice if you need to.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="sagemath-cookbook.html#cb33-1" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb33-2"><a href="sagemath-cookbook.html#cb33-2" tabindex="-1"></a></span>
<span id="cb33-3"><a href="sagemath-cookbook.html#cb33-3" tabindex="-1"></a><span class="co"># Hashlib supports various hash functions. List them </span></span>
<span id="cb33-4"><a href="sagemath-cookbook.html#cb33-4" tabindex="-1"></a>algorithms <span class="op">=</span> hashlib.algorithms_available </span>
<span id="cb33-5"><a href="sagemath-cookbook.html#cb33-5" tabindex="-1"></a></span>
<span id="cb33-6"><a href="sagemath-cookbook.html#cb33-6" tabindex="-1"></a>msg <span class="op">=</span> <span class="st">b&quot;I need to be hashed. Please use sha256 to hash me&quot;</span></span>
<span id="cb33-7"><a href="sagemath-cookbook.html#cb33-7" tabindex="-1"></a></span>
<span id="cb33-8"><a href="sagemath-cookbook.html#cb33-8" tabindex="-1"></a><span class="co"># if it is an str instead of bytes use msg.encode()</span></span>
<span id="cb33-9"><a href="sagemath-cookbook.html#cb33-9" tabindex="-1"></a>sha256_digest <span class="op">=</span> hashlib.sha256(msg).hexdigest()</span></code></pre></div>
</div>
</div>
<div id="number-theory" class="section level2 hasAnchor" number="17.4">
<h2><span class="header-section-number">E.4</span> Number theory<a href="sagemath-cookbook.html#number-theory" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we demonstrate how to use sage for some very basic number
theory.</p>
<div id="sampling-random-primes" class="section level3 unnumbered hasAnchor">
<h3>Sampling Random Primes<a href="sagemath-cookbook.html#sampling-random-primes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A recipe to sample random primes of specific bitlength (meaning they need at least these many
bits to be represented).</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="sagemath-cookbook.html#cb34-1" tabindex="-1"></a>bit_length <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb34-2"><a href="sagemath-cookbook.html#cb34-2" tabindex="-1"></a>lower_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(bit_length<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb34-3"><a href="sagemath-cookbook.html#cb34-3" tabindex="-1"></a>upper_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(bit_length)<span class="op">-</span><span class="dv">1</span></span>
<span id="cb34-4"><a href="sagemath-cookbook.html#cb34-4" tabindex="-1"></a></span>
<span id="cb34-5"><a href="sagemath-cookbook.html#cb34-5" tabindex="-1"></a>p <span class="op">=</span> random_prime(lower_bound, upper_bound)</span></code></pre></div>
</div>
<div id="factoring" class="section level3 unnumbered hasAnchor">
<h3>Factoring<a href="sagemath-cookbook.html#factoring" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe factors numbers. Try to see how big numbers you can sample in a reasonable amount of time!</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="sagemath-cookbook.html#cb35-1" tabindex="-1"></a><span class="co"># We can simply use the built in function factor </span></span>
<span id="cb35-2"><a href="sagemath-cookbook.html#cb35-2" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">720</span></span>
<span id="cb35-3"><a href="sagemath-cookbook.html#cb35-3" tabindex="-1"></a>factorization <span class="op">=</span> factor(n)</span></code></pre></div>
</div>
<div id="primality-testing-1" class="section level3 unnumbered hasAnchor">
<h3>Primality Testing<a href="sagemath-cookbook.html#primality-testing-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We next show how to do primality testing in sage. Note that we simply use the <code>in</code> keyword that checks membership in
a set.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="sagemath-cookbook.html#cb36-1" tabindex="-1"></a><span class="cf">assert</span> (<span class="dv">7</span> <span class="kw">in</span> Primes())</span>
<span id="cb36-2"><a href="sagemath-cookbook.html#cb36-2" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span>(<span class="dv">8</span> <span class="kw">in</span> Primes())</span></code></pre></div>
</div>
<div id="extended-euclidian-algorithm" class="section level3 unnumbered hasAnchor">
<h3>Extended Euclidian Algorithm<a href="sagemath-cookbook.html#extended-euclidian-algorithm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to run the (Extended) Euclidian Algorithm in sage.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="sagemath-cookbook.html#cb37-1" tabindex="-1"></a>a <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb37-2"><a href="sagemath-cookbook.html#cb37-2" tabindex="-1"></a>b <span class="op">=</span> <span class="dv">35</span></span>
<span id="cb37-3"><a href="sagemath-cookbook.html#cb37-3" tabindex="-1"></a></span>
<span id="cb37-4"><a href="sagemath-cookbook.html#cb37-4" tabindex="-1"></a><span class="co"># Compute the greatest common divisor of a and b</span></span>
<span id="cb37-5"><a href="sagemath-cookbook.html#cb37-5" tabindex="-1"></a>d <span class="op">=</span> gcd(a, b)</span>
<span id="cb37-6"><a href="sagemath-cookbook.html#cb37-6" tabindex="-1"></a><span class="cf">assert</span> d <span class="op">==</span> <span class="dv">5</span></span>
<span id="cb37-7"><a href="sagemath-cookbook.html#cb37-7" tabindex="-1"></a></span>
<span id="cb37-8"><a href="sagemath-cookbook.html#cb37-8" tabindex="-1"></a><span class="co"># Check coprimality</span></span>
<span id="cb37-9"><a href="sagemath-cookbook.html#cb37-9" tabindex="-1"></a>are_coprimes <span class="op">=</span> (gcd(a,b) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb37-10"><a href="sagemath-cookbook.html#cb37-10" tabindex="-1"></a><span class="cf">assert</span> are_coprimes <span class="op">==</span> false</span>
<span id="cb37-11"><a href="sagemath-cookbook.html#cb37-11" tabindex="-1"></a></span>
<span id="cb37-12"><a href="sagemath-cookbook.html#cb37-12" tabindex="-1"></a><span class="co"># Compute d, x, y s.t. d = ax + by and d is the greatest </span></span>
<span id="cb37-13"><a href="sagemath-cookbook.html#cb37-13" tabindex="-1"></a><span class="co"># common divisor of a and b</span></span>
<span id="cb37-14"><a href="sagemath-cookbook.html#cb37-14" tabindex="-1"></a>(d, x, y) <span class="op">=</span> xgcd(a, b)</span>
<span id="cb37-15"><a href="sagemath-cookbook.html#cb37-15" tabindex="-1"></a><span class="cf">assert</span> d <span class="op">==</span> x<span class="op">*</span>a <span class="op">+</span> y<span class="op">*</span>b</span></code></pre></div>
</div>
<div id="modular-arithmetic-1" class="section level3 unnumbered hasAnchor">
<h3>Modular Arithmetic<a href="sagemath-cookbook.html#modular-arithmetic-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, we show how to do efficient modular arithmetic in sage. It is basically enough to define the correct ring
(numbers mod n with addition and multiplication mod n) and then work just as you would in integer arithmetic. You don’t
even need to care about efficiency, sage knows that it should use -for example- fast exponentiation when you exponentiate on
this ring.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="sagemath-cookbook.html#cb38-1" tabindex="-1"></a><span class="co"># Define integers ring Z17</span></span>
<span id="cb38-2"><a href="sagemath-cookbook.html#cb38-2" tabindex="-1"></a>Z17 <span class="op">=</span> Integers(<span class="dv">17</span>)</span>
<span id="cb38-3"><a href="sagemath-cookbook.html#cb38-3" tabindex="-1"></a></span>
<span id="cb38-4"><a href="sagemath-cookbook.html#cb38-4" tabindex="-1"></a><span class="co"># Define elements</span></span>
<span id="cb38-5"><a href="sagemath-cookbook.html#cb38-5" tabindex="-1"></a>a <span class="op">=</span> Z17(<span class="dv">3</span>)</span>
<span id="cb38-6"><a href="sagemath-cookbook.html#cb38-6" tabindex="-1"></a>b <span class="op">=</span> Z17(<span class="dv">15</span>)</span>
<span id="cb38-7"><a href="sagemath-cookbook.html#cb38-7" tabindex="-1"></a></span>
<span id="cb38-8"><a href="sagemath-cookbook.html#cb38-8" tabindex="-1"></a><span class="co"># Addition</span></span>
<span id="cb38-9"><a href="sagemath-cookbook.html#cb38-9" tabindex="-1"></a>add <span class="op">=</span> a <span class="op">+</span> b </span>
<span id="cb38-10"><a href="sagemath-cookbook.html#cb38-10" tabindex="-1"></a><span class="cf">assert</span> add <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb38-11"><a href="sagemath-cookbook.html#cb38-11" tabindex="-1"></a></span>
<span id="cb38-12"><a href="sagemath-cookbook.html#cb38-12" tabindex="-1"></a><span class="co"># Subtraction</span></span>
<span id="cb38-13"><a href="sagemath-cookbook.html#cb38-13" tabindex="-1"></a>sub <span class="op">=</span> a <span class="op">-</span> b </span>
<span id="cb38-14"><a href="sagemath-cookbook.html#cb38-14" tabindex="-1"></a><span class="cf">assert</span> sub <span class="op">==</span> <span class="dv">5</span></span>
<span id="cb38-15"><a href="sagemath-cookbook.html#cb38-15" tabindex="-1"></a></span>
<span id="cb38-16"><a href="sagemath-cookbook.html#cb38-16" tabindex="-1"></a><span class="co"># Multiplication</span></span>
<span id="cb38-17"><a href="sagemath-cookbook.html#cb38-17" tabindex="-1"></a>mul <span class="op">=</span> a <span class="op">*</span> b </span>
<span id="cb38-18"><a href="sagemath-cookbook.html#cb38-18" tabindex="-1"></a><span class="cf">assert</span> mul <span class="op">==</span> <span class="dv">11</span> </span>
<span id="cb38-19"><a href="sagemath-cookbook.html#cb38-19" tabindex="-1"></a></span>
<span id="cb38-20"><a href="sagemath-cookbook.html#cb38-20" tabindex="-1"></a><span class="co"># Inversion </span></span>
<span id="cb38-21"><a href="sagemath-cookbook.html#cb38-21" tabindex="-1"></a>inv_a <span class="op">=</span> a<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>) </span>
<span id="cb38-22"><a href="sagemath-cookbook.html#cb38-22" tabindex="-1"></a><span class="cf">assert</span> inv_a <span class="op">==</span> <span class="dv">6</span> </span>
<span id="cb38-23"><a href="sagemath-cookbook.html#cb38-23" tabindex="-1"></a></span>
<span id="cb38-24"><a href="sagemath-cookbook.html#cb38-24" tabindex="-1"></a><span class="co"># Exponentiation</span></span>
<span id="cb38-25"><a href="sagemath-cookbook.html#cb38-25" tabindex="-1"></a>exp <span class="op">=</span> a<span class="op">^</span><span class="dv">3</span></span>
<span id="cb38-26"><a href="sagemath-cookbook.html#cb38-26" tabindex="-1"></a><span class="cf">assert</span> exp <span class="op">==</span> <span class="dv">10</span> </span>
<span id="cb38-27"><a href="sagemath-cookbook.html#cb38-27" tabindex="-1"></a></span>
<span id="cb38-28"><a href="sagemath-cookbook.html#cb38-28" tabindex="-1"></a><span class="co"># Solve linear equation 15x = 3 mod n</span></span>
<span id="cb38-29"><a href="sagemath-cookbook.html#cb38-29" tabindex="-1"></a>sol <span class="op">=</span> a <span class="op">*</span> b<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>)</span></code></pre></div>
</div>
</div>
<div id="groups-and-fields" class="section level2 hasAnchor" number="17.5">
<h2><span class="header-section-number">E.5</span> Groups and Fields<a href="sagemath-cookbook.html#groups-and-fields" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We next show how to use sage to work with groups and fields. This is actually more useful in symbolic calculations rather than
with cryptography, but it is useful to familiarize with the interface a bit.</p>
<div id="additive-groups" class="section level3 unnumbered hasAnchor">
<h3>Additive Groups<a href="sagemath-cookbook.html#additive-groups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We showcase how to handle groups whose operation is denoted additively.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="sagemath-cookbook.html#cb39-1" tabindex="-1"></a><span class="co"># Define the group (Z11, +)</span></span>
<span id="cb39-2"><a href="sagemath-cookbook.html#cb39-2" tabindex="-1"></a></span>
<span id="cb39-3"><a href="sagemath-cookbook.html#cb39-3" tabindex="-1"></a>G <span class="op">=</span> AdditiveAbelianGroup([<span class="dv">11</span>])</span>
<span id="cb39-4"><a href="sagemath-cookbook.html#cb39-4" tabindex="-1"></a></span>
<span id="cb39-5"><a href="sagemath-cookbook.html#cb39-5" tabindex="-1"></a><span class="co"># list the elements of G</span></span>
<span id="cb39-6"><a href="sagemath-cookbook.html#cb39-6" tabindex="-1"></a><span class="bu">list</span>(G)</span>
<span id="cb39-7"><a href="sagemath-cookbook.html#cb39-7" tabindex="-1"></a></span>
<span id="cb39-8"><a href="sagemath-cookbook.html#cb39-8" tabindex="-1"></a><span class="co"># get the default generator</span></span>
<span id="cb39-9"><a href="sagemath-cookbook.html#cb39-9" tabindex="-1"></a>g <span class="op">=</span> G.gens()[<span class="dv">0</span>] </span>
<span id="cb39-10"><a href="sagemath-cookbook.html#cb39-10" tabindex="-1"></a></span>
<span id="cb39-11"><a href="sagemath-cookbook.html#cb39-11" tabindex="-1"></a><span class="co"># identity element</span></span>
<span id="cb39-12"><a href="sagemath-cookbook.html#cb39-12" tabindex="-1"></a>e <span class="op">=</span> G.identity()</span>
<span id="cb39-13"><a href="sagemath-cookbook.html#cb39-13" tabindex="-1"></a></span>
<span id="cb39-14"><a href="sagemath-cookbook.html#cb39-14" tabindex="-1"></a><span class="co"># group operation</span></span>
<span id="cb39-15"><a href="sagemath-cookbook.html#cb39-15" tabindex="-1"></a>h1 <span class="op">=</span> g <span class="op">+</span> g</span>
<span id="cb39-16"><a href="sagemath-cookbook.html#cb39-16" tabindex="-1"></a>h2 <span class="op">=</span> <span class="dv">7</span><span class="op">*</span>g  <span class="co"># equals g + g + g + g + g+ g + g</span></span>
<span id="cb39-17"><a href="sagemath-cookbook.html#cb39-17" tabindex="-1"></a></span>
<span id="cb39-18"><a href="sagemath-cookbook.html#cb39-18" tabindex="-1"></a><span class="co"># adding the identity element</span></span>
<span id="cb39-19"><a href="sagemath-cookbook.html#cb39-19" tabindex="-1"></a>h3 <span class="op">=</span> h2 <span class="op">+</span> e</span>
<span id="cb39-20"><a href="sagemath-cookbook.html#cb39-20" tabindex="-1"></a><span class="cf">assert</span> h3 <span class="op">==</span> h2</span>
<span id="cb39-21"><a href="sagemath-cookbook.html#cb39-21" tabindex="-1"></a></span>
<span id="cb39-22"><a href="sagemath-cookbook.html#cb39-22" tabindex="-1"></a><span class="co"># inversion</span></span>
<span id="cb39-23"><a href="sagemath-cookbook.html#cb39-23" tabindex="-1"></a>invh1 <span class="op">=</span> <span class="op">-</span>h1</span>
<span id="cb39-24"><a href="sagemath-cookbook.html#cb39-24" tabindex="-1"></a><span class="cf">assert</span> invh1 <span class="op">+</span> h1 <span class="op">==</span> e</span>
<span id="cb39-25"><a href="sagemath-cookbook.html#cb39-25" tabindex="-1"></a></span>
<span id="cb39-26"><a href="sagemath-cookbook.html#cb39-26" tabindex="-1"></a><span class="co"># order of G</span></span>
<span id="cb39-27"><a href="sagemath-cookbook.html#cb39-27" tabindex="-1"></a>ordG <span class="op">=</span> G.order()</span>
<span id="cb39-28"><a href="sagemath-cookbook.html#cb39-28" tabindex="-1"></a><span class="cf">assert</span> ordG <span class="op">==</span> <span class="dv">11</span></span>
<span id="cb39-29"><a href="sagemath-cookbook.html#cb39-29" tabindex="-1"></a></span>
<span id="cb39-30"><a href="sagemath-cookbook.html#cb39-30" tabindex="-1"></a><span class="co"># random element</span></span>
<span id="cb39-31"><a href="sagemath-cookbook.html#cb39-31" tabindex="-1"></a>hrandom <span class="op">=</span> G.random_element()</span></code></pre></div>
</div>
<div id="unit-groups" class="section level3 unnumbered hasAnchor">
<h3>Unit Groups<a href="sagemath-cookbook.html#unit-groups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Same thing for unit groups. For our purposes we only care for <span class="math inline">\(\mathbb{Z}_n^*\)</span> unit groups, meaning the invertible elements <span class="math inline">\(\mod n\)</span>. Note
that sage treats these elements abstractly (as $f, f^2,…) for a formal variable f representing a group generator. We use the <code>inject_variables</code> command to bring this symbol in scope. We can then see the actual <span class="math inline">\(\mathbb{Z}_p^*\)</span> element corresponding to <span class="math inline">\(f^i\)</span> as
<code>Zn(f^i)</code> where <code>Zn</code> is our ring.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="sagemath-cookbook.html#cb40-1" tabindex="-1"></a><span class="co"># Define the ring (Z11, +, *)</span></span>
<span id="cb40-2"><a href="sagemath-cookbook.html#cb40-2" tabindex="-1"></a>Z11 <span class="op">=</span> Integers(<span class="dv">11</span>) </span>
<span id="cb40-3"><a href="sagemath-cookbook.html#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="sagemath-cookbook.html#cb40-4" tabindex="-1"></a><span class="co"># Define the group (Z11, *)</span></span>
<span id="cb40-5"><a href="sagemath-cookbook.html#cb40-5" tabindex="-1"></a>G <span class="op">=</span> Integers(<span class="dv">11</span>).unit_group()</span>
<span id="cb40-6"><a href="sagemath-cookbook.html#cb40-6" tabindex="-1"></a></span>
<span id="cb40-7"><a href="sagemath-cookbook.html#cb40-7" tabindex="-1"></a><span class="co"># list the elements of G w.r.t. a generator.</span></span>
<span id="cb40-8"><a href="sagemath-cookbook.html#cb40-8" tabindex="-1"></a><span class="co"># Note that this gives a list [1, f, f^2, ...]</span></span>
<span id="cb40-9"><a href="sagemath-cookbook.html#cb40-9" tabindex="-1"></a><span class="bu">list</span>(G)</span>
<span id="cb40-10"><a href="sagemath-cookbook.html#cb40-10" tabindex="-1"></a></span>
<span id="cb40-11"><a href="sagemath-cookbook.html#cb40-11" tabindex="-1"></a><span class="co"># To see actual elements, we need to map f^i to an element</span></span>
<span id="cb40-12"><a href="sagemath-cookbook.html#cb40-12" tabindex="-1"></a><span class="co"># in the ring</span></span>
<span id="cb40-13"><a href="sagemath-cookbook.html#cb40-13" tabindex="-1"></a></span>
<span id="cb40-14"><a href="sagemath-cookbook.html#cb40-14" tabindex="-1"></a><span class="co"># This brings to scope the variable f </span></span>
<span id="cb40-15"><a href="sagemath-cookbook.html#cb40-15" tabindex="-1"></a>G.inject_variables()</span>
<span id="cb40-16"><a href="sagemath-cookbook.html#cb40-16" tabindex="-1"></a></span>
<span id="cb40-17"><a href="sagemath-cookbook.html#cb40-17" tabindex="-1"></a><span class="co"># We can now map f to a ring element</span></span>
<span id="cb40-18"><a href="sagemath-cookbook.html#cb40-18" tabindex="-1"></a>h <span class="op">=</span> Z11(f<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb40-19"><a href="sagemath-cookbook.html#cb40-19" tabindex="-1"></a><span class="cf">assert</span> h <span class="op">==</span> <span class="dv">4</span></span>
<span id="cb40-20"><a href="sagemath-cookbook.html#cb40-20" tabindex="-1"></a></span>
<span id="cb40-21"><a href="sagemath-cookbook.html#cb40-21" tabindex="-1"></a><span class="co"># get the default generator</span></span>
<span id="cb40-22"><a href="sagemath-cookbook.html#cb40-22" tabindex="-1"></a>g <span class="op">=</span> G.gens()[<span class="dv">0</span>] </span>
<span id="cb40-23"><a href="sagemath-cookbook.html#cb40-23" tabindex="-1"></a><span class="cf">assert</span> g <span class="op">==</span> f</span>
<span id="cb40-24"><a href="sagemath-cookbook.html#cb40-24" tabindex="-1"></a></span>
<span id="cb40-25"><a href="sagemath-cookbook.html#cb40-25" tabindex="-1"></a><span class="co"># get the first generator</span></span>
<span id="cb40-26"><a href="sagemath-cookbook.html#cb40-26" tabindex="-1"></a><span class="co"># g = generators[0] </span></span>
<span id="cb40-27"><a href="sagemath-cookbook.html#cb40-27" tabindex="-1"></a></span>
<span id="cb40-28"><a href="sagemath-cookbook.html#cb40-28" tabindex="-1"></a><span class="co"># identity element</span></span>
<span id="cb40-29"><a href="sagemath-cookbook.html#cb40-29" tabindex="-1"></a>e <span class="op">=</span> G.identity()</span>
<span id="cb40-30"><a href="sagemath-cookbook.html#cb40-30" tabindex="-1"></a></span>
<span id="cb40-31"><a href="sagemath-cookbook.html#cb40-31" tabindex="-1"></a><span class="co"># group operation</span></span>
<span id="cb40-32"><a href="sagemath-cookbook.html#cb40-32" tabindex="-1"></a>h1 <span class="op">=</span> g <span class="op">*</span> g</span>
<span id="cb40-33"><a href="sagemath-cookbook.html#cb40-33" tabindex="-1"></a><span class="cf">assert</span> Z11(h1) <span class="op">==</span> <span class="dv">4</span></span>
<span id="cb40-34"><a href="sagemath-cookbook.html#cb40-34" tabindex="-1"></a></span>
<span id="cb40-35"><a href="sagemath-cookbook.html#cb40-35" tabindex="-1"></a>h2 <span class="op">=</span> g<span class="op">^</span><span class="dv">7</span>  <span class="co"># equals g * g * g * g * g * g * g</span></span>
<span id="cb40-36"><a href="sagemath-cookbook.html#cb40-36" tabindex="-1"></a><span class="cf">assert</span> Z11(h2) <span class="op">==</span> (<span class="dv">2</span><span class="op">^</span><span class="dv">7</span>) <span class="op">%</span> <span class="dv">11</span></span>
<span id="cb40-37"><a href="sagemath-cookbook.html#cb40-37" tabindex="-1"></a></span>
<span id="cb40-38"><a href="sagemath-cookbook.html#cb40-38" tabindex="-1"></a>h3 <span class="op">=</span> h2 <span class="op">*</span> e</span>
<span id="cb40-39"><a href="sagemath-cookbook.html#cb40-39" tabindex="-1"></a><span class="cf">assert</span> h3 <span class="op">==</span> h2</span>
<span id="cb40-40"><a href="sagemath-cookbook.html#cb40-40" tabindex="-1"></a></span>
<span id="cb40-41"><a href="sagemath-cookbook.html#cb40-41" tabindex="-1"></a><span class="co"># inversion</span></span>
<span id="cb40-42"><a href="sagemath-cookbook.html#cb40-42" tabindex="-1"></a>invh3 <span class="op">=</span> h3<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb40-43"><a href="sagemath-cookbook.html#cb40-43" tabindex="-1"></a><span class="cf">assert</span> invh3 <span class="op">*</span> h3 <span class="op">==</span> e</span>
<span id="cb40-44"><a href="sagemath-cookbook.html#cb40-44" tabindex="-1"></a></span>
<span id="cb40-45"><a href="sagemath-cookbook.html#cb40-45" tabindex="-1"></a><span class="co"># order of G</span></span>
<span id="cb40-46"><a href="sagemath-cookbook.html#cb40-46" tabindex="-1"></a>ordG <span class="op">=</span> G.order()</span>
<span id="cb40-47"><a href="sagemath-cookbook.html#cb40-47" tabindex="-1"></a><span class="cf">assert</span> ordG <span class="op">==</span> <span class="dv">10</span></span>
<span id="cb40-48"><a href="sagemath-cookbook.html#cb40-48" tabindex="-1"></a></span>
<span id="cb40-49"><a href="sagemath-cookbook.html#cb40-49" tabindex="-1"></a><span class="co"># random element</span></span>
<span id="cb40-50"><a href="sagemath-cookbook.html#cb40-50" tabindex="-1"></a>hrandom <span class="op">=</span> G.random_element()</span>
<span id="cb40-51"><a href="sagemath-cookbook.html#cb40-51" tabindex="-1"></a></span>
<span id="cb40-52"><a href="sagemath-cookbook.html#cb40-52" tabindex="-1"></a><span class="co"># order of an element</span></span>
<span id="cb40-53"><a href="sagemath-cookbook.html#cb40-53" tabindex="-1"></a>ord_h3 <span class="op">=</span> h3.order()</span>
<span id="cb40-54"><a href="sagemath-cookbook.html#cb40-54" tabindex="-1"></a></span>
<span id="cb40-55"><a href="sagemath-cookbook.html#cb40-55" tabindex="-1"></a><span class="co"># list subgroups</span></span>
<span id="cb40-56"><a href="sagemath-cookbook.html#cb40-56" tabindex="-1"></a><span class="co"># Note that G is of order 10 = 2 * 5. It has: </span></span>
<span id="cb40-57"><a href="sagemath-cookbook.html#cb40-57" tabindex="-1"></a><span class="co">#  - a (trivial) subgroup of size 1</span></span>
<span id="cb40-58"><a href="sagemath-cookbook.html#cb40-58" tabindex="-1"></a><span class="co">#  - a subgroup of size 2</span></span>
<span id="cb40-59"><a href="sagemath-cookbook.html#cb40-59" tabindex="-1"></a><span class="co">#  - a subgroup of size 5</span></span>
<span id="cb40-60"><a href="sagemath-cookbook.html#cb40-60" tabindex="-1"></a><span class="co">#  - a subgroup of size 2*5</span></span>
<span id="cb40-61"><a href="sagemath-cookbook.html#cb40-61" tabindex="-1"></a><span class="co"># The output gives a list: </span></span>
<span id="cb40-62"><a href="sagemath-cookbook.html#cb40-62" tabindex="-1"></a><span class="co">#    [Multiplicative Abelian subgroup isomorphic to C2 x C5 generated by {f},</span></span>
<span id="cb40-63"><a href="sagemath-cookbook.html#cb40-63" tabindex="-1"></a><span class="co">#     Multiplicative Abelian subgroup isomorphic to C5 generated by {f^2},</span></span>
<span id="cb40-64"><a href="sagemath-cookbook.html#cb40-64" tabindex="-1"></a><span class="co">#     Multiplicative Abelian subgroup isomorphic to C2 generated by {f^5},</span></span>
<span id="cb40-65"><a href="sagemath-cookbook.html#cb40-65" tabindex="-1"></a><span class="co">#     Trivial Abelian subgroup]</span></span>
<span id="cb40-66"><a href="sagemath-cookbook.html#cb40-66" tabindex="-1"></a>G.subgroups()</span>
<span id="cb40-67"><a href="sagemath-cookbook.html#cb40-67" tabindex="-1"></a></span>
<span id="cb40-68"><a href="sagemath-cookbook.html#cb40-68" tabindex="-1"></a><span class="co"># Get the subgroupof of order 5 </span></span>
<span id="cb40-69"><a href="sagemath-cookbook.html#cb40-69" tabindex="-1"></a>H <span class="op">=</span> G.subgroups()[<span class="dv">2</span>]</span>
<span id="cb40-70"><a href="sagemath-cookbook.html#cb40-70" tabindex="-1"></a></span>
<span id="cb40-71"><a href="sagemath-cookbook.html#cb40-71" tabindex="-1"></a><span class="co"># Get the subgroup defined by f^5</span></span>
<span id="cb40-72"><a href="sagemath-cookbook.html#cb40-72" tabindex="-1"></a><span class="co"># We rename the generator to h5 since we already have f</span></span>
<span id="cb40-73"><a href="sagemath-cookbook.html#cb40-73" tabindex="-1"></a>H5 <span class="op">=</span> G.subgroup([f<span class="op">^</span><span class="dv">5</span>], <span class="st">&#39;h5&#39;</span>)</span>
<span id="cb40-74"><a href="sagemath-cookbook.html#cb40-74" tabindex="-1"></a>H5.inject_variables()</span>
<span id="cb40-75"><a href="sagemath-cookbook.html#cb40-75" tabindex="-1"></a><span class="cf">assert</span> h5 <span class="op">==</span> f<span class="op">^</span><span class="dv">5</span></span>
<span id="cb40-76"><a href="sagemath-cookbook.html#cb40-76" tabindex="-1"></a></span>
<span id="cb40-77"><a href="sagemath-cookbook.html#cb40-77" tabindex="-1"></a></span>
<span id="cb40-78"><a href="sagemath-cookbook.html#cb40-78" tabindex="-1"></a><span class="co"># membership in subgroup</span></span>
<span id="cb40-79"><a href="sagemath-cookbook.html#cb40-79" tabindex="-1"></a><span class="cf">assert</span> (f<span class="op">^</span><span class="dv">10</span> <span class="kw">in</span> H5)</span>
<span id="cb40-80"><a href="sagemath-cookbook.html#cb40-80" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span>(f<span class="op">^</span><span class="dv">8</span> <span class="kw">in</span> H5)</span></code></pre></div>
</div>
<div id="finite-fields-1" class="section level3 unnumbered hasAnchor">
<h3>Finite Fields<a href="sagemath-cookbook.html#finite-fields-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally we show how to work with finite fields. Recall that a field is a prime field (<span class="math inline">\(\mathbb{Z}_p\)</span> for a prime <span class="math inline">\(p\)</span>) or it is represented
by polynomials. In the second case, we can choose the formal variable symbol.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="sagemath-cookbook.html#cb41-1" tabindex="-1"></a><span class="co"># Define the prime field Z11</span></span>
<span id="cb41-2"><a href="sagemath-cookbook.html#cb41-2" tabindex="-1"></a>F11 <span class="op">=</span> GF(<span class="dv">11</span>) </span>
<span id="cb41-3"><a href="sagemath-cookbook.html#cb41-3" tabindex="-1"></a></span>
<span id="cb41-4"><a href="sagemath-cookbook.html#cb41-4" tabindex="-1"></a><span class="co"># Define the galois field 5^4</span></span>
<span id="cb41-5"><a href="sagemath-cookbook.html#cb41-5" tabindex="-1"></a><span class="co"># An optional argument can be given to define the variable name</span></span>
<span id="cb41-6"><a href="sagemath-cookbook.html#cb41-6" tabindex="-1"></a>F <span class="op">=</span> GF(<span class="dv">5</span><span class="op">^</span><span class="dv">4</span>, <span class="st">&#39;x&#39;</span>) </span>
<span id="cb41-7"><a href="sagemath-cookbook.html#cb41-7" tabindex="-1"></a></span>
<span id="cb41-8"><a href="sagemath-cookbook.html#cb41-8" tabindex="-1"></a><span class="co"># get the modulus used</span></span>
<span id="cb41-9"><a href="sagemath-cookbook.html#cb41-9" tabindex="-1"></a>F.modulus()</span>
<span id="cb41-10"><a href="sagemath-cookbook.html#cb41-10" tabindex="-1"></a></span>
<span id="cb41-11"><a href="sagemath-cookbook.html#cb41-11" tabindex="-1"></a><span class="co"># get additive and multiplicative generator</span></span>
<span id="cb41-12"><a href="sagemath-cookbook.html#cb41-12" tabindex="-1"></a>g_add <span class="op">=</span> F.gen()</span>
<span id="cb41-13"><a href="sagemath-cookbook.html#cb41-13" tabindex="-1"></a>g_mul <span class="op">=</span> F11.multiplicative_generator()</span>
<span id="cb41-14"><a href="sagemath-cookbook.html#cb41-14" tabindex="-1"></a></span>
<span id="cb41-15"><a href="sagemath-cookbook.html#cb41-15" tabindex="-1"></a></span>
<span id="cb41-16"><a href="sagemath-cookbook.html#cb41-16" tabindex="-1"></a><span class="co"># we can do the normal operations as usual</span></span>
<span id="cb41-17"><a href="sagemath-cookbook.html#cb41-17" tabindex="-1"></a>f1 <span class="op">=</span> <span class="bu">list</span>(F)[<span class="dv">2</span>]</span>
<span id="cb41-18"><a href="sagemath-cookbook.html#cb41-18" tabindex="-1"></a>f2 <span class="op">=</span> <span class="bu">list</span>(F)[<span class="dv">7</span>]</span>
<span id="cb41-19"><a href="sagemath-cookbook.html#cb41-19" tabindex="-1"></a>f3 <span class="op">=</span> <span class="bu">list</span>(F)[<span class="dv">10</span>]</span>
<span id="cb41-20"><a href="sagemath-cookbook.html#cb41-20" tabindex="-1"></a>f4 <span class="op">=</span> (f1 <span class="op">+</span> f2) <span class="op">*</span> f3<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>) </span>
<span id="cb41-21"><a href="sagemath-cookbook.html#cb41-21" tabindex="-1"></a></span>
<span id="cb41-22"><a href="sagemath-cookbook.html#cb41-22" tabindex="-1"></a><span class="co"># Define field elements. Note they are reduced mod F.modulus()</span></span>
<span id="cb41-23"><a href="sagemath-cookbook.html#cb41-23" tabindex="-1"></a>p <span class="op">=</span> F(<span class="st">&quot;x^10 + 3*x^2 + 1&quot;</span>)</span>
<span id="cb41-24"><a href="sagemath-cookbook.html#cb41-24" tabindex="-1"></a>q <span class="op">=</span> F(<span class="st">&quot;3*x^5 + 1&quot;</span>)</span>
<span id="cb41-25"><a href="sagemath-cookbook.html#cb41-25" tabindex="-1"></a>r <span class="op">=</span> p<span class="op">*</span>q <span class="op">+</span> f2<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb41-26"><a href="sagemath-cookbook.html#cb41-26" tabindex="-1"></a></span>
<span id="cb41-27"><a href="sagemath-cookbook.html#cb41-27" tabindex="-1"></a><span class="co"># additive and multiplicative order of elements</span></span>
<span id="cb41-28"><a href="sagemath-cookbook.html#cb41-28" tabindex="-1"></a>ord_f1 <span class="op">=</span> f1.order()</span>
<span id="cb41-29"><a href="sagemath-cookbook.html#cb41-29" tabindex="-1"></a>mord_f1 <span class="op">=</span> f1.multiplicative_order()</span>
<span id="cb41-30"><a href="sagemath-cookbook.html#cb41-30" tabindex="-1"></a></span>
<span id="cb41-31"><a href="sagemath-cookbook.html#cb41-31" tabindex="-1"></a><span class="co"># random element</span></span>
<span id="cb41-32"><a href="sagemath-cookbook.html#cb41-32" tabindex="-1"></a>frandom <span class="op">=</span> F.random_element()</span></code></pre></div>
</div>
</div>
<div id="polynomials" class="section level2 hasAnchor" number="17.6">
<h2><span class="header-section-number">E.6</span> Polynomials<a href="sagemath-cookbook.html#polynomials" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we show how to use sage to handle polynomials.</p>
<div id="basic-polynomials-operations" class="section level3 unnumbered hasAnchor">
<h3>Basic Polynomials Operations<a href="sagemath-cookbook.html#basic-polynomials-operations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We first show how to define and do basic operations on polynomials. Note that whenever you work with polynomials, you should define a
field over which the coefficients live, for example <span class="math inline">\(\mathbb{Z}_2\)</span> or <span class="math inline">\(\mathbb{R}\)</span>. For our use-cases, we will work with polynomials
with coefficients in <span class="math inline">\(\mathbb{Z}_p\)</span> for prime <span class="math inline">\(p\)</span>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="sagemath-cookbook.html#cb42-1" tabindex="-1"></a><span class="co"># Define the polynomial ring over a field</span></span>
<span id="cb42-2"><a href="sagemath-cookbook.html#cb42-2" tabindex="-1"></a><span class="co"># Here we define F_17[x] (polynomials over GF(17) with formal variable x)</span></span>
<span id="cb42-3"><a href="sagemath-cookbook.html#cb42-3" tabindex="-1"></a>R.<span class="op">&lt;</span>x<span class="op">&gt;</span> <span class="op">=</span> PolynomialRing(GF(<span class="dv">17</span>))</span>
<span id="cb42-4"><a href="sagemath-cookbook.html#cb42-4" tabindex="-1"></a></span>
<span id="cb42-5"><a href="sagemath-cookbook.html#cb42-5" tabindex="-1"></a>f <span class="op">=</span> x<span class="op">^</span><span class="dv">3</span> <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>x<span class="op">^</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb42-6"><a href="sagemath-cookbook.html#cb42-6" tabindex="-1"></a>g <span class="op">=</span> <span class="dv">4</span><span class="op">*</span>x<span class="op">^</span><span class="dv">4</span> <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>x <span class="op">+</span><span class="dv">6</span></span>
<span id="cb42-7"><a href="sagemath-cookbook.html#cb42-7" tabindex="-1"></a>h <span class="op">=</span> <span class="dv">8</span><span class="op">*</span>x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb42-8"><a href="sagemath-cookbook.html#cb42-8" tabindex="-1"></a></span>
<span id="cb42-9"><a href="sagemath-cookbook.html#cb42-9" tabindex="-1"></a></span>
<span id="cb42-10"><a href="sagemath-cookbook.html#cb42-10" tabindex="-1"></a><span class="co"># We can do operations as expected</span></span>
<span id="cb42-11"><a href="sagemath-cookbook.html#cb42-11" tabindex="-1"></a>p <span class="op">=</span> f<span class="op">^</span><span class="dv">2</span> <span class="op">-</span> g <span class="op">+</span> h<span class="op">*</span>g </span>
<span id="cb42-12"><a href="sagemath-cookbook.html#cb42-12" tabindex="-1"></a></span>
<span id="cb42-13"><a href="sagemath-cookbook.html#cb42-13" tabindex="-1"></a><span class="co"># We can also compute quotients and remainders</span></span>
<span id="cb42-14"><a href="sagemath-cookbook.html#cb42-14" tabindex="-1"></a>quot <span class="op">=</span> p<span class="op">//</span>h</span>
<span id="cb42-15"><a href="sagemath-cookbook.html#cb42-15" tabindex="-1"></a>rem <span class="op">=</span> p <span class="op">%</span> h</span>
<span id="cb42-16"><a href="sagemath-cookbook.html#cb42-16" tabindex="-1"></a><span class="cf">assert</span> p <span class="op">==</span> h <span class="op">*</span> quot <span class="op">+</span> rem</span>
<span id="cb42-17"><a href="sagemath-cookbook.html#cb42-17" tabindex="-1"></a></span>
<span id="cb42-18"><a href="sagemath-cookbook.html#cb42-18" tabindex="-1"></a><span class="co"># Evaluate a polynomial</span></span>
<span id="cb42-19"><a href="sagemath-cookbook.html#cb42-19" tabindex="-1"></a>v <span class="op">=</span> h(x<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb42-20"><a href="sagemath-cookbook.html#cb42-20" tabindex="-1"></a><span class="cf">assert</span> v <span class="op">==</span> (<span class="dv">8</span><span class="op">*</span><span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">17</span></span>
<span id="cb42-21"><a href="sagemath-cookbook.html#cb42-21" tabindex="-1"></a></span>
<span id="cb42-22"><a href="sagemath-cookbook.html#cb42-22" tabindex="-1"></a>q <span class="op">=</span> x<span class="op">^</span><span class="dv">2</span> <span class="op">-</span> <span class="dv">1</span></span></code></pre></div>
</div>
<div id="extended-euclidian-algorithm-for-polynomials" class="section level3 unnumbered hasAnchor">
<h3>Extended Euclidian Algorithm for Polynomials<a href="sagemath-cookbook.html#extended-euclidian-algorithm-for-polynomials" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We next show how to run the Extended Euclidian Algorithm on polynomials. Note that sage is clever enough to know how to do this on each own,
simply use the <code>xgcd</code> algorithm and give appropriate inputs. If the inputs are polynomials, it will run the polynomial version and if integers
the integer version!</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="sagemath-cookbook.html#cb43-1" tabindex="-1"></a><span class="co"># Define the polynomial ring over Integers </span></span>
<span id="cb43-2"><a href="sagemath-cookbook.html#cb43-2" tabindex="-1"></a>R.<span class="op">&lt;</span>x<span class="op">&gt;</span> <span class="op">=</span> PolynomialRing(ZZ)</span>
<span id="cb43-3"><a href="sagemath-cookbook.html#cb43-3" tabindex="-1"></a></span>
<span id="cb43-4"><a href="sagemath-cookbook.html#cb43-4" tabindex="-1"></a>p <span class="op">=</span> x<span class="op">^</span><span class="dv">8</span> <span class="op">+</span> <span class="dv">6</span><span class="op">*</span>x<span class="op">^</span><span class="dv">4</span> <span class="op">+</span> x</span>
<span id="cb43-5"><a href="sagemath-cookbook.html#cb43-5" tabindex="-1"></a>q <span class="op">=</span> <span class="dv">4</span><span class="op">*</span>x<span class="op">^</span><span class="dv">2</span></span>
<span id="cb43-6"><a href="sagemath-cookbook.html#cb43-6" tabindex="-1"></a></span>
<span id="cb43-7"><a href="sagemath-cookbook.html#cb43-7" tabindex="-1"></a><span class="co"># Find the greatest common divisor</span></span>
<span id="cb43-8"><a href="sagemath-cookbook.html#cb43-8" tabindex="-1"></a>d <span class="op">=</span> gcd(p, q)</span>
<span id="cb43-9"><a href="sagemath-cookbook.html#cb43-9" tabindex="-1"></a></span>
<span id="cb43-10"><a href="sagemath-cookbook.html#cb43-10" tabindex="-1"></a><span class="co"># Run the Extended Euclidian Algorithm</span></span>
<span id="cb43-11"><a href="sagemath-cookbook.html#cb43-11" tabindex="-1"></a>(dd, xx, yy) <span class="op">=</span> xgcd(p, q)</span>
<span id="cb43-12"><a href="sagemath-cookbook.html#cb43-12" tabindex="-1"></a><span class="cf">assert</span> dd <span class="op">==</span> xx<span class="op">*</span>p <span class="op">+</span> yy<span class="op">*</span>q</span></code></pre></div>
</div>
<div id="polynomial-interpolation-1" class="section level3 unnumbered hasAnchor">
<h3>Polynomial Interpolation<a href="sagemath-cookbook.html#polynomial-interpolation-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, we show how to interpolate polynomials. Recall this means finding the minimal degree polynomial that “crosses” a set of points.
We also show how to find Lagrange polynomials. This is interpolation over specific sets: given x coordinates, the <span class="math inline">\(i\)</span>-th Lagrange polynomial
is 0 in all the points except the <span class="math inline">\(i\)</span>-th, where it evaluates to 1.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="sagemath-cookbook.html#cb44-1" tabindex="-1"></a><span class="co"># Define the polynomial space</span></span>
<span id="cb44-2"><a href="sagemath-cookbook.html#cb44-2" tabindex="-1"></a>R <span class="op">=</span> PolynomialRing(GF(<span class="dv">17</span>), <span class="st">&#39;x&#39;</span>)</span>
<span id="cb44-3"><a href="sagemath-cookbook.html#cb44-3" tabindex="-1"></a></span>
<span id="cb44-4"><a href="sagemath-cookbook.html#cb44-4" tabindex="-1"></a><span class="co"># Define the set of points</span></span>
<span id="cb44-5"><a href="sagemath-cookbook.html#cb44-5" tabindex="-1"></a>points <span class="op">=</span> [(<span class="dv">5</span>,<span class="dv">1</span>), (<span class="dv">6</span>,<span class="dv">8</span>), (<span class="dv">9</span>,<span class="dv">12</span>)]</span>
<span id="cb44-6"><a href="sagemath-cookbook.html#cb44-6" tabindex="-1"></a></span>
<span id="cb44-7"><a href="sagemath-cookbook.html#cb44-7" tabindex="-1"></a><span class="co"># Find the interpolating polynomial</span></span>
<span id="cb44-8"><a href="sagemath-cookbook.html#cb44-8" tabindex="-1"></a>p <span class="op">=</span> R.lagrange_polynomial(points)</span>
<span id="cb44-9"><a href="sagemath-cookbook.html#cb44-9" tabindex="-1"></a></span>
<span id="cb44-10"><a href="sagemath-cookbook.html#cb44-10" tabindex="-1"></a><span class="co"># Verify the result</span></span>
<span id="cb44-11"><a href="sagemath-cookbook.html#cb44-11" tabindex="-1"></a>assert_cond <span class="op">=</span> (p.degree() <span class="op">&lt;</span> <span class="dv">3</span> <span class="kw">and</span> p(x<span class="op">=</span><span class="dv">5</span>) <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> p(x<span class="op">=</span><span class="dv">6</span>) <span class="op">==</span> <span class="dv">8</span> <span class="kw">and</span> p(x<span class="op">=</span><span class="dv">9</span>) <span class="op">==</span> <span class="dv">12</span>)</span>
<span id="cb44-12"><a href="sagemath-cookbook.html#cb44-12" tabindex="-1"></a><span class="cf">assert</span> assert_cond</span>
<span id="cb44-13"><a href="sagemath-cookbook.html#cb44-13" tabindex="-1"></a></span>
<span id="cb44-14"><a href="sagemath-cookbook.html#cb44-14" tabindex="-1"></a></span>
<span id="cb44-15"><a href="sagemath-cookbook.html#cb44-15" tabindex="-1"></a><span class="co"># Given a set of x coordinates, find the lagrange polynomials</span></span>
<span id="cb44-16"><a href="sagemath-cookbook.html#cb44-16" tabindex="-1"></a>x_coord <span class="op">=</span> [<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">9</span>]</span>
<span id="cb44-17"><a href="sagemath-cookbook.html#cb44-17" tabindex="-1"></a></span>
<span id="cb44-18"><a href="sagemath-cookbook.html#cb44-18" tabindex="-1"></a><span class="co"># l5</span></span>
<span id="cb44-19"><a href="sagemath-cookbook.html#cb44-19" tabindex="-1"></a>points <span class="op">=</span> [(<span class="dv">5</span>,<span class="dv">1</span>), (<span class="dv">6</span>,<span class="dv">0</span>), (<span class="dv">9</span>,<span class="dv">0</span>)]</span>
<span id="cb44-20"><a href="sagemath-cookbook.html#cb44-20" tabindex="-1"></a>l1 <span class="op">=</span> R.lagrange_polynomial(points)</span>
<span id="cb44-21"><a href="sagemath-cookbook.html#cb44-21" tabindex="-1"></a></span>
<span id="cb44-22"><a href="sagemath-cookbook.html#cb44-22" tabindex="-1"></a>points <span class="op">=</span> [(<span class="dv">5</span>,<span class="dv">0</span>), (<span class="dv">6</span>,<span class="dv">1</span>), (<span class="dv">9</span>,<span class="dv">0</span>)]</span>
<span id="cb44-23"><a href="sagemath-cookbook.html#cb44-23" tabindex="-1"></a>l2 <span class="op">=</span> R.lagrange_polynomial(points)</span>
<span id="cb44-24"><a href="sagemath-cookbook.html#cb44-24" tabindex="-1"></a></span>
<span id="cb44-25"><a href="sagemath-cookbook.html#cb44-25" tabindex="-1"></a>points <span class="op">=</span> [(<span class="dv">5</span>,<span class="dv">0</span>), (<span class="dv">6</span>,<span class="dv">0</span>), (<span class="dv">9</span>,<span class="dv">1</span>)]</span>
<span id="cb44-26"><a href="sagemath-cookbook.html#cb44-26" tabindex="-1"></a>l3 <span class="op">=</span> R.lagrange_polynomial(points)</span>
<span id="cb44-27"><a href="sagemath-cookbook.html#cb44-27" tabindex="-1"></a></span>
<span id="cb44-28"><a href="sagemath-cookbook.html#cb44-28" tabindex="-1"></a><span class="cf">assert</span> p <span class="op">==</span> l1 <span class="op">*</span> <span class="dv">1</span> <span class="op">+</span> l2 <span class="op">*</span> <span class="dv">8</span> <span class="op">+</span> l3 <span class="op">*</span> <span class="dv">12</span></span></code></pre></div>
</div>
</div>
<div id="rsa" class="section level2 hasAnchor" number="17.7">
<h2><span class="header-section-number">E.7</span> RSA<a href="sagemath-cookbook.html#rsa" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we present various recipes related to RSA. Note that some parts (for example choosing a modulus) are used in all of them.</p>
<div id="sampling-an-rsa-modulus" class="section level3 unnumbered hasAnchor">
<h3>Sampling an RSA Modulus<a href="sagemath-cookbook.html#sampling-an-rsa-modulus" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We first show how to sample an RSA modulus. This is basically sampling two fixed length prime number and multiplying them.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="sagemath-cookbook.html#cb45-1" tabindex="-1"></a><span class="co"># Define the security parameter (bits of the modulus)</span></span>
<span id="cb45-2"><a href="sagemath-cookbook.html#cb45-2" tabindex="-1"></a>secparam <span class="op">=</span> <span class="dv">2048</span></span>
<span id="cb45-3"><a href="sagemath-cookbook.html#cb45-3" tabindex="-1"></a></span>
<span id="cb45-4"><a href="sagemath-cookbook.html#cb45-4" tabindex="-1"></a><span class="co"># To achieve secparam modulus n = p*q, p and q must be secpara/2 bits long</span></span>
<span id="cb45-5"><a href="sagemath-cookbook.html#cb45-5" tabindex="-1"></a>prime_length <span class="op">=</span> secparam<span class="op">/</span><span class="dv">2</span> </span>
<span id="cb45-6"><a href="sagemath-cookbook.html#cb45-6" tabindex="-1"></a></span>
<span id="cb45-7"><a href="sagemath-cookbook.html#cb45-7" tabindex="-1"></a>lower_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(prime_length<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb45-8"><a href="sagemath-cookbook.html#cb45-8" tabindex="-1"></a>upper_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(prime_length)<span class="op">-</span><span class="dv">1</span></span>
<span id="cb45-9"><a href="sagemath-cookbook.html#cb45-9" tabindex="-1"></a></span>
<span id="cb45-10"><a href="sagemath-cookbook.html#cb45-10" tabindex="-1"></a>p <span class="op">=</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb45-11"><a href="sagemath-cookbook.html#cb45-11" tabindex="-1"></a>q <span class="op">=</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb45-12"><a href="sagemath-cookbook.html#cb45-12" tabindex="-1"></a></span>
<span id="cb45-13"><a href="sagemath-cookbook.html#cb45-13" tabindex="-1"></a>N <span class="op">=</span> p<span class="op">*</span>q</span></code></pre></div>
</div>
<div id="sampling-an-rsa-key-pair" class="section level3 unnumbered hasAnchor">
<h3>Sampling an RSA key-pair<a href="sagemath-cookbook.html#sampling-an-rsa-key-pair" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We next show how to sample a full RSA key-pair. We need to sample the modulus as before and additionally compute the <span class="math inline">\(e,d\)</span> pair of RSA.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="sagemath-cookbook.html#cb46-1" tabindex="-1"></a><span class="kw">def</span> rsa_keygen(secparam): </span>
<span id="cb46-2"><a href="sagemath-cookbook.html#cb46-2" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb46-3"><a href="sagemath-cookbook.html#cb46-3" tabindex="-1"></a><span class="co">  Takes the secparam and returns an RSA secret/public key pair</span></span>
<span id="cb46-4"><a href="sagemath-cookbook.html#cb46-4" tabindex="-1"></a></span>
<span id="cb46-5"><a href="sagemath-cookbook.html#cb46-5" tabindex="-1"></a><span class="co">  The output is given as two dictionaries:</span></span>
<span id="cb46-6"><a href="sagemath-cookbook.html#cb46-6" tabindex="-1"></a><span class="co">  sk = {&quot;p&quot;: p, &quot;q&quot;: q, &quot;d&quot;: d}</span></span>
<span id="cb46-7"><a href="sagemath-cookbook.html#cb46-7" tabindex="-1"></a><span class="co">  pk = {&quot;N&quot;: N, &quot;e&quot;: e}</span></span>
<span id="cb46-8"><a href="sagemath-cookbook.html#cb46-8" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb46-9"><a href="sagemath-cookbook.html#cb46-9" tabindex="-1"></a></span>
<span id="cb46-10"><a href="sagemath-cookbook.html#cb46-10" tabindex="-1"></a>  <span class="co"># Sample an RSA modulus</span></span>
<span id="cb46-11"><a href="sagemath-cookbook.html#cb46-11" tabindex="-1"></a>  prime_length <span class="op">=</span> secparam <span class="op">//</span> <span class="dv">2</span> </span>
<span id="cb46-12"><a href="sagemath-cookbook.html#cb46-12" tabindex="-1"></a></span>
<span id="cb46-13"><a href="sagemath-cookbook.html#cb46-13" tabindex="-1"></a>  lower_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(prime_length<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb46-14"><a href="sagemath-cookbook.html#cb46-14" tabindex="-1"></a>  upper_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(prime_length)<span class="op">-</span><span class="dv">1</span></span>
<span id="cb46-15"><a href="sagemath-cookbook.html#cb46-15" tabindex="-1"></a></span>
<span id="cb46-16"><a href="sagemath-cookbook.html#cb46-16" tabindex="-1"></a>  p <span class="op">=</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb46-17"><a href="sagemath-cookbook.html#cb46-17" tabindex="-1"></a>  q <span class="op">=</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb46-18"><a href="sagemath-cookbook.html#cb46-18" tabindex="-1"></a>  </span>
<span id="cb46-19"><a href="sagemath-cookbook.html#cb46-19" tabindex="-1"></a></span>
<span id="cb46-20"><a href="sagemath-cookbook.html#cb46-20" tabindex="-1"></a>  N <span class="op">=</span> p <span class="op">*</span> q</span>
<span id="cb46-21"><a href="sagemath-cookbook.html#cb46-21" tabindex="-1"></a></span>
<span id="cb46-22"><a href="sagemath-cookbook.html#cb46-22" tabindex="-1"></a>  <span class="co">#compute phi(N)</span></span>
<span id="cb46-23"><a href="sagemath-cookbook.html#cb46-23" tabindex="-1"></a>  phi <span class="op">=</span> (p <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> (q <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb46-24"><a href="sagemath-cookbook.html#cb46-24" tabindex="-1"></a></span>
<span id="cb46-25"><a href="sagemath-cookbook.html#cb46-25" tabindex="-1"></a>  <span class="co"># Sample a random e that is invertible mod phi_N. </span></span>
<span id="cb46-26"><a href="sagemath-cookbook.html#cb46-26" tabindex="-1"></a>  <span class="co"># One can also use other ways (e.g. e = 2^16 - 1)</span></span>
<span id="cb46-27"><a href="sagemath-cookbook.html#cb46-27" tabindex="-1"></a>  e <span class="op">=</span> randrange(<span class="dv">1</span>, N) </span>
<span id="cb46-28"><a href="sagemath-cookbook.html#cb46-28" tabindex="-1"></a>  <span class="cf">while</span> gcd(e, phi) <span class="op">!=</span> <span class="dv">1</span>:</span>
<span id="cb46-29"><a href="sagemath-cookbook.html#cb46-29" tabindex="-1"></a>    e <span class="op">=</span> randrange(<span class="dv">1</span>, N) </span>
<span id="cb46-30"><a href="sagemath-cookbook.html#cb46-30" tabindex="-1"></a></span>
<span id="cb46-31"><a href="sagemath-cookbook.html#cb46-31" tabindex="-1"></a>  d <span class="op">=</span> <span class="bu">pow</span>(e, <span class="op">-</span><span class="dv">1</span>, phi) </span>
<span id="cb46-32"><a href="sagemath-cookbook.html#cb46-32" tabindex="-1"></a></span>
<span id="cb46-33"><a href="sagemath-cookbook.html#cb46-33" tabindex="-1"></a>  <span class="co"># p, q are not actually needed</span></span>
<span id="cb46-34"><a href="sagemath-cookbook.html#cb46-34" tabindex="-1"></a>  sk <span class="op">=</span> {<span class="st">&quot;p&quot;</span>: p, <span class="st">&quot;q&quot;</span>: q, <span class="st">&quot;d&quot;</span>: d}</span>
<span id="cb46-35"><a href="sagemath-cookbook.html#cb46-35" tabindex="-1"></a>  pk <span class="op">=</span> {<span class="st">&quot;N&quot;</span>: N, <span class="st">&quot;e&quot;</span>: e}</span>
<span id="cb46-36"><a href="sagemath-cookbook.html#cb46-36" tabindex="-1"></a></span>
<span id="cb46-37"><a href="sagemath-cookbook.html#cb46-37" tabindex="-1"></a>  <span class="cf">return</span> (sk, pk)</span></code></pre></div>
</div>
<div id="textbook-rsa-encryption" class="section level3 unnumbered hasAnchor">
<h3>Textbook RSA Encryption<a href="sagemath-cookbook.html#textbook-rsa-encryption" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the next recipe we implement the “textbook” RSA encryption scheme. Recall that this is completely insecure (any deterministic encryption
scheme is!).</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="sagemath-cookbook.html#cb47-1" tabindex="-1"></a><span class="co"># We use the rsa_keygen.sage recipe </span></span>
<span id="cb47-2"><a href="sagemath-cookbook.html#cb47-2" tabindex="-1"></a>load(<span class="st">&#39;rsa_keygen.sage&#39;</span>)</span>
<span id="cb47-3"><a href="sagemath-cookbook.html#cb47-3" tabindex="-1"></a></span>
<span id="cb47-4"><a href="sagemath-cookbook.html#cb47-4" tabindex="-1"></a><span class="kw">def</span> textbook_rsa_encrypt(pk, message): </span>
<span id="cb47-5"><a href="sagemath-cookbook.html#cb47-5" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb47-6"><a href="sagemath-cookbook.html#cb47-6" tabindex="-1"></a><span class="co">  Encrypts an RSA message as m^e mod N. </span></span>
<span id="cb47-7"><a href="sagemath-cookbook.html#cb47-7" tabindex="-1"></a><span class="co">  The message must be an Integers(N) element.</span></span>
<span id="cb47-8"><a href="sagemath-cookbook.html#cb47-8" tabindex="-1"></a><span class="co">  We assume the pk is of the form output by rsa_keygen.</span></span>
<span id="cb47-9"><a href="sagemath-cookbook.html#cb47-9" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb47-10"><a href="sagemath-cookbook.html#cb47-10" tabindex="-1"></a></span>
<span id="cb47-11"><a href="sagemath-cookbook.html#cb47-11" tabindex="-1"></a>  <span class="cf">return</span> message<span class="op">^</span>(pk[<span class="st">&#39;e&#39;</span>])</span>
<span id="cb47-12"><a href="sagemath-cookbook.html#cb47-12" tabindex="-1"></a></span>
<span id="cb47-13"><a href="sagemath-cookbook.html#cb47-13" tabindex="-1"></a><span class="kw">def</span> textbook_rsa_decrypt(sk, ciphertext): </span>
<span id="cb47-14"><a href="sagemath-cookbook.html#cb47-14" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb47-15"><a href="sagemath-cookbook.html#cb47-15" tabindex="-1"></a><span class="co">  Decrypts an RSA ciphertext as c^d mod N.</span></span>
<span id="cb47-16"><a href="sagemath-cookbook.html#cb47-16" tabindex="-1"></a><span class="co">  The ciphertext must be an Integers(N) element.</span></span>
<span id="cb47-17"><a href="sagemath-cookbook.html#cb47-17" tabindex="-1"></a><span class="co">  We assume the sk is of the form output by rsa_keygen.</span></span>
<span id="cb47-18"><a href="sagemath-cookbook.html#cb47-18" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb47-19"><a href="sagemath-cookbook.html#cb47-19" tabindex="-1"></a></span>
<span id="cb47-20"><a href="sagemath-cookbook.html#cb47-20" tabindex="-1"></a>  <span class="cf">return</span> ciphertext<span class="op">^</span>(sk[<span class="st">&#39;d&#39;</span>])</span></code></pre></div>
<p>Here is how to use the above for encryption/decryption.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="sagemath-cookbook.html#cb48-1" tabindex="-1"></a><span class="co"># We use the textbook_rsa.sage recipe</span></span>
<span id="cb48-2"><a href="sagemath-cookbook.html#cb48-2" tabindex="-1"></a>load(<span class="st">&#39;textbook_rsa.sage&#39;</span>)</span>
<span id="cb48-3"><a href="sagemath-cookbook.html#cb48-3" tabindex="-1"></a></span>
<span id="cb48-4"><a href="sagemath-cookbook.html#cb48-4" tabindex="-1"></a><span class="co"># Create a key</span></span>
<span id="cb48-5"><a href="sagemath-cookbook.html#cb48-5" tabindex="-1"></a>sk, pk <span class="op">=</span> rsa_keygen(<span class="dv">2048</span>)</span>
<span id="cb48-6"><a href="sagemath-cookbook.html#cb48-6" tabindex="-1"></a></span>
<span id="cb48-7"><a href="sagemath-cookbook.html#cb48-7" tabindex="-1"></a><span class="co"># Define ZN</span></span>
<span id="cb48-8"><a href="sagemath-cookbook.html#cb48-8" tabindex="-1"></a>N <span class="op">=</span> pk[<span class="st">&#39;N&#39;</span>] </span>
<span id="cb48-9"><a href="sagemath-cookbook.html#cb48-9" tabindex="-1"></a>ZN <span class="op">=</span> Integers(N)</span>
<span id="cb48-10"><a href="sagemath-cookbook.html#cb48-10" tabindex="-1"></a></span>
<span id="cb48-11"><a href="sagemath-cookbook.html#cb48-11" tabindex="-1"></a><span class="co"># Define the message to be encrypted</span></span>
<span id="cb48-12"><a href="sagemath-cookbook.html#cb48-12" tabindex="-1"></a>m <span class="op">=</span> ZN(<span class="dv">42</span>)</span>
<span id="cb48-13"><a href="sagemath-cookbook.html#cb48-13" tabindex="-1"></a></span>
<span id="cb48-14"><a href="sagemath-cookbook.html#cb48-14" tabindex="-1"></a><span class="co"># encrypt</span></span>
<span id="cb48-15"><a href="sagemath-cookbook.html#cb48-15" tabindex="-1"></a>c <span class="op">=</span> textbook_rsa_encrypt(pk, m)</span>
<span id="cb48-16"><a href="sagemath-cookbook.html#cb48-16" tabindex="-1"></a></span>
<span id="cb48-17"><a href="sagemath-cookbook.html#cb48-17" tabindex="-1"></a><span class="co"># decrypt</span></span>
<span id="cb48-18"><a href="sagemath-cookbook.html#cb48-18" tabindex="-1"></a>m_prime <span class="op">=</span> textbook_rsa_decrypt(sk, c)</span>
<span id="cb48-19"><a href="sagemath-cookbook.html#cb48-19" tabindex="-1"></a></span>
<span id="cb48-20"><a href="sagemath-cookbook.html#cb48-20" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
<div id="rsa-fdh-signatures" class="section level3 unnumbered hasAnchor">
<h3>RSA-FDH Signatures<a href="sagemath-cookbook.html#rsa-fdh-signatures" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe implements RSA full domain hash signatures. We use the SHA256 from <code>hashlib</code> for the hash function.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="sagemath-cookbook.html#cb49-1" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb49-2"><a href="sagemath-cookbook.html#cb49-2" tabindex="-1"></a></span>
<span id="cb49-3"><a href="sagemath-cookbook.html#cb49-3" tabindex="-1"></a><span class="co"># We use the rsa_keygen.sage recipe to sample keys</span></span>
<span id="cb49-4"><a href="sagemath-cookbook.html#cb49-4" tabindex="-1"></a>load(<span class="st">&#39;rsa_keygen.sage&#39;</span>)</span>
<span id="cb49-5"><a href="sagemath-cookbook.html#cb49-5" tabindex="-1"></a></span>
<span id="cb49-6"><a href="sagemath-cookbook.html#cb49-6" tabindex="-1"></a><span class="kw">def</span> rsa_sign(sk, m): </span>
<span id="cb49-7"><a href="sagemath-cookbook.html#cb49-7" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb49-8"><a href="sagemath-cookbook.html#cb49-8" tabindex="-1"></a><span class="co">  Signs a message using RSA full domain hash with sha256 as the hash function.</span></span>
<span id="cb49-9"><a href="sagemath-cookbook.html#cb49-9" tabindex="-1"></a><span class="co">  The message m can be any string. </span></span>
<span id="cb49-10"><a href="sagemath-cookbook.html#cb49-10" tabindex="-1"></a><span class="co">  We assume the sk is of the form output by rsa_keygen.</span></span>
<span id="cb49-11"><a href="sagemath-cookbook.html#cb49-11" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb49-12"><a href="sagemath-cookbook.html#cb49-12" tabindex="-1"></a></span>
<span id="cb49-13"><a href="sagemath-cookbook.html#cb49-13" tabindex="-1"></a>  <span class="co"># hash the message</span></span>
<span id="cb49-14"><a href="sagemath-cookbook.html#cb49-14" tabindex="-1"></a>  digest <span class="op">=</span> hashlib.sha256(m.encode()).hexdigest()</span>
<span id="cb49-15"><a href="sagemath-cookbook.html#cb49-15" tabindex="-1"></a></span>
<span id="cb49-16"><a href="sagemath-cookbook.html#cb49-16" tabindex="-1"></a>  <span class="co"># convert the digest to an integer by reading it as a hex number </span></span>
<span id="cb49-17"><a href="sagemath-cookbook.html#cb49-17" tabindex="-1"></a>  digest <span class="op">=</span> <span class="bu">int</span>(<span class="st">&#39;0x&#39;</span><span class="op">+</span> digest, <span class="dv">16</span>)</span>
<span id="cb49-18"><a href="sagemath-cookbook.html#cb49-18" tabindex="-1"></a></span>
<span id="cb49-19"><a href="sagemath-cookbook.html#cb49-19" tabindex="-1"></a>  <span class="co"># and finally convert it to Zn element</span></span>
<span id="cb49-20"><a href="sagemath-cookbook.html#cb49-20" tabindex="-1"></a>  p, q <span class="op">=</span> sk[<span class="st">&#39;p&#39;</span>], sk[<span class="st">&#39;q&#39;</span>]</span>
<span id="cb49-21"><a href="sagemath-cookbook.html#cb49-21" tabindex="-1"></a></span>
<span id="cb49-22"><a href="sagemath-cookbook.html#cb49-22" tabindex="-1"></a>  <span class="co"># represent the number as a ZN element</span></span>
<span id="cb49-23"><a href="sagemath-cookbook.html#cb49-23" tabindex="-1"></a>  N <span class="op">=</span> p <span class="op">*</span> q </span>
<span id="cb49-24"><a href="sagemath-cookbook.html#cb49-24" tabindex="-1"></a>  ZN <span class="op">=</span> Integers(N)</span>
<span id="cb49-25"><a href="sagemath-cookbook.html#cb49-25" tabindex="-1"></a>  digest <span class="op">=</span> ZN(digest)</span>
<span id="cb49-26"><a href="sagemath-cookbook.html#cb49-26" tabindex="-1"></a></span>
<span id="cb49-27"><a href="sagemath-cookbook.html#cb49-27" tabindex="-1"></a>  d <span class="op">=</span> sk[<span class="st">&#39;d&#39;</span>]</span>
<span id="cb49-28"><a href="sagemath-cookbook.html#cb49-28" tabindex="-1"></a>  <span class="cf">return</span> digest<span class="op">^</span>d</span>
<span id="cb49-29"><a href="sagemath-cookbook.html#cb49-29" tabindex="-1"></a></span>
<span id="cb49-30"><a href="sagemath-cookbook.html#cb49-30" tabindex="-1"></a><span class="kw">def</span> rsa_verify(pk, m, signature): </span>
<span id="cb49-31"><a href="sagemath-cookbook.html#cb49-31" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb49-32"><a href="sagemath-cookbook.html#cb49-32" tabindex="-1"></a><span class="co">  Verifies a signature using RSA full domain hash with sha256 as the hash function.</span></span>
<span id="cb49-33"><a href="sagemath-cookbook.html#cb49-33" tabindex="-1"></a><span class="co">  The message m can be any string. </span></span>
<span id="cb49-34"><a href="sagemath-cookbook.html#cb49-34" tabindex="-1"></a><span class="co">  We assume the pk is of the form output by rsa_keygen.</span></span>
<span id="cb49-35"><a href="sagemath-cookbook.html#cb49-35" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb49-36"><a href="sagemath-cookbook.html#cb49-36" tabindex="-1"></a></span>
<span id="cb49-37"><a href="sagemath-cookbook.html#cb49-37" tabindex="-1"></a>  <span class="co"># hash the message</span></span>
<span id="cb49-38"><a href="sagemath-cookbook.html#cb49-38" tabindex="-1"></a>  digest <span class="op">=</span> hashlib.sha256(m.encode()).hexdigest()</span>
<span id="cb49-39"><a href="sagemath-cookbook.html#cb49-39" tabindex="-1"></a></span>
<span id="cb49-40"><a href="sagemath-cookbook.html#cb49-40" tabindex="-1"></a>  <span class="co"># convert the digest to an integer by reading it as a hex number </span></span>
<span id="cb49-41"><a href="sagemath-cookbook.html#cb49-41" tabindex="-1"></a>  digest <span class="op">=</span> <span class="bu">int</span>(<span class="st">&#39;0x&#39;</span><span class="op">+</span> digest, <span class="dv">16</span>)</span>
<span id="cb49-42"><a href="sagemath-cookbook.html#cb49-42" tabindex="-1"></a></span>
<span id="cb49-43"><a href="sagemath-cookbook.html#cb49-43" tabindex="-1"></a>  <span class="co"># and finally convert it to Zn element</span></span>
<span id="cb49-44"><a href="sagemath-cookbook.html#cb49-44" tabindex="-1"></a>  p, q <span class="op">=</span> sk[<span class="st">&#39;p&#39;</span>], sk[<span class="st">&#39;q&#39;</span>]</span>
<span id="cb49-45"><a href="sagemath-cookbook.html#cb49-45" tabindex="-1"></a>  N <span class="op">=</span> p <span class="op">*</span> q </span>
<span id="cb49-46"><a href="sagemath-cookbook.html#cb49-46" tabindex="-1"></a>  ZN <span class="op">=</span> Integers(N)</span>
<span id="cb49-47"><a href="sagemath-cookbook.html#cb49-47" tabindex="-1"></a>  digest <span class="op">=</span> ZN(digest)</span>
<span id="cb49-48"><a href="sagemath-cookbook.html#cb49-48" tabindex="-1"></a></span>
<span id="cb49-49"><a href="sagemath-cookbook.html#cb49-49" tabindex="-1"></a>  e <span class="op">=</span> pk[<span class="st">&#39;e&#39;</span>]</span>
<span id="cb49-50"><a href="sagemath-cookbook.html#cb49-50" tabindex="-1"></a>  <span class="cf">return</span> signature<span class="op">^</span>e <span class="op">==</span> digest</span></code></pre></div>
<p>Next we show how to use the above to sign messages and verify signatures.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="sagemath-cookbook.html#cb50-1" tabindex="-1"></a><span class="co"># We use the rsa_sha_signature.sage recipe to sample keys</span></span>
<span id="cb50-2"><a href="sagemath-cookbook.html#cb50-2" tabindex="-1"></a>load(<span class="st">&#39;rsa_sha256_signatures.sage&#39;</span>)</span>
<span id="cb50-3"><a href="sagemath-cookbook.html#cb50-3" tabindex="-1"></a></span>
<span id="cb50-4"><a href="sagemath-cookbook.html#cb50-4" tabindex="-1"></a><span class="co"># Create a key</span></span>
<span id="cb50-5"><a href="sagemath-cookbook.html#cb50-5" tabindex="-1"></a>sk, pk <span class="op">=</span> rsa_keygen(<span class="dv">2048</span>)</span>
<span id="cb50-6"><a href="sagemath-cookbook.html#cb50-6" tabindex="-1"></a></span>
<span id="cb50-7"><a href="sagemath-cookbook.html#cb50-7" tabindex="-1"></a>m <span class="op">=</span> <span class="st">&quot;&quot;&quot;This is a message whose authenticity is crucial. My ElGamal key is:</span></span>
<span id="cb50-8"><a href="sagemath-cookbook.html#cb50-8" tabindex="-1"></a><span class="st">({&#39;p&#39;: 8607589379706225605009318235670632502463991112012865771933407304935190017403,</span></span>
<span id="cb50-9"><a href="sagemath-cookbook.html#cb50-9" tabindex="-1"></a><span class="st">  &#39;q&#39;: 4303794689853112802504659117835316251231995556006432885966703652467595008701,</span></span>
<span id="cb50-10"><a href="sagemath-cookbook.html#cb50-10" tabindex="-1"></a><span class="st">  &#39;g&#39;: 3814814891600025220956964856350040994409974231368858236343451345844148462986,</span></span>
<span id="cb50-11"><a href="sagemath-cookbook.html#cb50-11" tabindex="-1"></a><span class="st">  &#39;h&#39;: 5088131483015987373087418941552710750500206632061904706006805181556567516887},</span></span>
<span id="cb50-12"><a href="sagemath-cookbook.html#cb50-12" tabindex="-1"></a><span class="st"> 3659275803126012824071303245940415271044329304500778431458890743996297880993)&quot;&quot;&quot;</span></span>
<span id="cb50-13"><a href="sagemath-cookbook.html#cb50-13" tabindex="-1"></a></span>
<span id="cb50-14"><a href="sagemath-cookbook.html#cb50-14" tabindex="-1"></a><span class="co"># sign</span></span>
<span id="cb50-15"><a href="sagemath-cookbook.html#cb50-15" tabindex="-1"></a>signature <span class="op">=</span> rsa_sign(sk, m)</span>
<span id="cb50-16"><a href="sagemath-cookbook.html#cb50-16" tabindex="-1"></a></span>
<span id="cb50-17"><a href="sagemath-cookbook.html#cb50-17" tabindex="-1"></a><span class="co"># verify </span></span>
<span id="cb50-18"><a href="sagemath-cookbook.html#cb50-18" tabindex="-1"></a>result <span class="op">=</span> rsa_verify(pk, m, signature)</span>
<span id="cb50-19"><a href="sagemath-cookbook.html#cb50-19" tabindex="-1"></a></span>
<span id="cb50-20"><a href="sagemath-cookbook.html#cb50-20" tabindex="-1"></a><span class="cf">assert</span> result </span></code></pre></div>
</div>
</div>
<div id="safe-prime-groups" class="section level2 hasAnchor" number="17.8">
<h2><span class="header-section-number">E.8</span> Safe Prime Groups<a href="sagemath-cookbook.html#safe-prime-groups" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we implement recipes to handle “safe prime” groups. Recall that these are subgroups of <span class="math inline">\(\mathbb{Z}_p^*\)</span> for p prime, which
have prime order <span class="math inline">\(q\)</span>. The relation between <span class="math inline">\(p,q\)</span> is <span class="math inline">\(p = kq+1\)</span> for some small <span class="math inline">\(k\)</span> (we always use <span class="math inline">\(k=2\)</span>).</p>
<div id="sampling-safe-primes" class="section level3 unnumbered hasAnchor">
<h3>Sampling Safe Primes<a href="sagemath-cookbook.html#sampling-safe-primes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to sample safe primes. We do this by simply sampling a prime <span class="math inline">\(q\)</span> and seeing if <span class="math inline">\(2q+1\)</span> is also a prime. We repeat until we find one.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="sagemath-cookbook.html#cb51-1" tabindex="-1"></a><span class="kw">def</span> sample_prime(length):</span>
<span id="cb51-2"><a href="sagemath-cookbook.html#cb51-2" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb51-3"><a href="sagemath-cookbook.html#cb51-3" tabindex="-1"></a><span class="co">  Samples a prime with length bits.  </span></span>
<span id="cb51-4"><a href="sagemath-cookbook.html#cb51-4" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb51-5"><a href="sagemath-cookbook.html#cb51-5" tabindex="-1"></a>  lower_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(length<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb51-6"><a href="sagemath-cookbook.html#cb51-6" tabindex="-1"></a>  upper_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(length)<span class="op">-</span><span class="dv">1</span></span>
<span id="cb51-7"><a href="sagemath-cookbook.html#cb51-7" tabindex="-1"></a></span>
<span id="cb51-8"><a href="sagemath-cookbook.html#cb51-8" tabindex="-1"></a>  <span class="cf">return</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb51-9"><a href="sagemath-cookbook.html#cb51-9" tabindex="-1"></a></span>
<span id="cb51-10"><a href="sagemath-cookbook.html#cb51-10" tabindex="-1"></a><span class="kw">def</span> sample_safe_prime(length):</span>
<span id="cb51-11"><a href="sagemath-cookbook.html#cb51-11" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb51-12"><a href="sagemath-cookbook.html#cb51-12" tabindex="-1"></a><span class="co">  Samples a prime number of the form p = 2q + 1 s.t. </span></span>
<span id="cb51-13"><a href="sagemath-cookbook.html#cb51-13" tabindex="-1"></a><span class="co">  q is also prime. p must have length bits.</span></span>
<span id="cb51-14"><a href="sagemath-cookbook.html#cb51-14" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb51-15"><a href="sagemath-cookbook.html#cb51-15" tabindex="-1"></a>  p <span class="op">=</span> sample_prime(length)</span>
<span id="cb51-16"><a href="sagemath-cookbook.html#cb51-16" tabindex="-1"></a>  <span class="cf">while</span> <span class="kw">not</span> (((p <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> <span class="dv">2</span>) <span class="kw">in</span> Primes()):</span>
<span id="cb51-17"><a href="sagemath-cookbook.html#cb51-17" tabindex="-1"></a>    p <span class="op">=</span> sample_prime(length)</span>
<span id="cb51-18"><a href="sagemath-cookbook.html#cb51-18" tabindex="-1"></a>  <span class="cf">return</span> p</span></code></pre></div>
<p>Next we show how to use the above recipe.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="sagemath-cookbook.html#cb52-1" tabindex="-1"></a><span class="co"># We use the safe_primes.sage recipe</span></span>
<span id="cb52-2"><a href="sagemath-cookbook.html#cb52-2" tabindex="-1"></a>load(<span class="st">&#39;safe_primes.sage&#39;</span>)</span>
<span id="cb52-3"><a href="sagemath-cookbook.html#cb52-3" tabindex="-1"></a></span>
<span id="cb52-4"><a href="sagemath-cookbook.html#cb52-4" tabindex="-1"></a>safe_prime <span class="op">=</span> sample_safe_prime(<span class="dv">128</span>)</span>
<span id="cb52-5"><a href="sagemath-cookbook.html#cb52-5" tabindex="-1"></a><span class="cf">assert</span> (safe_prime <span class="kw">in</span> Primes())</span>
<span id="cb52-6"><a href="sagemath-cookbook.html#cb52-6" tabindex="-1"></a></span>
<span id="cb52-7"><a href="sagemath-cookbook.html#cb52-7" tabindex="-1"></a>q <span class="op">=</span> (safe_prime <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb52-8"><a href="sagemath-cookbook.html#cb52-8" tabindex="-1"></a><span class="cf">assert</span> (q <span class="kw">in</span> Primes())</span></code></pre></div>
</div>
<div id="sampling-a-safe-prime-subgroup" class="section level3 unnumbered hasAnchor">
<h3>Sampling a safe prime subgroup<a href="sagemath-cookbook.html#sampling-a-safe-prime-subgroup" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe samples the actual subgroup defined by a safe prime. Note that we also need
to fix a generator g when defining the group. We represent the group by the tuple <span class="math inline">\((p, q, g)\)</span>, although
<span class="math inline">\(p\)</span> is actually not needed.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="sagemath-cookbook.html#cb53-1" tabindex="-1"></a><span class="kw">def</span> safeprime_group(sec_param):</span>
<span id="cb53-2"><a href="sagemath-cookbook.html#cb53-2" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb53-3"><a href="sagemath-cookbook.html#cb53-3" tabindex="-1"></a><span class="co">  Samples a group of prime order q, which is a subgroup of Zp for </span></span>
<span id="cb53-4"><a href="sagemath-cookbook.html#cb53-4" tabindex="-1"></a><span class="co">  p = 2q+1 and a generator.</span></span>
<span id="cb53-5"><a href="sagemath-cookbook.html#cb53-5" tabindex="-1"></a><span class="co">  The output contains a dictionary with the description </span></span>
<span id="cb53-6"><a href="sagemath-cookbook.html#cb53-6" tabindex="-1"></a><span class="co">  of the group and the subgroup and its generator</span></span>
<span id="cb53-7"><a href="sagemath-cookbook.html#cb53-7" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb53-8"><a href="sagemath-cookbook.html#cb53-8" tabindex="-1"></a></span>
<span id="cb53-9"><a href="sagemath-cookbook.html#cb53-9" tabindex="-1"></a>  <span class="co"># sample a safe prime</span></span>
<span id="cb53-10"><a href="sagemath-cookbook.html#cb53-10" tabindex="-1"></a>  lower_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(sec_param<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb53-11"><a href="sagemath-cookbook.html#cb53-11" tabindex="-1"></a>  upper_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(sec_param)<span class="op">-</span><span class="dv">1</span></span>
<span id="cb53-12"><a href="sagemath-cookbook.html#cb53-12" tabindex="-1"></a></span>
<span id="cb53-13"><a href="sagemath-cookbook.html#cb53-13" tabindex="-1"></a>  p <span class="op">=</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb53-14"><a href="sagemath-cookbook.html#cb53-14" tabindex="-1"></a>  <span class="cf">while</span> <span class="kw">not</span> (((p <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> <span class="dv">2</span>) <span class="kw">in</span> Primes()):</span>
<span id="cb53-15"><a href="sagemath-cookbook.html#cb53-15" tabindex="-1"></a>    p <span class="op">=</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb53-16"><a href="sagemath-cookbook.html#cb53-16" tabindex="-1"></a>  </span>
<span id="cb53-17"><a href="sagemath-cookbook.html#cb53-17" tabindex="-1"></a>  <span class="co"># Define the units mod p</span></span>
<span id="cb53-18"><a href="sagemath-cookbook.html#cb53-18" tabindex="-1"></a>  Zp <span class="op">=</span> Integers(p)</span>
<span id="cb53-19"><a href="sagemath-cookbook.html#cb53-19" tabindex="-1"></a></span>
<span id="cb53-20"><a href="sagemath-cookbook.html#cb53-20" tabindex="-1"></a>  <span class="co"># Sample random group elements until one has order q </span></span>
<span id="cb53-21"><a href="sagemath-cookbook.html#cb53-21" tabindex="-1"></a>  g <span class="op">=</span> Zp.random_element()</span>
<span id="cb53-22"><a href="sagemath-cookbook.html#cb53-22" tabindex="-1"></a>  q <span class="op">=</span> (p <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb53-23"><a href="sagemath-cookbook.html#cb53-23" tabindex="-1"></a>  <span class="cf">while</span> g.multiplicative_order() <span class="op">!=</span> q: </span>
<span id="cb53-24"><a href="sagemath-cookbook.html#cb53-24" tabindex="-1"></a>    g <span class="op">=</span> Zp.random_element()</span>
<span id="cb53-25"><a href="sagemath-cookbook.html#cb53-25" tabindex="-1"></a></span>
<span id="cb53-26"><a href="sagemath-cookbook.html#cb53-26" tabindex="-1"></a>  <span class="cf">return</span> {<span class="st">&#39;p&#39;</span>: p, <span class="st">&#39;q&#39;</span>: q, <span class="st">&#39;g&#39;</span>: g}</span></code></pre></div>
<p>Here is how to use the above to sample a group</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="sagemath-cookbook.html#cb54-1" tabindex="-1"></a><span class="co"># We use the sample_safeprime_group.sage recipe</span></span>
<span id="cb54-2"><a href="sagemath-cookbook.html#cb54-2" tabindex="-1"></a>load(<span class="st">&#39;sample_safeprime_group.sage&#39;</span>)</span>
<span id="cb54-3"><a href="sagemath-cookbook.html#cb54-3" tabindex="-1"></a></span>
<span id="cb54-4"><a href="sagemath-cookbook.html#cb54-4" tabindex="-1"></a><span class="co"># sample the groups</span></span>
<span id="cb54-5"><a href="sagemath-cookbook.html#cb54-5" tabindex="-1"></a>G <span class="op">=</span> safeprime_group(<span class="dv">256</span>)</span>
<span id="cb54-6"><a href="sagemath-cookbook.html#cb54-6" tabindex="-1"></a></span>
<span id="cb54-7"><a href="sagemath-cookbook.html#cb54-7" tabindex="-1"></a><span class="co"># access the elements p, q, g</span></span>
<span id="cb54-8"><a href="sagemath-cookbook.html#cb54-8" tabindex="-1"></a>p <span class="op">=</span> G[<span class="st">&#39;p&#39;</span>]</span>
<span id="cb54-9"><a href="sagemath-cookbook.html#cb54-9" tabindex="-1"></a>q <span class="op">=</span> G[<span class="st">&#39;q&#39;</span>]</span>
<span id="cb54-10"><a href="sagemath-cookbook.html#cb54-10" tabindex="-1"></a>g <span class="op">=</span> G[<span class="st">&#39;g&#39;</span>]</span></code></pre></div>
</div>
</div>
<div id="diffie-hellman-key-exchange" class="section level2 hasAnchor" number="17.9">
<h2><span class="header-section-number">E.9</span> Diffie Hellman Key Exchange<a href="sagemath-cookbook.html#diffie-hellman-key-exchange" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We next present the recipe for a Diffie Hellman key exchange over safe prime groups.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="sagemath-cookbook.html#cb55-1" tabindex="-1"></a><span class="co"># We use the sample_safeprime_group.sage recipe</span></span>
<span id="cb55-2"><a href="sagemath-cookbook.html#cb55-2" tabindex="-1"></a>load(<span class="st">&#39;sample_safeprime_group.sage&#39;</span>)</span>
<span id="cb55-3"><a href="sagemath-cookbook.html#cb55-3" tabindex="-1"></a></span>
<span id="cb55-4"><a href="sagemath-cookbook.html#cb55-4" tabindex="-1"></a></span>
<span id="cb55-5"><a href="sagemath-cookbook.html#cb55-5" tabindex="-1"></a><span class="kw">def</span> ddh_key_part(params): </span>
<span id="cb55-6"><a href="sagemath-cookbook.html#cb55-6" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb55-7"><a href="sagemath-cookbook.html#cb55-7" tabindex="-1"></a><span class="co">  Computes a random a and the public g^a.</span></span>
<span id="cb55-8"><a href="sagemath-cookbook.html#cb55-8" tabindex="-1"></a><span class="co">  params should contain the description of a safeprime group</span></span>
<span id="cb55-9"><a href="sagemath-cookbook.html#cb55-9" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb55-10"><a href="sagemath-cookbook.html#cb55-10" tabindex="-1"></a>  p, q, g <span class="op">=</span> (params[<span class="st">&#39;p&#39;</span>], params[<span class="st">&#39;q&#39;</span>], params[<span class="st">&#39;g&#39;</span>])</span>
<span id="cb55-11"><a href="sagemath-cookbook.html#cb55-11" tabindex="-1"></a>  Zp <span class="op">=</span> Integers(p)</span>
<span id="cb55-12"><a href="sagemath-cookbook.html#cb55-12" tabindex="-1"></a></span>
<span id="cb55-13"><a href="sagemath-cookbook.html#cb55-13" tabindex="-1"></a>  <span class="co"># secret part</span></span>
<span id="cb55-14"><a href="sagemath-cookbook.html#cb55-14" tabindex="-1"></a>  a <span class="op">=</span> randrange(<span class="dv">1</span>,q)</span>
<span id="cb55-15"><a href="sagemath-cookbook.html#cb55-15" tabindex="-1"></a></span>
<span id="cb55-16"><a href="sagemath-cookbook.html#cb55-16" tabindex="-1"></a>  A <span class="op">=</span> (g<span class="op">^</span>a)</span>
<span id="cb55-17"><a href="sagemath-cookbook.html#cb55-17" tabindex="-1"></a>  <span class="cf">return</span> (a, A)</span>
<span id="cb55-18"><a href="sagemath-cookbook.html#cb55-18" tabindex="-1"></a></span>
<span id="cb55-19"><a href="sagemath-cookbook.html#cb55-19" tabindex="-1"></a></span>
<span id="cb55-20"><a href="sagemath-cookbook.html#cb55-20" tabindex="-1"></a><span class="kw">def</span> ddh_final_key(params, a, B): </span>
<span id="cb55-21"><a href="sagemath-cookbook.html#cb55-21" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb55-22"><a href="sagemath-cookbook.html#cb55-22" tabindex="-1"></a><span class="co">  Given the secret part a and the recieved public part B computes the common key K=B^a</span></span>
<span id="cb55-23"><a href="sagemath-cookbook.html#cb55-23" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb55-24"><a href="sagemath-cookbook.html#cb55-24" tabindex="-1"></a></span>
<span id="cb55-25"><a href="sagemath-cookbook.html#cb55-25" tabindex="-1"></a>  p, q, g <span class="op">=</span> (params[<span class="st">&#39;p&#39;</span>], params[<span class="st">&#39;q&#39;</span>], params[<span class="st">&#39;g&#39;</span>])</span>
<span id="cb55-26"><a href="sagemath-cookbook.html#cb55-26" tabindex="-1"></a>  Zp <span class="op">=</span> Integers(p)</span>
<span id="cb55-27"><a href="sagemath-cookbook.html#cb55-27" tabindex="-1"></a></span>
<span id="cb55-28"><a href="sagemath-cookbook.html#cb55-28" tabindex="-1"></a>  <span class="cf">return</span> B<span class="op">^</span>a</span></code></pre></div>
<p>Next we show how Alice a Bob would use the above to agree on a common key.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="sagemath-cookbook.html#cb56-1" tabindex="-1"></a><span class="co"># We use the ddh.sage recipe</span></span>
<span id="cb56-2"><a href="sagemath-cookbook.html#cb56-2" tabindex="-1"></a>load(<span class="st">&#39;ddh.sage&#39;</span>)</span>
<span id="cb56-3"><a href="sagemath-cookbook.html#cb56-3" tabindex="-1"></a></span>
<span id="cb56-4"><a href="sagemath-cookbook.html#cb56-4" tabindex="-1"></a></span>
<span id="cb56-5"><a href="sagemath-cookbook.html#cb56-5" tabindex="-1"></a><span class="co"># Alice choses parameters and sends them to bob</span></span>
<span id="cb56-6"><a href="sagemath-cookbook.html#cb56-6" tabindex="-1"></a>params <span class="op">=</span> safeprime_group(<span class="dv">256</span>)</span>
<span id="cb56-7"><a href="sagemath-cookbook.html#cb56-7" tabindex="-1"></a></span>
<span id="cb56-8"><a href="sagemath-cookbook.html#cb56-8" tabindex="-1"></a><span class="co"># Alice computes (a, A=g^a) and sends A to Bob</span></span>
<span id="cb56-9"><a href="sagemath-cookbook.html#cb56-9" tabindex="-1"></a>(a, A) <span class="op">=</span> ddh_key_part(params)</span>
<span id="cb56-10"><a href="sagemath-cookbook.html#cb56-10" tabindex="-1"></a></span>
<span id="cb56-11"><a href="sagemath-cookbook.html#cb56-11" tabindex="-1"></a><span class="co"># Bob computes (b, B=g^b) and sends B to Alice</span></span>
<span id="cb56-12"><a href="sagemath-cookbook.html#cb56-12" tabindex="-1"></a>(b, B) <span class="op">=</span> ddh_key_part(params)</span>
<span id="cb56-13"><a href="sagemath-cookbook.html#cb56-13" tabindex="-1"></a></span>
<span id="cb56-14"><a href="sagemath-cookbook.html#cb56-14" tabindex="-1"></a><span class="co"># Alice computes the final key</span></span>
<span id="cb56-15"><a href="sagemath-cookbook.html#cb56-15" tabindex="-1"></a>K_alice <span class="op">=</span> B<span class="op">^</span>a</span>
<span id="cb56-16"><a href="sagemath-cookbook.html#cb56-16" tabindex="-1"></a></span>
<span id="cb56-17"><a href="sagemath-cookbook.html#cb56-17" tabindex="-1"></a><span class="co"># Bob computes the final key</span></span>
<span id="cb56-18"><a href="sagemath-cookbook.html#cb56-18" tabindex="-1"></a>K_bob <span class="op">=</span> A<span class="op">^</span>b</span>
<span id="cb56-19"><a href="sagemath-cookbook.html#cb56-19" tabindex="-1"></a></span>
<span id="cb56-20"><a href="sagemath-cookbook.html#cb56-20" tabindex="-1"></a><span class="cf">assert</span> K_alice <span class="op">==</span> K_bob </span></code></pre></div>
</div>
<div id="elgamal-over-safe-prime-groups" class="section level2 hasAnchor" number="17.10">
<h2><span class="header-section-number">E.10</span> ElGamal over Safe Prime Groups<a href="sagemath-cookbook.html#elgamal-over-safe-prime-groups" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section we present recipes for the two variants (normal and lifted) of ElGamal encryption scheme over
safe prime groups.</p>
<div id="sampling-elgamal-keys" class="section level3 unnumbered hasAnchor">
<h3>Sampling ElGamal Keys<a href="sagemath-cookbook.html#sampling-elgamal-keys" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, we show a recipe for creating an ElGamal key pair. This is as simple as sampling a safeprime group and
setting <span class="math inline">\((sk = x, pk = g^x)\)</span> for a random key.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="sagemath-cookbook.html#cb57-1" tabindex="-1"></a><span class="co"># We use the sample_safeprime_group.sage recipe to sample parameters</span></span>
<span id="cb57-2"><a href="sagemath-cookbook.html#cb57-2" tabindex="-1"></a>load(<span class="st">&#39;sample_safeprime_group.sage&#39;</span>)</span>
<span id="cb57-3"><a href="sagemath-cookbook.html#cb57-3" tabindex="-1"></a></span>
<span id="cb57-4"><a href="sagemath-cookbook.html#cb57-4" tabindex="-1"></a><span class="co"># Sampling of keys is the same for both ElGamal and lifted ElGamal</span></span>
<span id="cb57-5"><a href="sagemath-cookbook.html#cb57-5" tabindex="-1"></a><span class="kw">def</span> elgamal_keygen(sec_param):</span>
<span id="cb57-6"><a href="sagemath-cookbook.html#cb57-6" tabindex="-1"></a></span>
<span id="cb57-7"><a href="sagemath-cookbook.html#cb57-7" tabindex="-1"></a>  <span class="co"># sample the group</span></span>
<span id="cb57-8"><a href="sagemath-cookbook.html#cb57-8" tabindex="-1"></a>  params <span class="op">=</span> safeprime_group(<span class="dv">256</span>)</span>
<span id="cb57-9"><a href="sagemath-cookbook.html#cb57-9" tabindex="-1"></a></span>
<span id="cb57-10"><a href="sagemath-cookbook.html#cb57-10" tabindex="-1"></a>  (p, q, g) <span class="op">=</span> (params[<span class="st">&#39;p&#39;</span>], params[<span class="st">&#39;q&#39;</span>], params[<span class="st">&#39;g&#39;</span>])</span>
<span id="cb57-11"><a href="sagemath-cookbook.html#cb57-11" tabindex="-1"></a></span>
<span id="cb57-12"><a href="sagemath-cookbook.html#cb57-12" tabindex="-1"></a>  <span class="co"># secret key</span></span>
<span id="cb57-13"><a href="sagemath-cookbook.html#cb57-13" tabindex="-1"></a>  x <span class="op">=</span> randrange(<span class="dv">1</span>,q)</span>
<span id="cb57-14"><a href="sagemath-cookbook.html#cb57-14" tabindex="-1"></a></span>
<span id="cb57-15"><a href="sagemath-cookbook.html#cb57-15" tabindex="-1"></a>  <span class="co"># public key</span></span>
<span id="cb57-16"><a href="sagemath-cookbook.html#cb57-16" tabindex="-1"></a>  h <span class="op">=</span> g<span class="op">^</span>x</span>
<span id="cb57-17"><a href="sagemath-cookbook.html#cb57-17" tabindex="-1"></a></span>
<span id="cb57-18"><a href="sagemath-cookbook.html#cb57-18" tabindex="-1"></a>  pk <span class="op">=</span> {<span class="st">&#39;p&#39;</span>: p, <span class="st">&#39;q&#39;</span>: q, <span class="st">&#39;g&#39;</span>: g, <span class="st">&#39;h&#39;</span>: h } </span>
<span id="cb57-19"><a href="sagemath-cookbook.html#cb57-19" tabindex="-1"></a></span>
<span id="cb57-20"><a href="sagemath-cookbook.html#cb57-20" tabindex="-1"></a>  <span class="cf">return</span> (pk, x) </span></code></pre></div>
</div>
<div id="elgamal-encryption" class="section level3 unnumbered hasAnchor">
<h3>ElGamal Encryption<a href="sagemath-cookbook.html#elgamal-encryption" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the next recipe, we implement ElGamal over a same prime group.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="sagemath-cookbook.html#cb58-1" tabindex="-1"></a><span class="co"># We use the sample_elgamal_keys.sage recipe</span></span>
<span id="cb58-2"><a href="sagemath-cookbook.html#cb58-2" tabindex="-1"></a>load(<span class="st">&#39;sample_elgamal_keys.sage&#39;</span>)</span>
<span id="cb58-3"><a href="sagemath-cookbook.html#cb58-3" tabindex="-1"></a></span>
<span id="cb58-4"><a href="sagemath-cookbook.html#cb58-4" tabindex="-1"></a><span class="kw">def</span> elgamal_encrypt(pk, m): </span>
<span id="cb58-5"><a href="sagemath-cookbook.html#cb58-5" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb58-6"><a href="sagemath-cookbook.html#cb58-6" tabindex="-1"></a><span class="co">  Encrypts a message using ElGamal.</span></span>
<span id="cb58-7"><a href="sagemath-cookbook.html#cb58-7" tabindex="-1"></a><span class="co">  Takes as input the public key pk containing p,q,g,h where </span></span>
<span id="cb58-8"><a href="sagemath-cookbook.html#cb58-8" tabindex="-1"></a><span class="co">    - p, q are primes s.t. p = 2q + 1</span></span>
<span id="cb58-9"><a href="sagemath-cookbook.html#cb58-9" tabindex="-1"></a><span class="co">    - g is a generator of the q-size size subgroup of Zp</span></span>
<span id="cb58-10"><a href="sagemath-cookbook.html#cb58-10" tabindex="-1"></a><span class="co">    - h is an element of the subgroup</span></span>
<span id="cb58-11"><a href="sagemath-cookbook.html#cb58-11" tabindex="-1"></a><span class="co">  and the message m which is an element of the subgroup</span></span>
<span id="cb58-12"><a href="sagemath-cookbook.html#cb58-12" tabindex="-1"></a><span class="co">  We assume the pk is a dictionary as defined in sample_elgamal_keys.sage </span></span>
<span id="cb58-13"><a href="sagemath-cookbook.html#cb58-13" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb58-14"><a href="sagemath-cookbook.html#cb58-14" tabindex="-1"></a>  p, q, g, h <span class="op">=</span> (pk[<span class="st">&#39;p&#39;</span>], pk[<span class="st">&#39;q&#39;</span>], pk[<span class="st">&#39;g&#39;</span>], pk[<span class="st">&#39;h&#39;</span>])</span>
<span id="cb58-15"><a href="sagemath-cookbook.html#cb58-15" tabindex="-1"></a>  Zp <span class="op">=</span> Integers(p)</span>
<span id="cb58-16"><a href="sagemath-cookbook.html#cb58-16" tabindex="-1"></a></span>
<span id="cb58-17"><a href="sagemath-cookbook.html#cb58-17" tabindex="-1"></a>  <span class="co"># sample randomness</span></span>
<span id="cb58-18"><a href="sagemath-cookbook.html#cb58-18" tabindex="-1"></a>  r <span class="op">=</span> randrange(<span class="dv">1</span>,q)</span>
<span id="cb58-19"><a href="sagemath-cookbook.html#cb58-19" tabindex="-1"></a></span>
<span id="cb58-20"><a href="sagemath-cookbook.html#cb58-20" tabindex="-1"></a>  c <span class="op">=</span> (g<span class="op">^</span>r, m<span class="op">*</span>(h<span class="op">^</span>r))</span>
<span id="cb58-21"><a href="sagemath-cookbook.html#cb58-21" tabindex="-1"></a></span>
<span id="cb58-22"><a href="sagemath-cookbook.html#cb58-22" tabindex="-1"></a>  <span class="cf">return</span> c </span>
<span id="cb58-23"><a href="sagemath-cookbook.html#cb58-23" tabindex="-1"></a></span>
<span id="cb58-24"><a href="sagemath-cookbook.html#cb58-24" tabindex="-1"></a><span class="kw">def</span> elgamal_decrypt(sk, c): </span>
<span id="cb58-25"><a href="sagemath-cookbook.html#cb58-25" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb58-26"><a href="sagemath-cookbook.html#cb58-26" tabindex="-1"></a><span class="co">  Decrypts a ciphertext using ElGamal.</span></span>
<span id="cb58-27"><a href="sagemath-cookbook.html#cb58-27" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb58-28"><a href="sagemath-cookbook.html#cb58-28" tabindex="-1"></a>  <span class="co"># We get p by computing the additive order of c[0]. Alternatively,</span></span>
<span id="cb58-29"><a href="sagemath-cookbook.html#cb58-29" tabindex="-1"></a>  <span class="co"># we can add this information on sk or use the pk in the decryption.</span></span>
<span id="cb58-30"><a href="sagemath-cookbook.html#cb58-30" tabindex="-1"></a>  p <span class="op">=</span> c[<span class="dv">0</span>].additive_order()</span>
<span id="cb58-31"><a href="sagemath-cookbook.html#cb58-31" tabindex="-1"></a>  Zp <span class="op">=</span> Integers(p)</span>
<span id="cb58-32"><a href="sagemath-cookbook.html#cb58-32" tabindex="-1"></a></span>
<span id="cb58-33"><a href="sagemath-cookbook.html#cb58-33" tabindex="-1"></a>  c1, c2 <span class="op">=</span> c</span>
<span id="cb58-34"><a href="sagemath-cookbook.html#cb58-34" tabindex="-1"></a>  m <span class="op">=</span> c2<span class="op">*</span>c1<span class="op">^</span>(<span class="op">-</span>sk)</span>
<span id="cb58-35"><a href="sagemath-cookbook.html#cb58-35" tabindex="-1"></a>  <span class="cf">return</span> m </span></code></pre></div>
<p>Here is how one can use the above recipe to encrypt/decrypt using ElGamal.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="sagemath-cookbook.html#cb59-1" tabindex="-1"></a><span class="co"># We use the elgamal.sage recipe</span></span>
<span id="cb59-2"><a href="sagemath-cookbook.html#cb59-2" tabindex="-1"></a>load(<span class="st">&#39;elgamal.sage&#39;</span>)</span>
<span id="cb59-3"><a href="sagemath-cookbook.html#cb59-3" tabindex="-1"></a></span>
<span id="cb59-4"><a href="sagemath-cookbook.html#cb59-4" tabindex="-1"></a><span class="co"># Create an ElGamal key pair</span></span>
<span id="cb59-5"><a href="sagemath-cookbook.html#cb59-5" tabindex="-1"></a>(pk, sk) <span class="op">=</span> elgamal_keygen(<span class="dv">256</span>)</span>
<span id="cb59-6"><a href="sagemath-cookbook.html#cb59-6" tabindex="-1"></a></span>
<span id="cb59-7"><a href="sagemath-cookbook.html#cb59-7" tabindex="-1"></a><span class="co"># parse the public key</span></span>
<span id="cb59-8"><a href="sagemath-cookbook.html#cb59-8" tabindex="-1"></a>p, q, g, h <span class="op">=</span> (pk[<span class="st">&#39;p&#39;</span>], pk[<span class="st">&#39;q&#39;</span>], pk[<span class="st">&#39;g&#39;</span>], pk[<span class="st">&#39;h&#39;</span>])</span>
<span id="cb59-9"><a href="sagemath-cookbook.html#cb59-9" tabindex="-1"></a>Zp <span class="op">=</span> Integers(p)</span>
<span id="cb59-10"><a href="sagemath-cookbook.html#cb59-10" tabindex="-1"></a></span>
<span id="cb59-11"><a href="sagemath-cookbook.html#cb59-11" tabindex="-1"></a><span class="co"># sample a random message</span></span>
<span id="cb59-12"><a href="sagemath-cookbook.html#cb59-12" tabindex="-1"></a><span class="co"># recall the message should be a *subgroup* element</span></span>
<span id="cb59-13"><a href="sagemath-cookbook.html#cb59-13" tabindex="-1"></a>m <span class="op">=</span> Zp.random_element()</span>
<span id="cb59-14"><a href="sagemath-cookbook.html#cb59-14" tabindex="-1"></a><span class="cf">while</span> m.multiplicative_order() <span class="op">!=</span> q: </span>
<span id="cb59-15"><a href="sagemath-cookbook.html#cb59-15" tabindex="-1"></a>  m <span class="op">=</span> Zp.random_element()</span>
<span id="cb59-16"><a href="sagemath-cookbook.html#cb59-16" tabindex="-1"></a></span>
<span id="cb59-17"><a href="sagemath-cookbook.html#cb59-17" tabindex="-1"></a><span class="co"># encrypt the message  </span></span>
<span id="cb59-18"><a href="sagemath-cookbook.html#cb59-18" tabindex="-1"></a>c <span class="op">=</span> elgamal_encrypt(pk, m)</span>
<span id="cb59-19"><a href="sagemath-cookbook.html#cb59-19" tabindex="-1"></a></span>
<span id="cb59-20"><a href="sagemath-cookbook.html#cb59-20" tabindex="-1"></a><span class="co"># decrypt the message  </span></span>
<span id="cb59-21"><a href="sagemath-cookbook.html#cb59-21" tabindex="-1"></a>m_prime <span class="op">=</span> elgamal_decrypt(sk, c)</span>
<span id="cb59-22"><a href="sagemath-cookbook.html#cb59-22" tabindex="-1"></a></span>
<span id="cb59-23"><a href="sagemath-cookbook.html#cb59-23" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
<div id="lifted-elgamal-encryption" class="section level3 unnumbered hasAnchor">
<h3>Lifted ElGamal Encryption<a href="sagemath-cookbook.html#lifted-elgamal-encryption" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next we present the lifted version of ElGamal. Essentially, the only changes are that:
(1) the message is now a <span class="math inline">\(\mathbb{Z}_q\)</span> element in the exponent,
(2) the decryption needs to bruteforce over a known domain to find the discrete log.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="sagemath-cookbook.html#cb60-1" tabindex="-1"></a><span class="co"># We use the elgamal_keys.sage recipe</span></span>
<span id="cb60-2"><a href="sagemath-cookbook.html#cb60-2" tabindex="-1"></a>load(<span class="st">&#39;sample_elgamal_keys.sage&#39;</span>)</span>
<span id="cb60-3"><a href="sagemath-cookbook.html#cb60-3" tabindex="-1"></a></span>
<span id="cb60-4"><a href="sagemath-cookbook.html#cb60-4" tabindex="-1"></a><span class="kw">def</span> lifted_elgamal_encrypt(pk, m): </span>
<span id="cb60-5"><a href="sagemath-cookbook.html#cb60-5" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb60-6"><a href="sagemath-cookbook.html#cb60-6" tabindex="-1"></a><span class="co">  Encrypts a message using ElGamal.</span></span>
<span id="cb60-7"><a href="sagemath-cookbook.html#cb60-7" tabindex="-1"></a><span class="co">  Takes as input the public key pk containing p,q,g,h where </span></span>
<span id="cb60-8"><a href="sagemath-cookbook.html#cb60-8" tabindex="-1"></a><span class="co">    - p, q are primes s.t. p = 2q + 1</span></span>
<span id="cb60-9"><a href="sagemath-cookbook.html#cb60-9" tabindex="-1"></a><span class="co">    - g is a generator of the q-size size subgroup of Zp</span></span>
<span id="cb60-10"><a href="sagemath-cookbook.html#cb60-10" tabindex="-1"></a><span class="co">    - h is an element of the subgroup</span></span>
<span id="cb60-11"><a href="sagemath-cookbook.html#cb60-11" tabindex="-1"></a><span class="co">  and the message m which is an element of the subgroup</span></span>
<span id="cb60-12"><a href="sagemath-cookbook.html#cb60-12" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb60-13"><a href="sagemath-cookbook.html#cb60-13" tabindex="-1"></a>  p, q, g, h <span class="op">=</span> (pk[<span class="st">&#39;p&#39;</span>], pk[<span class="st">&#39;q&#39;</span>], pk[<span class="st">&#39;g&#39;</span>], pk[<span class="st">&#39;h&#39;</span>])</span>
<span id="cb60-14"><a href="sagemath-cookbook.html#cb60-14" tabindex="-1"></a>  Zp <span class="op">=</span> Integers(p)</span>
<span id="cb60-15"><a href="sagemath-cookbook.html#cb60-15" tabindex="-1"></a></span>
<span id="cb60-16"><a href="sagemath-cookbook.html#cb60-16" tabindex="-1"></a>  <span class="co"># sample randomness</span></span>
<span id="cb60-17"><a href="sagemath-cookbook.html#cb60-17" tabindex="-1"></a>  r <span class="op">=</span> randrange(<span class="dv">1</span>,q)</span>
<span id="cb60-18"><a href="sagemath-cookbook.html#cb60-18" tabindex="-1"></a></span>
<span id="cb60-19"><a href="sagemath-cookbook.html#cb60-19" tabindex="-1"></a>  c <span class="op">=</span> (g<span class="op">^</span>r, (g<span class="op">^</span>m)<span class="op">*</span>(h<span class="op">^</span>r))</span>
<span id="cb60-20"><a href="sagemath-cookbook.html#cb60-20" tabindex="-1"></a></span>
<span id="cb60-21"><a href="sagemath-cookbook.html#cb60-21" tabindex="-1"></a>  <span class="cf">return</span> c </span>
<span id="cb60-22"><a href="sagemath-cookbook.html#cb60-22" tabindex="-1"></a></span>
<span id="cb60-23"><a href="sagemath-cookbook.html#cb60-23" tabindex="-1"></a><span class="kw">def</span> lifted_elgamal_decrypt(sk, c, <span class="bu">list</span>): </span>
<span id="cb60-24"><a href="sagemath-cookbook.html#cb60-24" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb60-25"><a href="sagemath-cookbook.html#cb60-25" tabindex="-1"></a><span class="co">  Decrypts a ciphertext using lifted ElGamal.</span></span>
<span id="cb60-26"><a href="sagemath-cookbook.html#cb60-26" tabindex="-1"></a><span class="co">  It takes as additional input a list containing all the possible messages</span></span>
<span id="cb60-27"><a href="sagemath-cookbook.html#cb60-27" tabindex="-1"></a><span class="co">  on which it bruteforces.</span></span>
<span id="cb60-28"><a href="sagemath-cookbook.html#cb60-28" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb60-29"><a href="sagemath-cookbook.html#cb60-29" tabindex="-1"></a>  <span class="co"># We get p by computing the additive order of c[0] (=p). Alternatively,</span></span>
<span id="cb60-30"><a href="sagemath-cookbook.html#cb60-30" tabindex="-1"></a>  <span class="co"># we can add this information on sk or use the pk in the decryption.</span></span>
<span id="cb60-31"><a href="sagemath-cookbook.html#cb60-31" tabindex="-1"></a>  p <span class="op">=</span> c[<span class="dv">0</span>].additive_order()</span>
<span id="cb60-32"><a href="sagemath-cookbook.html#cb60-32" tabindex="-1"></a>  Zp <span class="op">=</span> Integers(p)</span>
<span id="cb60-33"><a href="sagemath-cookbook.html#cb60-33" tabindex="-1"></a></span>
<span id="cb60-34"><a href="sagemath-cookbook.html#cb60-34" tabindex="-1"></a>  (c1, c2) <span class="op">=</span> c</span>
<span id="cb60-35"><a href="sagemath-cookbook.html#cb60-35" tabindex="-1"></a>  g_pow_m <span class="op">=</span> c2<span class="op">*</span>c1<span class="op">^</span>(<span class="op">-</span>sk)</span>
<span id="cb60-36"><a href="sagemath-cookbook.html#cb60-36" tabindex="-1"></a></span>
<span id="cb60-37"><a href="sagemath-cookbook.html#cb60-37" tabindex="-1"></a>  <span class="co"># bruteforce to find the discrete logarithm</span></span>
<span id="cb60-38"><a href="sagemath-cookbook.html#cb60-38" tabindex="-1"></a>  <span class="cf">for</span> m <span class="kw">in</span> <span class="bu">list</span>: </span>
<span id="cb60-39"><a href="sagemath-cookbook.html#cb60-39" tabindex="-1"></a>    <span class="cf">if</span> g<span class="op">^</span>m <span class="op">==</span> g_pow_m:</span>
<span id="cb60-40"><a href="sagemath-cookbook.html#cb60-40" tabindex="-1"></a>      <span class="cf">return</span> m</span></code></pre></div>
<p>Here is how one can use the lifted version of ElGamal.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="sagemath-cookbook.html#cb61-1" tabindex="-1"></a><span class="co"># We use the lifted_elgamal_keys.sage recipe</span></span>
<span id="cb61-2"><a href="sagemath-cookbook.html#cb61-2" tabindex="-1"></a>load(<span class="st">&#39;lifted_elgamal.sage&#39;</span>)</span>
<span id="cb61-3"><a href="sagemath-cookbook.html#cb61-3" tabindex="-1"></a></span>
<span id="cb61-4"><a href="sagemath-cookbook.html#cb61-4" tabindex="-1"></a><span class="co"># Create an ElGamal key pair</span></span>
<span id="cb61-5"><a href="sagemath-cookbook.html#cb61-5" tabindex="-1"></a>(pk, sk) <span class="op">=</span> elgamal_keygen(<span class="dv">256</span>)</span>
<span id="cb61-6"><a href="sagemath-cookbook.html#cb61-6" tabindex="-1"></a></span>
<span id="cb61-7"><a href="sagemath-cookbook.html#cb61-7" tabindex="-1"></a><span class="co"># parse the public key</span></span>
<span id="cb61-8"><a href="sagemath-cookbook.html#cb61-8" tabindex="-1"></a>p, q, g, h <span class="op">=</span> (pk[<span class="st">&#39;p&#39;</span>], pk[<span class="st">&#39;q&#39;</span>], pk[<span class="st">&#39;g&#39;</span>], pk[<span class="st">&#39;h&#39;</span>])</span>
<span id="cb61-9"><a href="sagemath-cookbook.html#cb61-9" tabindex="-1"></a>Zp <span class="op">=</span> Integers(p)</span>
<span id="cb61-10"><a href="sagemath-cookbook.html#cb61-10" tabindex="-1"></a>Zq <span class="op">=</span> Integers(q)</span>
<span id="cb61-11"><a href="sagemath-cookbook.html#cb61-11" tabindex="-1"></a></span>
<span id="cb61-12"><a href="sagemath-cookbook.html#cb61-12" tabindex="-1"></a><span class="co"># define the possible messages to be [0..1000)</span></span>
<span id="cb61-13"><a href="sagemath-cookbook.html#cb61-13" tabindex="-1"></a>message_list <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1000</span>))</span>
<span id="cb61-14"><a href="sagemath-cookbook.html#cb61-14" tabindex="-1"></a></span>
<span id="cb61-15"><a href="sagemath-cookbook.html#cb61-15" tabindex="-1"></a><span class="co"># choose a random message. Recall the message should be a Zq element!</span></span>
<span id="cb61-16"><a href="sagemath-cookbook.html#cb61-16" tabindex="-1"></a>m <span class="op">=</span> Zq(randrange(<span class="dv">0</span>,<span class="dv">1000</span>))</span>
<span id="cb61-17"><a href="sagemath-cookbook.html#cb61-17" tabindex="-1"></a></span>
<span id="cb61-18"><a href="sagemath-cookbook.html#cb61-18" tabindex="-1"></a><span class="co"># encrypt the message  </span></span>
<span id="cb61-19"><a href="sagemath-cookbook.html#cb61-19" tabindex="-1"></a>c <span class="op">=</span> lifted_elgamal_encrypt(pk, m)</span>
<span id="cb61-20"><a href="sagemath-cookbook.html#cb61-20" tabindex="-1"></a></span>
<span id="cb61-21"><a href="sagemath-cookbook.html#cb61-21" tabindex="-1"></a><span class="co"># decrypt the message  </span></span>
<span id="cb61-22"><a href="sagemath-cookbook.html#cb61-22" tabindex="-1"></a>m_prime <span class="op">=</span> lifted_elgamal_decrypt(sk, c, message_list)</span>
<span id="cb61-23"><a href="sagemath-cookbook.html#cb61-23" tabindex="-1"></a></span>
<span id="cb61-24"><a href="sagemath-cookbook.html#cb61-24" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
</div>
<div id="elliptic-curve-cryptography-secp256k1-curve" class="section level2 hasAnchor" number="17.11">
<h2><span class="header-section-number">E.11</span> Elliptic Curve Cryptography: secp256k1 Curve<a href="sagemath-cookbook.html#elliptic-curve-cryptography-secp256k1-curve" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In these section we look into Elliptic Curve Cryptography. Specifically, we look into implementations over the
<a href="https://neuromancer.sk/std/secg/secp256k1">secp256k1 curve</a>. To understand the relevant recipes you need to keep in mind
two things:</p>
<ol style="list-style-type: decimal">
<li>The group defined by the curve is denoted additively,</li>
<li>The operations are <em>exactly the same</em> as the ones in safeprimes groups.</li>
</ol>
<p>This means that if one replaces the group operation of multiplication <span class="math inline">\(\mod p\)</span> in the DH protocol for example with
the group operation of the curve, one gets the DH protocol over the curve!</p>
<p>Keep in mind how notation changes:</p>
<ul>
<li>Multiplication becomes addition.</li>
<li>Exponentiation (many multiplications) becomes multiplication (many additions).</li>
<li>The “exponents” in <span class="math inline">\(\mathbb{Z}_q\)</span> remain in <span class="math inline">\(\mathbb{Z}_q\)</span> (the order of the group in both cases).</li>
<li>The subgroup elements of safeprimes (subset of <span class="math inline">\(\mathbb{Z}_p\)</span>) become points in the Elliptic Curve (pairs of elements of <span class="math inline">\(\mathbb{Z}_p\)</span> for
a different prime <span class="math inline">\(p\)</span>).</li>
</ul>
<p>Keep in mind that you <em>do not need to know how the group operation</em> works. You can simply forget about this and apply the operations correctly
to get the corresponding protocols.</p>
<div id="secp256k1-basic-operations" class="section level3 unnumbered hasAnchor">
<h3>secp256k1 Basic Operations<a href="sagemath-cookbook.html#secp256k1-basic-operations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe shows how to “sample” the curve. The sample is in quotations because the curve is actually fixed. You can find the
curve specifications <a href="https://neuromancer.sk/std/secg/secp256k1">here</a>.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="sagemath-cookbook.html#cb62-1" tabindex="-1"></a><span class="co"># secp256k1 is the elliptic curve defined by the equation </span></span>
<span id="cb62-2"><a href="sagemath-cookbook.html#cb62-2" tabindex="-1"></a><span class="co"># y^2 = x^3 + ax + b with a=0, b=7 over the prime field Fp </span></span>
<span id="cb62-3"><a href="sagemath-cookbook.html#cb62-3" tabindex="-1"></a><span class="co"># for p = 2^256 - 2^32 - 2^9 - 2^8 - 2^7 - 2^6 - 2^4 - 1</span></span>
<span id="cb62-4"><a href="sagemath-cookbook.html#cb62-4" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb62-5"><a href="sagemath-cookbook.html#cb62-5" tabindex="-1"></a><span class="co"># The curve contains the points (x, y) that satisfy the equation</span></span>
<span id="cb62-6"><a href="sagemath-cookbook.html#cb62-6" tabindex="-1"></a><span class="co"># y^2 = x^3 + ax + b over Fp</span></span>
<span id="cb62-7"><a href="sagemath-cookbook.html#cb62-7" tabindex="-1"></a><span class="co"># The number of these points are q for a prime q. This defines another</span></span>
<span id="cb62-8"><a href="sagemath-cookbook.html#cb62-8" tabindex="-1"></a><span class="co"># field Fq</span></span>
<span id="cb62-9"><a href="sagemath-cookbook.html#cb62-9" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb62-10"><a href="sagemath-cookbook.html#cb62-10" tabindex="-1"></a><span class="co"># - The field Fp (where the coordinates are defined) is called *base field*</span></span>
<span id="cb62-11"><a href="sagemath-cookbook.html#cb62-11" tabindex="-1"></a><span class="co"># - The field Fq is called *scalar field*</span></span>
<span id="cb62-12"><a href="sagemath-cookbook.html#cb62-12" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb62-13"><a href="sagemath-cookbook.html#cb62-13" tabindex="-1"></a><span class="co"># These points define an abelian group under elliptic curve addition operation</span></span>
<span id="cb62-14"><a href="sagemath-cookbook.html#cb62-14" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb62-15"><a href="sagemath-cookbook.html#cb62-15" tabindex="-1"></a><span class="co"># The specifications of the curve define the element</span></span>
<span id="cb62-16"><a href="sagemath-cookbook.html#cb62-16" tabindex="-1"></a><span class="co"># G= (</span></span>
<span id="cb62-17"><a href="sagemath-cookbook.html#cb62-17" tabindex="-1"></a><span class="co">#      0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798, </span></span>
<span id="cb62-18"><a href="sagemath-cookbook.html#cb62-18" tabindex="-1"></a><span class="co">#      0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8</span></span>
<span id="cb62-19"><a href="sagemath-cookbook.html#cb62-19" tabindex="-1"></a><span class="co">#    )</span></span>
<span id="cb62-20"><a href="sagemath-cookbook.html#cb62-20" tabindex="-1"></a><span class="co"># as the generator of the group. </span></span>
<span id="cb62-21"><a href="sagemath-cookbook.html#cb62-21" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb62-22"><a href="sagemath-cookbook.html#cb62-22" tabindex="-1"></a><span class="co"># The specifications of the curve can be found in </span></span>
<span id="cb62-23"><a href="sagemath-cookbook.html#cb62-23" tabindex="-1"></a><span class="co"># https://neuromancer.sk/std/secg/secp256k1</span></span>
<span id="cb62-24"><a href="sagemath-cookbook.html#cb62-24" tabindex="-1"></a></span>
<span id="cb62-25"><a href="sagemath-cookbook.html#cb62-25" tabindex="-1"></a><span class="kw">def</span> secp256k1_params(): </span>
<span id="cb62-26"><a href="sagemath-cookbook.html#cb62-26" tabindex="-1"></a></span>
<span id="cb62-27"><a href="sagemath-cookbook.html#cb62-27" tabindex="-1"></a>  <span class="co"># first define the base field Fp</span></span>
<span id="cb62-28"><a href="sagemath-cookbook.html#cb62-28" tabindex="-1"></a>  p <span class="op">=</span> <span class="dv">2</span><span class="op">^</span><span class="dv">256</span> <span class="op">-</span> <span class="dv">2</span><span class="op">^</span><span class="dv">32</span> <span class="op">-</span> <span class="dv">2</span><span class="op">^</span><span class="dv">9</span> <span class="op">-</span> <span class="dv">2</span><span class="op">^</span><span class="dv">8</span> <span class="op">-</span> <span class="dv">2</span><span class="op">^</span><span class="dv">7</span> <span class="op">-</span> <span class="dv">2</span><span class="op">^</span><span class="dv">6</span> <span class="op">-</span> <span class="dv">2</span><span class="op">^</span><span class="dv">4</span> <span class="op">-</span> <span class="dv">1</span> </span>
<span id="cb62-29"><a href="sagemath-cookbook.html#cb62-29" tabindex="-1"></a>  Fp <span class="op">=</span> GF(p)</span>
<span id="cb62-30"><a href="sagemath-cookbook.html#cb62-30" tabindex="-1"></a></span>
<span id="cb62-31"><a href="sagemath-cookbook.html#cb62-31" tabindex="-1"></a>  <span class="co"># we next define the elliptic curve </span></span>
<span id="cb62-32"><a href="sagemath-cookbook.html#cb62-32" tabindex="-1"></a>  E <span class="op">=</span> EllipticCurve(Fp, [<span class="dv">0</span>, <span class="dv">7</span>])</span>
<span id="cb62-33"><a href="sagemath-cookbook.html#cb62-33" tabindex="-1"></a></span>
<span id="cb62-34"><a href="sagemath-cookbook.html#cb62-34" tabindex="-1"></a>  <span class="co"># the scalar field contains the number of elements in the group (i.e. points)</span></span>
<span id="cb62-35"><a href="sagemath-cookbook.html#cb62-35" tabindex="-1"></a>  q <span class="op">=</span> E.order()</span>
<span id="cb62-36"><a href="sagemath-cookbook.html#cb62-36" tabindex="-1"></a></span>
<span id="cb62-37"><a href="sagemath-cookbook.html#cb62-37" tabindex="-1"></a>  <span class="co"># finally, we define the generator</span></span>
<span id="cb62-38"><a href="sagemath-cookbook.html#cb62-38" tabindex="-1"></a>  Gx <span class="op">=</span> <span class="bn">0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798</span></span>
<span id="cb62-39"><a href="sagemath-cookbook.html#cb62-39" tabindex="-1"></a>  Gy <span class="op">=</span> <span class="bn">0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8</span></span>
<span id="cb62-40"><a href="sagemath-cookbook.html#cb62-40" tabindex="-1"></a>  G <span class="op">=</span> E(Gx, Gy)</span>
<span id="cb62-41"><a href="sagemath-cookbook.html#cb62-41" tabindex="-1"></a></span>
<span id="cb62-42"><a href="sagemath-cookbook.html#cb62-42" tabindex="-1"></a>  <span class="cf">return</span> (E, p, q, G)</span></code></pre></div>
<p>We next show how to sample the curve and make basic operations on it.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="sagemath-cookbook.html#cb63-1" tabindex="-1"></a><span class="co"># We use the secp256k1.sage recipe</span></span>
<span id="cb63-2"><a href="sagemath-cookbook.html#cb63-2" tabindex="-1"></a>load(<span class="st">&#39;secp256k1.sage&#39;</span>)</span>
<span id="cb63-3"><a href="sagemath-cookbook.html#cb63-3" tabindex="-1"></a></span>
<span id="cb63-4"><a href="sagemath-cookbook.html#cb63-4" tabindex="-1"></a><span class="co"># Define the curve</span></span>
<span id="cb63-5"><a href="sagemath-cookbook.html#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="sagemath-cookbook.html#cb63-6" tabindex="-1"></a>(E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb63-7"><a href="sagemath-cookbook.html#cb63-7" tabindex="-1"></a></span>
<span id="cb63-8"><a href="sagemath-cookbook.html#cb63-8" tabindex="-1"></a><span class="co"># Let&#39;s first sample two random points by computing </span></span>
<span id="cb63-9"><a href="sagemath-cookbook.html#cb63-9" tabindex="-1"></a><span class="co"># xi and setting hi = xi g</span></span>
<span id="cb63-10"><a href="sagemath-cookbook.html#cb63-10" tabindex="-1"></a></span>
<span id="cb63-11"><a href="sagemath-cookbook.html#cb63-11" tabindex="-1"></a><span class="co"># scalars live in Fq </span></span>
<span id="cb63-12"><a href="sagemath-cookbook.html#cb63-12" tabindex="-1"></a>Fq <span class="op">=</span> GF(q)</span>
<span id="cb63-13"><a href="sagemath-cookbook.html#cb63-13" tabindex="-1"></a>x1 <span class="op">=</span> Fq.random_element()</span>
<span id="cb63-14"><a href="sagemath-cookbook.html#cb63-14" tabindex="-1"></a>x2 <span class="op">=</span> Fq.random_element()</span>
<span id="cb63-15"><a href="sagemath-cookbook.html#cb63-15" tabindex="-1"></a></span>
<span id="cb63-16"><a href="sagemath-cookbook.html#cb63-16" tabindex="-1"></a>h1 <span class="op">=</span> x1 <span class="op">*</span> g</span>
<span id="cb63-17"><a href="sagemath-cookbook.html#cb63-17" tabindex="-1"></a>h2 <span class="op">=</span> x2 <span class="op">*</span> g</span>
<span id="cb63-18"><a href="sagemath-cookbook.html#cb63-18" tabindex="-1"></a></span>
<span id="cb63-19"><a href="sagemath-cookbook.html#cb63-19" tabindex="-1"></a><span class="co"># Let&#39;s verify they are on curve</span></span>
<span id="cb63-20"><a href="sagemath-cookbook.html#cb63-20" tabindex="-1"></a><span class="cf">assert</span> h1 <span class="kw">in</span> E </span>
<span id="cb63-21"><a href="sagemath-cookbook.html#cb63-21" tabindex="-1"></a><span class="cf">assert</span> h2 <span class="kw">in</span> E </span>
<span id="cb63-22"><a href="sagemath-cookbook.html#cb63-22" tabindex="-1"></a></span>
<span id="cb63-23"><a href="sagemath-cookbook.html#cb63-23" tabindex="-1"></a></span>
<span id="cb63-24"><a href="sagemath-cookbook.html#cb63-24" tabindex="-1"></a><span class="co"># We can add group elements </span></span>
<span id="cb63-25"><a href="sagemath-cookbook.html#cb63-25" tabindex="-1"></a><span class="co"># this is &quot;equivalent&quot; to multiplying in safeprime groups</span></span>
<span id="cb63-26"><a href="sagemath-cookbook.html#cb63-26" tabindex="-1"></a>h3 <span class="op">=</span> h1 <span class="op">+</span> h2</span>
<span id="cb63-27"><a href="sagemath-cookbook.html#cb63-27" tabindex="-1"></a></span>
<span id="cb63-28"><a href="sagemath-cookbook.html#cb63-28" tabindex="-1"></a><span class="co"># and we we can do scalars operation </span></span>
<span id="cb63-29"><a href="sagemath-cookbook.html#cb63-29" tabindex="-1"></a><span class="co"># this is &quot;equivalent&quot; to exponentiation in safeprime groups</span></span>
<span id="cb63-30"><a href="sagemath-cookbook.html#cb63-30" tabindex="-1"></a>h4 <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> h3</span>
<span id="cb63-31"><a href="sagemath-cookbook.html#cb63-31" tabindex="-1"></a><span class="cf">assert</span> h4 <span class="op">==</span> h3 <span class="op">+</span> h3</span>
<span id="cb63-32"><a href="sagemath-cookbook.html#cb63-32" tabindex="-1"></a></span>
<span id="cb63-33"><a href="sagemath-cookbook.html#cb63-33" tabindex="-1"></a><span class="co"># We can also invert elements</span></span>
<span id="cb63-34"><a href="sagemath-cookbook.html#cb63-34" tabindex="-1"></a>h4inv <span class="op">=</span> <span class="op">-</span>h4</span>
<span id="cb63-35"><a href="sagemath-cookbook.html#cb63-35" tabindex="-1"></a></span>
<span id="cb63-36"><a href="sagemath-cookbook.html#cb63-36" tabindex="-1"></a><span class="co"># The identity element is the point in infinity.</span></span>
<span id="cb63-37"><a href="sagemath-cookbook.html#cb63-37" tabindex="-1"></a>e <span class="op">=</span> E(<span class="dv">0</span>)</span>
<span id="cb63-38"><a href="sagemath-cookbook.html#cb63-38" tabindex="-1"></a></span>
<span id="cb63-39"><a href="sagemath-cookbook.html#cb63-39" tabindex="-1"></a><span class="cf">assert</span> h4inv <span class="op">+</span> h4 <span class="op">==</span> e </span></code></pre></div>
</div>
<div id="diffie-hellman-key-exchange-over-secp256k1" class="section level3 unnumbered hasAnchor">
<h3>Diffie Hellman Key Exchange over secp256k1<a href="sagemath-cookbook.html#diffie-hellman-key-exchange-over-secp256k1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe implements the Diffie Hellman Key Exchange over secp256k1. Note that this is the same as in the
safeprime groups if one turns “multiplications” into “additions”.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="sagemath-cookbook.html#cb64-1" tabindex="-1"></a><span class="co"># This is ddh over secp256k1. It works exactly as the ddh in safeprime groups</span></span>
<span id="cb64-2"><a href="sagemath-cookbook.html#cb64-2" tabindex="-1"></a><span class="co"># except that we are in the group. </span></span>
<span id="cb64-3"><a href="sagemath-cookbook.html#cb64-3" tabindex="-1"></a></span>
<span id="cb64-4"><a href="sagemath-cookbook.html#cb64-4" tabindex="-1"></a><span class="co"># We use the secp256k1.sage recipe</span></span>
<span id="cb64-5"><a href="sagemath-cookbook.html#cb64-5" tabindex="-1"></a>load(<span class="st">&#39;secp256k1.sage&#39;</span>)</span>
<span id="cb64-6"><a href="sagemath-cookbook.html#cb64-6" tabindex="-1"></a></span>
<span id="cb64-7"><a href="sagemath-cookbook.html#cb64-7" tabindex="-1"></a><span class="co"># We don&#39;t need sample params, we get them ready by secp256k1 specs</span></span>
<span id="cb64-8"><a href="sagemath-cookbook.html#cb64-8" tabindex="-1"></a></span>
<span id="cb64-9"><a href="sagemath-cookbook.html#cb64-9" tabindex="-1"></a><span class="kw">def</span> secp256k1_ddh_key_part(): </span>
<span id="cb64-10"><a href="sagemath-cookbook.html#cb64-10" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb64-11"><a href="sagemath-cookbook.html#cb64-11" tabindex="-1"></a><span class="co">  Computes a random a in Fq and the public a*g.</span></span>
<span id="cb64-12"><a href="sagemath-cookbook.html#cb64-12" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb64-13"><a href="sagemath-cookbook.html#cb64-13" tabindex="-1"></a>  (E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb64-14"><a href="sagemath-cookbook.html#cb64-14" tabindex="-1"></a>  Fq <span class="op">=</span> GF(q)</span>
<span id="cb64-15"><a href="sagemath-cookbook.html#cb64-15" tabindex="-1"></a></span>
<span id="cb64-16"><a href="sagemath-cookbook.html#cb64-16" tabindex="-1"></a>  <span class="co"># secret part</span></span>
<span id="cb64-17"><a href="sagemath-cookbook.html#cb64-17" tabindex="-1"></a>  a <span class="op">=</span> Fq.random_element() </span>
<span id="cb64-18"><a href="sagemath-cookbook.html#cb64-18" tabindex="-1"></a></span>
<span id="cb64-19"><a href="sagemath-cookbook.html#cb64-19" tabindex="-1"></a>  A <span class="op">=</span> a<span class="op">*</span>g</span>
<span id="cb64-20"><a href="sagemath-cookbook.html#cb64-20" tabindex="-1"></a>  <span class="cf">return</span> (a, A)</span>
<span id="cb64-21"><a href="sagemath-cookbook.html#cb64-21" tabindex="-1"></a></span>
<span id="cb64-22"><a href="sagemath-cookbook.html#cb64-22" tabindex="-1"></a></span>
<span id="cb64-23"><a href="sagemath-cookbook.html#cb64-23" tabindex="-1"></a><span class="kw">def</span> secp256k1_ddh_final_key(a, B): </span>
<span id="cb64-24"><a href="sagemath-cookbook.html#cb64-24" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb64-25"><a href="sagemath-cookbook.html#cb64-25" tabindex="-1"></a><span class="co">  Given the secret part a and the recieved public part B computes the common key K=a*B</span></span>
<span id="cb64-26"><a href="sagemath-cookbook.html#cb64-26" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb64-27"><a href="sagemath-cookbook.html#cb64-27" tabindex="-1"></a></span>
<span id="cb64-28"><a href="sagemath-cookbook.html#cb64-28" tabindex="-1"></a>  <span class="cf">return</span> a<span class="op">*</span>B</span></code></pre></div>
<p>Next we show how Alice and Bob can use the above to agree on a key over the curve.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="sagemath-cookbook.html#cb65-1" tabindex="-1"></a><span class="co"># We use the secp256k1_ddh.sage recipe</span></span>
<span id="cb65-2"><a href="sagemath-cookbook.html#cb65-2" tabindex="-1"></a>load(<span class="st">&#39;secp256k1_ddh.sage&#39;</span>)</span>
<span id="cb65-3"><a href="sagemath-cookbook.html#cb65-3" tabindex="-1"></a></span>
<span id="cb65-4"><a href="sagemath-cookbook.html#cb65-4" tabindex="-1"></a><span class="co"># Alice computes (a, A=a*g) and sends A to Bob</span></span>
<span id="cb65-5"><a href="sagemath-cookbook.html#cb65-5" tabindex="-1"></a>(a, A) <span class="op">=</span> secp256k1_ddh_key_part()</span>
<span id="cb65-6"><a href="sagemath-cookbook.html#cb65-6" tabindex="-1"></a></span>
<span id="cb65-7"><a href="sagemath-cookbook.html#cb65-7" tabindex="-1"></a><span class="co"># Bob computes (b, B=b*g) and sends B to Alice</span></span>
<span id="cb65-8"><a href="sagemath-cookbook.html#cb65-8" tabindex="-1"></a>(b, B) <span class="op">=</span> secp256k1_ddh_key_part()</span>
<span id="cb65-9"><a href="sagemath-cookbook.html#cb65-9" tabindex="-1"></a></span>
<span id="cb65-10"><a href="sagemath-cookbook.html#cb65-10" tabindex="-1"></a><span class="co"># Alice computes the final key</span></span>
<span id="cb65-11"><a href="sagemath-cookbook.html#cb65-11" tabindex="-1"></a>K_alice <span class="op">=</span> a<span class="op">*</span>B</span>
<span id="cb65-12"><a href="sagemath-cookbook.html#cb65-12" tabindex="-1"></a></span>
<span id="cb65-13"><a href="sagemath-cookbook.html#cb65-13" tabindex="-1"></a><span class="co"># Bob computes the final key</span></span>
<span id="cb65-14"><a href="sagemath-cookbook.html#cb65-14" tabindex="-1"></a>K_bob <span class="op">=</span> b<span class="op">*</span>A</span>
<span id="cb65-15"><a href="sagemath-cookbook.html#cb65-15" tabindex="-1"></a></span>
<span id="cb65-16"><a href="sagemath-cookbook.html#cb65-16" tabindex="-1"></a><span class="cf">assert</span> K_alice <span class="op">==</span> K_bob </span></code></pre></div>
</div>
<div id="elgamal-encryption-over-secp256k1" class="section level3 unnumbered hasAnchor">
<h3>ElGamal Encryption over secp256k1<a href="sagemath-cookbook.html#elgamal-encryption-over-secp256k1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, we implement ElGamal over the curve. Again, this is implemented as ElGamal over safe prime groups, the only thing changing is the
group! One can similarly implement the lifted version. Recall that for this one should use bruteforce to do the final decryption.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="sagemath-cookbook.html#cb66-1" tabindex="-1"></a><span class="co"># We use the secp256k1.sage recipe</span></span>
<span id="cb66-2"><a href="sagemath-cookbook.html#cb66-2" tabindex="-1"></a>load(<span class="st">&#39;secp256k1.sage&#39;</span>)</span>
<span id="cb66-3"><a href="sagemath-cookbook.html#cb66-3" tabindex="-1"></a></span>
<span id="cb66-4"><a href="sagemath-cookbook.html#cb66-4" tabindex="-1"></a><span class="kw">def</span> secp256k1_elgamal_keygen():</span>
<span id="cb66-5"><a href="sagemath-cookbook.html#cb66-5" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb66-6"><a href="sagemath-cookbook.html#cb66-6" tabindex="-1"></a><span class="co">  samples the elgamal key. We don&#39;t need to take the security </span></span>
<span id="cb66-7"><a href="sagemath-cookbook.html#cb66-7" tabindex="-1"></a><span class="co">  parameter as input since we use a fixed curve</span></span>
<span id="cb66-8"><a href="sagemath-cookbook.html#cb66-8" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb66-9"><a href="sagemath-cookbook.html#cb66-9" tabindex="-1"></a></span>
<span id="cb66-10"><a href="sagemath-cookbook.html#cb66-10" tabindex="-1"></a>  <span class="co"># define the group</span></span>
<span id="cb66-11"><a href="sagemath-cookbook.html#cb66-11" tabindex="-1"></a>  (E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb66-12"><a href="sagemath-cookbook.html#cb66-12" tabindex="-1"></a></span>
<span id="cb66-13"><a href="sagemath-cookbook.html#cb66-13" tabindex="-1"></a>  <span class="co"># secret key</span></span>
<span id="cb66-14"><a href="sagemath-cookbook.html#cb66-14" tabindex="-1"></a>  Fq <span class="op">=</span> GF(q)</span>
<span id="cb66-15"><a href="sagemath-cookbook.html#cb66-15" tabindex="-1"></a>  x <span class="op">=</span> Fq.random_element() </span>
<span id="cb66-16"><a href="sagemath-cookbook.html#cb66-16" tabindex="-1"></a></span>
<span id="cb66-17"><a href="sagemath-cookbook.html#cb66-17" tabindex="-1"></a>  <span class="co"># public key</span></span>
<span id="cb66-18"><a href="sagemath-cookbook.html#cb66-18" tabindex="-1"></a>  h <span class="op">=</span> x<span class="op">*</span>g </span>
<span id="cb66-19"><a href="sagemath-cookbook.html#cb66-19" tabindex="-1"></a></span>
<span id="cb66-20"><a href="sagemath-cookbook.html#cb66-20" tabindex="-1"></a>  <span class="cf">return</span> (h, x) </span>
<span id="cb66-21"><a href="sagemath-cookbook.html#cb66-21" tabindex="-1"></a></span>
<span id="cb66-22"><a href="sagemath-cookbook.html#cb66-22" tabindex="-1"></a><span class="kw">def</span> secp256k1_elgamal_encrypt(pk, m): </span>
<span id="cb66-23"><a href="sagemath-cookbook.html#cb66-23" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb66-24"><a href="sagemath-cookbook.html#cb66-24" tabindex="-1"></a><span class="co">  Encrypts a message using ElGamal over secp256k1.</span></span>
<span id="cb66-25"><a href="sagemath-cookbook.html#cb66-25" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb66-26"><a href="sagemath-cookbook.html#cb66-26" tabindex="-1"></a></span>
<span id="cb66-27"><a href="sagemath-cookbook.html#cb66-27" tabindex="-1"></a>  <span class="co"># define the group</span></span>
<span id="cb66-28"><a href="sagemath-cookbook.html#cb66-28" tabindex="-1"></a>  (E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb66-29"><a href="sagemath-cookbook.html#cb66-29" tabindex="-1"></a></span>
<span id="cb66-30"><a href="sagemath-cookbook.html#cb66-30" tabindex="-1"></a>  <span class="co"># sample randomness</span></span>
<span id="cb66-31"><a href="sagemath-cookbook.html#cb66-31" tabindex="-1"></a>  <span class="co"># secret key</span></span>
<span id="cb66-32"><a href="sagemath-cookbook.html#cb66-32" tabindex="-1"></a>  Fq <span class="op">=</span> GF(q)</span>
<span id="cb66-33"><a href="sagemath-cookbook.html#cb66-33" tabindex="-1"></a>  r <span class="op">=</span> Fq.random_element() </span>
<span id="cb66-34"><a href="sagemath-cookbook.html#cb66-34" tabindex="-1"></a></span>
<span id="cb66-35"><a href="sagemath-cookbook.html#cb66-35" tabindex="-1"></a>  c <span class="op">=</span> (r<span class="op">*</span>g, r<span class="op">*</span>pk <span class="op">+</span> m)</span>
<span id="cb66-36"><a href="sagemath-cookbook.html#cb66-36" tabindex="-1"></a></span>
<span id="cb66-37"><a href="sagemath-cookbook.html#cb66-37" tabindex="-1"></a>  <span class="cf">return</span> c </span>
<span id="cb66-38"><a href="sagemath-cookbook.html#cb66-38" tabindex="-1"></a></span>
<span id="cb66-39"><a href="sagemath-cookbook.html#cb66-39" tabindex="-1"></a><span class="kw">def</span> secp256k1_elgamal_decrypt(sk, c): </span>
<span id="cb66-40"><a href="sagemath-cookbook.html#cb66-40" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb66-41"><a href="sagemath-cookbook.html#cb66-41" tabindex="-1"></a><span class="co">  Decrypts a ciphertext using ElGamal over secp256k1.</span></span>
<span id="cb66-42"><a href="sagemath-cookbook.html#cb66-42" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb66-43"><a href="sagemath-cookbook.html#cb66-43" tabindex="-1"></a></span>
<span id="cb66-44"><a href="sagemath-cookbook.html#cb66-44" tabindex="-1"></a>  c1, c2 <span class="op">=</span> c</span>
<span id="cb66-45"><a href="sagemath-cookbook.html#cb66-45" tabindex="-1"></a>  m <span class="op">=</span> c2<span class="op">-</span>sk<span class="op">*</span>c1</span>
<span id="cb66-46"><a href="sagemath-cookbook.html#cb66-46" tabindex="-1"></a>  <span class="cf">return</span> m </span></code></pre></div>
<p>We next show how encryption and decryption works.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="sagemath-cookbook.html#cb67-1" tabindex="-1"></a><span class="co"># We use the secp256k1_elgamal.sage recipe</span></span>
<span id="cb67-2"><a href="sagemath-cookbook.html#cb67-2" tabindex="-1"></a>load(<span class="st">&#39;secp256k1_elgamal.sage&#39;</span>)</span>
<span id="cb67-3"><a href="sagemath-cookbook.html#cb67-3" tabindex="-1"></a></span>
<span id="cb67-4"><a href="sagemath-cookbook.html#cb67-4" tabindex="-1"></a><span class="co"># Define the curve</span></span>
<span id="cb67-5"><a href="sagemath-cookbook.html#cb67-5" tabindex="-1"></a>(E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb67-6"><a href="sagemath-cookbook.html#cb67-6" tabindex="-1"></a></span>
<span id="cb67-7"><a href="sagemath-cookbook.html#cb67-7" tabindex="-1"></a><span class="co"># Create an ElGamal key pair</span></span>
<span id="cb67-8"><a href="sagemath-cookbook.html#cb67-8" tabindex="-1"></a>(pk, sk) <span class="op">=</span> secp256k1_elgamal_keygen()</span>
<span id="cb67-9"><a href="sagemath-cookbook.html#cb67-9" tabindex="-1"></a></span>
<span id="cb67-10"><a href="sagemath-cookbook.html#cb67-10" tabindex="-1"></a><span class="co"># sample a random message</span></span>
<span id="cb67-11"><a href="sagemath-cookbook.html#cb67-11" tabindex="-1"></a><span class="co"># the message in a curve element</span></span>
<span id="cb67-12"><a href="sagemath-cookbook.html#cb67-12" tabindex="-1"></a>m <span class="op">=</span> <span class="dv">42</span><span class="op">*</span>g</span>
<span id="cb67-13"><a href="sagemath-cookbook.html#cb67-13" tabindex="-1"></a></span>
<span id="cb67-14"><a href="sagemath-cookbook.html#cb67-14" tabindex="-1"></a><span class="co"># encrypt the message  </span></span>
<span id="cb67-15"><a href="sagemath-cookbook.html#cb67-15" tabindex="-1"></a>c <span class="op">=</span> secp256k1_elgamal_encrypt(pk, m)</span>
<span id="cb67-16"><a href="sagemath-cookbook.html#cb67-16" tabindex="-1"></a></span>
<span id="cb67-17"><a href="sagemath-cookbook.html#cb67-17" tabindex="-1"></a><span class="co"># decrypt the message  </span></span>
<span id="cb67-18"><a href="sagemath-cookbook.html#cb67-18" tabindex="-1"></a>m_prime <span class="op">=</span> secp256k1_elgamal_decrypt(sk, c)</span>
<span id="cb67-19"><a href="sagemath-cookbook.html#cb67-19" tabindex="-1"></a></span>
<span id="cb67-20"><a href="sagemath-cookbook.html#cb67-20" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
</div>
<div id="secret-sharing-2" class="section level2 hasAnchor" number="17.12">
<h2><span class="header-section-number">E.12</span> Secret Sharing<a href="sagemath-cookbook.html#secret-sharing-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we present implementations for the two variants of secret sharing we have seen.</p>
<div id="simple-secret-sharing" class="section level3 unnumbered hasAnchor">
<h3>Simple Secret Sharing<a href="sagemath-cookbook.html#simple-secret-sharing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, we implement the simple secret sharing (share <span class="math inline">\(s\)</span> as <span class="math inline">\(s_1, s\oplus s_1\)</span> for a random <span class="math inline">\(s_1\)</span>).</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="sagemath-cookbook.html#cb68-1" tabindex="-1"></a><span class="kw">def</span> simple_share(s): </span>
<span id="cb68-2"><a href="sagemath-cookbook.html#cb68-2" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb68-3"><a href="sagemath-cookbook.html#cb68-3" tabindex="-1"></a><span class="co">  Shares a secret s to 2 parties s.t. both need to </span></span>
<span id="cb68-4"><a href="sagemath-cookbook.html#cb68-4" tabindex="-1"></a><span class="co">  collaborate to reconstruct. The secret is a string.</span></span>
<span id="cb68-5"><a href="sagemath-cookbook.html#cb68-5" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb68-6"><a href="sagemath-cookbook.html#cb68-6" tabindex="-1"></a></span>
<span id="cb68-7"><a href="sagemath-cookbook.html#cb68-7" tabindex="-1"></a>  <span class="co"># convert the secret to bytes</span></span>
<span id="cb68-8"><a href="sagemath-cookbook.html#cb68-8" tabindex="-1"></a>  s_encoded <span class="op">=</span> s.encode()</span>
<span id="cb68-9"><a href="sagemath-cookbook.html#cb68-9" tabindex="-1"></a></span>
<span id="cb68-10"><a href="sagemath-cookbook.html#cb68-10" tabindex="-1"></a>  <span class="co"># get the length of the secret</span></span>
<span id="cb68-11"><a href="sagemath-cookbook.html#cb68-11" tabindex="-1"></a>  length <span class="op">=</span> <span class="bu">len</span>(s_encoded)</span>
<span id="cb68-12"><a href="sagemath-cookbook.html#cb68-12" tabindex="-1"></a></span>
<span id="cb68-13"><a href="sagemath-cookbook.html#cb68-13" tabindex="-1"></a>  <span class="co"># sample random bytes of the same length as s. This is the first share</span></span>
<span id="cb68-14"><a href="sagemath-cookbook.html#cb68-14" tabindex="-1"></a>  s1 <span class="op">=</span> <span class="st">b&#39;&#39;</span>.join(randrange(<span class="dv">0</span>,<span class="dv">256</span>).to_bytes() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(length))</span>
<span id="cb68-15"><a href="sagemath-cookbook.html#cb68-15" tabindex="-1"></a></span>
<span id="cb68-16"><a href="sagemath-cookbook.html#cb68-16" tabindex="-1"></a>  <span class="co"># create the second share as s XOR s1</span></span>
<span id="cb68-17"><a href="sagemath-cookbook.html#cb68-17" tabindex="-1"></a>  s2 <span class="op">=</span> <span class="bu">bytes</span>(x <span class="op">^^</span> y <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(s1, s_encoded))</span>
<span id="cb68-18"><a href="sagemath-cookbook.html#cb68-18" tabindex="-1"></a></span>
<span id="cb68-19"><a href="sagemath-cookbook.html#cb68-19" tabindex="-1"></a>  <span class="cf">return</span> (s1, s2)</span>
<span id="cb68-20"><a href="sagemath-cookbook.html#cb68-20" tabindex="-1"></a>  </span>
<span id="cb68-21"><a href="sagemath-cookbook.html#cb68-21" tabindex="-1"></a><span class="kw">def</span> simple_reconstruct(s1, s2):</span>
<span id="cb68-22"><a href="sagemath-cookbook.html#cb68-22" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb68-23"><a href="sagemath-cookbook.html#cb68-23" tabindex="-1"></a><span class="co">  Reconstructs a shared secret. It takes the </span></span>
<span id="cb68-24"><a href="sagemath-cookbook.html#cb68-24" tabindex="-1"></a><span class="co">  shares (byte streams) of both parties and gets the secret </span></span>
<span id="cb68-25"><a href="sagemath-cookbook.html#cb68-25" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb68-26"><a href="sagemath-cookbook.html#cb68-26" tabindex="-1"></a>  s_encoded <span class="op">=</span>  <span class="bu">bytes</span>(x <span class="op">^^</span> y <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(s1, s2))</span>
<span id="cb68-27"><a href="sagemath-cookbook.html#cb68-27" tabindex="-1"></a>  <span class="cf">return</span> s_encoded.decode()</span></code></pre></div>
<p>We showcase next the above by sharing our secret message.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="sagemath-cookbook.html#cb69-1" tabindex="-1"></a><span class="co"># We use the simple_secret_sharing.sage recipe</span></span>
<span id="cb69-2"><a href="sagemath-cookbook.html#cb69-2" tabindex="-1"></a>load(<span class="st">&#39;simple_secret_sharing.sage&#39;</span>)</span>
<span id="cb69-3"><a href="sagemath-cookbook.html#cb69-3" tabindex="-1"></a></span>
<span id="cb69-4"><a href="sagemath-cookbook.html#cb69-4" tabindex="-1"></a><span class="co"># Choose a secret</span></span>
<span id="cb69-5"><a href="sagemath-cookbook.html#cb69-5" tabindex="-1"></a>s <span class="op">=</span> <span class="st">&quot;The secret number is 42.&quot;</span> </span>
<span id="cb69-6"><a href="sagemath-cookbook.html#cb69-6" tabindex="-1"></a></span>
<span id="cb69-7"><a href="sagemath-cookbook.html#cb69-7" tabindex="-1"></a><span class="co"># share to the parties</span></span>
<span id="cb69-8"><a href="sagemath-cookbook.html#cb69-8" tabindex="-1"></a>(s1, s2) <span class="op">=</span> simple_share(s)</span>
<span id="cb69-9"><a href="sagemath-cookbook.html#cb69-9" tabindex="-1"></a></span>
<span id="cb69-10"><a href="sagemath-cookbook.html#cb69-10" tabindex="-1"></a><span class="co"># reconstruct </span></span>
<span id="cb69-11"><a href="sagemath-cookbook.html#cb69-11" tabindex="-1"></a>s_prime <span class="op">=</span> simple_reconstruct(s1, s2)</span>
<span id="cb69-12"><a href="sagemath-cookbook.html#cb69-12" tabindex="-1"></a></span>
<span id="cb69-13"><a href="sagemath-cookbook.html#cb69-13" tabindex="-1"></a><span class="cf">assert</span> s <span class="op">==</span> s_prime</span></code></pre></div>
</div>
<div id="shamir-secret-sharing" class="section level3 unnumbered hasAnchor">
<h3>Shamir Secret Sharing<a href="sagemath-cookbook.html#shamir-secret-sharing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next recipe implements Shamir’s secret sharing scheme. It would be useful to recall the polynomial recipes before
looking into the next one.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="sagemath-cookbook.html#cb70-1" tabindex="-1"></a><span class="kw">def</span> shamir_share(F, s, t, n): </span>
<span id="cb70-2"><a href="sagemath-cookbook.html#cb70-2" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb70-3"><a href="sagemath-cookbook.html#cb70-3" tabindex="-1"></a><span class="co">  Shares a secret s over field F. t &lt;= n is the threshold.</span></span>
<span id="cb70-4"><a href="sagemath-cookbook.html#cb70-4" tabindex="-1"></a><span class="co">  The public points used are always 1, ..., n</span></span>
<span id="cb70-5"><a href="sagemath-cookbook.html#cb70-5" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb70-6"><a href="sagemath-cookbook.html#cb70-6" tabindex="-1"></a></span>
<span id="cb70-7"><a href="sagemath-cookbook.html#cb70-7" tabindex="-1"></a>  <span class="co"># Choose a random polynomial of degree t-1 </span></span>
<span id="cb70-8"><a href="sagemath-cookbook.html#cb70-8" tabindex="-1"></a>  <span class="co"># We do this by sampling t-1 random coefficients </span></span>
<span id="cb70-9"><a href="sagemath-cookbook.html#cb70-9" tabindex="-1"></a>  coeff <span class="op">=</span> <span class="bu">list</span>(F.random_element() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(t<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb70-10"><a href="sagemath-cookbook.html#cb70-10" tabindex="-1"></a></span>
<span id="cb70-11"><a href="sagemath-cookbook.html#cb70-11" tabindex="-1"></a>  <span class="co"># Define the polynomial space</span></span>
<span id="cb70-12"><a href="sagemath-cookbook.html#cb70-12" tabindex="-1"></a>  R.<span class="op">&lt;</span>x<span class="op">&gt;</span> <span class="op">=</span> PolynomialRing(F)</span>
<span id="cb70-13"><a href="sagemath-cookbook.html#cb70-13" tabindex="-1"></a>   </span>
<span id="cb70-14"><a href="sagemath-cookbook.html#cb70-14" tabindex="-1"></a>  <span class="co"># construct the polynomial</span></span>
<span id="cb70-15"><a href="sagemath-cookbook.html#cb70-15" tabindex="-1"></a>  p <span class="op">=</span> s</span>
<span id="cb70-16"><a href="sagemath-cookbook.html#cb70-16" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(t<span class="op">-</span><span class="dv">1</span>): </span>
<span id="cb70-17"><a href="sagemath-cookbook.html#cb70-17" tabindex="-1"></a>    p <span class="op">+=</span> coeff[i] <span class="op">*</span> (x<span class="op">^</span>(i<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb70-18"><a href="sagemath-cookbook.html#cb70-18" tabindex="-1"></a></span>
<span id="cb70-19"><a href="sagemath-cookbook.html#cb70-19" tabindex="-1"></a>  <span class="co"># evaluate the polynomial at every point 1,...,n</span></span>
<span id="cb70-20"><a href="sagemath-cookbook.html#cb70-20" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">list</span>((i, p(x<span class="op">=</span>i)) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb70-21"><a href="sagemath-cookbook.html#cb70-21" tabindex="-1"></a></span>
<span id="cb70-22"><a href="sagemath-cookbook.html#cb70-22" tabindex="-1"></a><span class="kw">def</span> shamir_reconstruct(F, points):</span>
<span id="cb70-23"><a href="sagemath-cookbook.html#cb70-23" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb70-24"><a href="sagemath-cookbook.html#cb70-24" tabindex="-1"></a><span class="co">  Reconstructs a shared secret over field F. It takes the </span></span>
<span id="cb70-25"><a href="sagemath-cookbook.html#cb70-25" tabindex="-1"></a><span class="co">  shares (points) of enough parties and gets the secret </span></span>
<span id="cb70-26"><a href="sagemath-cookbook.html#cb70-26" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb70-27"><a href="sagemath-cookbook.html#cb70-27" tabindex="-1"></a></span>
<span id="cb70-28"><a href="sagemath-cookbook.html#cb70-28" tabindex="-1"></a>  <span class="co"># Define the polynomial space</span></span>
<span id="cb70-29"><a href="sagemath-cookbook.html#cb70-29" tabindex="-1"></a>  R.<span class="op">&lt;</span>x<span class="op">&gt;</span> <span class="op">=</span> PolynomialRing(F)</span>
<span id="cb70-30"><a href="sagemath-cookbook.html#cb70-30" tabindex="-1"></a></span>
<span id="cb70-31"><a href="sagemath-cookbook.html#cb70-31" tabindex="-1"></a>  <span class="co"># interpolate points to find the polynomial</span></span>
<span id="cb70-32"><a href="sagemath-cookbook.html#cb70-32" tabindex="-1"></a>  p <span class="op">=</span> R.lagrange_polynomial(points)</span>
<span id="cb70-33"><a href="sagemath-cookbook.html#cb70-33" tabindex="-1"></a></span>
<span id="cb70-34"><a href="sagemath-cookbook.html#cb70-34" tabindex="-1"></a>  <span class="co"># evaluate at 0 to learn the secret</span></span>
<span id="cb70-35"><a href="sagemath-cookbook.html#cb70-35" tabindex="-1"></a>  <span class="cf">return</span> p(x<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div>
<p>We next show how to share a secret using this scheme.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="sagemath-cookbook.html#cb71-1" tabindex="-1"></a><span class="co"># We use the shamir_secret_sharing.sage recipe</span></span>
<span id="cb71-2"><a href="sagemath-cookbook.html#cb71-2" tabindex="-1"></a>load(<span class="st">&#39;shamir_secret_sharing.sage&#39;</span>)</span>
<span id="cb71-3"><a href="sagemath-cookbook.html#cb71-3" tabindex="-1"></a></span>
<span id="cb71-4"><a href="sagemath-cookbook.html#cb71-4" tabindex="-1"></a><span class="co"># Define a field </span></span>
<span id="cb71-5"><a href="sagemath-cookbook.html#cb71-5" tabindex="-1"></a>bit_length <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb71-6"><a href="sagemath-cookbook.html#cb71-6" tabindex="-1"></a></span>
<span id="cb71-7"><a href="sagemath-cookbook.html#cb71-7" tabindex="-1"></a></span>
<span id="cb71-8"><a href="sagemath-cookbook.html#cb71-8" tabindex="-1"></a>lower_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(bit_length<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb71-9"><a href="sagemath-cookbook.html#cb71-9" tabindex="-1"></a>upper_bound <span class="op">=</span> <span class="dv">2</span><span class="op">^</span>(bit_length)<span class="op">-</span><span class="dv">1</span></span>
<span id="cb71-10"><a href="sagemath-cookbook.html#cb71-10" tabindex="-1"></a>p <span class="op">=</span> random_prime(lower_bound, upper_bound)</span>
<span id="cb71-11"><a href="sagemath-cookbook.html#cb71-11" tabindex="-1"></a>F <span class="op">=</span> GF(p)</span>
<span id="cb71-12"><a href="sagemath-cookbook.html#cb71-12" tabindex="-1"></a></span>
<span id="cb71-13"><a href="sagemath-cookbook.html#cb71-13" tabindex="-1"></a><span class="co"># sample a random secret</span></span>
<span id="cb71-14"><a href="sagemath-cookbook.html#cb71-14" tabindex="-1"></a>s <span class="op">=</span> F.random_element()</span>
<span id="cb71-15"><a href="sagemath-cookbook.html#cb71-15" tabindex="-1"></a></span>
<span id="cb71-16"><a href="sagemath-cookbook.html#cb71-16" tabindex="-1"></a><span class="co"># share to 10 parties s.t. at least 4 are needed to reconstruct</span></span>
<span id="cb71-17"><a href="sagemath-cookbook.html#cb71-17" tabindex="-1"></a>shares <span class="op">=</span> shamir_share(F, s, <span class="dv">4</span>, <span class="dv">10</span>)</span>
<span id="cb71-18"><a href="sagemath-cookbook.html#cb71-18" tabindex="-1"></a></span>
<span id="cb71-19"><a href="sagemath-cookbook.html#cb71-19" tabindex="-1"></a><span class="co"># parties 4, 7, 9, 10 try to reconstruct the secret</span></span>
<span id="cb71-20"><a href="sagemath-cookbook.html#cb71-20" tabindex="-1"></a><span class="co"># recall we have points 1, 2, ... 10 but we count from 0</span></span>
<span id="cb71-21"><a href="sagemath-cookbook.html#cb71-21" tabindex="-1"></a>points <span class="op">=</span> [shares[<span class="dv">3</span>], shares[<span class="dv">6</span>], shares[<span class="dv">8</span>], shares[<span class="dv">9</span>]]</span>
<span id="cb71-22"><a href="sagemath-cookbook.html#cb71-22" tabindex="-1"></a></span>
<span id="cb71-23"><a href="sagemath-cookbook.html#cb71-23" tabindex="-1"></a>s_prime <span class="op">=</span> shamir_reconstruct(F, points)</span>
<span id="cb71-24"><a href="sagemath-cookbook.html#cb71-24" tabindex="-1"></a><span class="cf">assert</span> s <span class="op">==</span> s_prime</span></code></pre></div>
</div>
</div>
<div id="threshold-cryptography" class="section level2 hasAnchor" number="17.13">
<h2><span class="header-section-number">E.13</span> Threshold Cryptography<a href="sagemath-cookbook.html#threshold-cryptography" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this subsection we combine Shamir’s secret sharing with ElGamal encryption to implement threshold ElGamal
over safe prime groups. Try to make them work over secp256k1!</p>
<div id="threshold-elgamal" class="section level3 unnumbered hasAnchor">
<h3>Threshold ElGamal<a href="sagemath-cookbook.html#threshold-elgamal" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We next present the threshold ElGamal recipe. Note how the parties do not need to reconstruct the secret key to decrypt.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="sagemath-cookbook.html#cb72-1" tabindex="-1"></a><span class="co"># We use the elgamal.sage and shamir_secret_sharing.sage recipes. </span></span>
<span id="cb72-2"><a href="sagemath-cookbook.html#cb72-2" tabindex="-1"></a><span class="co"># Recall that encryption is exactly as ElGamal</span></span>
<span id="cb72-3"><a href="sagemath-cookbook.html#cb72-3" tabindex="-1"></a>load(<span class="st">&#39;shamir_secret_sharing.sage&#39;</span>)</span>
<span id="cb72-4"><a href="sagemath-cookbook.html#cb72-4" tabindex="-1"></a>load(<span class="st">&#39;elgamal.sage&#39;</span>)</span>
<span id="cb72-5"><a href="sagemath-cookbook.html#cb72-5" tabindex="-1"></a></span>
<span id="cb72-6"><a href="sagemath-cookbook.html#cb72-6" tabindex="-1"></a><span class="kw">def</span> compute_weight(F, other_x, x_i, y_i):</span>
<span id="cb72-7"><a href="sagemath-cookbook.html#cb72-7" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb72-8"><a href="sagemath-cookbook.html#cb72-8" tabindex="-1"></a><span class="co">  Helper function to copmute the &quot;weight&quot;.</span></span>
<span id="cb72-9"><a href="sagemath-cookbook.html#cb72-9" tabindex="-1"></a><span class="co">  This equals to y_i * l(0) where</span></span>
<span id="cb72-10"><a href="sagemath-cookbook.html#cb72-10" tabindex="-1"></a><span class="co">  l is the lagrange polynomial over F associated with all the </span></span>
<span id="cb72-11"><a href="sagemath-cookbook.html#cb72-11" tabindex="-1"></a><span class="co">  x points. Specifically, it is the polynomial that:</span></span>
<span id="cb72-12"><a href="sagemath-cookbook.html#cb72-12" tabindex="-1"></a><span class="co">  - is 0 on all x in other_x</span></span>
<span id="cb72-13"><a href="sagemath-cookbook.html#cb72-13" tabindex="-1"></a><span class="co">  - is 1 on x_i</span></span>
<span id="cb72-14"><a href="sagemath-cookbook.html#cb72-14" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb72-15"><a href="sagemath-cookbook.html#cb72-15" tabindex="-1"></a>  </span>
<span id="cb72-16"><a href="sagemath-cookbook.html#cb72-16" tabindex="-1"></a>  <span class="co"># Create the points</span></span>
<span id="cb72-17"><a href="sagemath-cookbook.html#cb72-17" tabindex="-1"></a>  points <span class="op">=</span> [(x, <span class="dv">0</span>) <span class="cf">for</span> x <span class="kw">in</span> other_x] <span class="co"># 0 on other_x</span></span>
<span id="cb72-18"><a href="sagemath-cookbook.html#cb72-18" tabindex="-1"></a>  points.append((x_i, <span class="dv">1</span>))            <span class="co"># 1 on x_i</span></span>
<span id="cb72-19"><a href="sagemath-cookbook.html#cb72-19" tabindex="-1"></a></span>
<span id="cb72-20"><a href="sagemath-cookbook.html#cb72-20" tabindex="-1"></a>  <span class="co"># interpolate to find l and evaluate to 0</span></span>
<span id="cb72-21"><a href="sagemath-cookbook.html#cb72-21" tabindex="-1"></a>  R.<span class="op">&lt;</span>x<span class="op">&gt;</span> <span class="op">=</span> PolynomialRing(F)</span>
<span id="cb72-22"><a href="sagemath-cookbook.html#cb72-22" tabindex="-1"></a>  l <span class="op">=</span> R.lagrange_polynomial(points)(x<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb72-23"><a href="sagemath-cookbook.html#cb72-23" tabindex="-1"></a></span>
<span id="cb72-24"><a href="sagemath-cookbook.html#cb72-24" tabindex="-1"></a>  <span class="co"># return the result</span></span>
<span id="cb72-25"><a href="sagemath-cookbook.html#cb72-25" tabindex="-1"></a>  <span class="cf">return</span> l<span class="op">*</span>y_i</span>
<span id="cb72-26"><a href="sagemath-cookbook.html#cb72-26" tabindex="-1"></a></span>
<span id="cb72-27"><a href="sagemath-cookbook.html#cb72-27" tabindex="-1"></a><span class="kw">def</span> elgamal_partial_decrypt(c1, w): </span>
<span id="cb72-28"><a href="sagemath-cookbook.html#cb72-28" tabindex="-1"></a>  </span>
<span id="cb72-29"><a href="sagemath-cookbook.html#cb72-29" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb72-30"><a href="sagemath-cookbook.html#cb72-30" tabindex="-1"></a><span class="co">  Partially decrypts an ElGamal ciphertext.</span></span>
<span id="cb72-31"><a href="sagemath-cookbook.html#cb72-31" tabindex="-1"></a><span class="co">  Takes as input the weight w = l * y_i, and  </span></span>
<span id="cb72-32"><a href="sagemath-cookbook.html#cb72-32" tabindex="-1"></a><span class="co">  the first part of the ciphertext c1 and </span></span>
<span id="cb72-33"><a href="sagemath-cookbook.html#cb72-33" tabindex="-1"></a><span class="co">  outputs an updated c1^w.</span></span>
<span id="cb72-34"><a href="sagemath-cookbook.html#cb72-34" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb72-35"><a href="sagemath-cookbook.html#cb72-35" tabindex="-1"></a></span>
<span id="cb72-36"><a href="sagemath-cookbook.html#cb72-36" tabindex="-1"></a>  <span class="cf">return</span> c1<span class="op">^</span>w</span></code></pre></div>
<p>Next we show how to use the above recipe to threshold-decrypt an ElGamal encrypted message.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="sagemath-cookbook.html#cb73-1" tabindex="-1"></a><span class="co"># We use the threshold_elgamal.sage recipe</span></span>
<span id="cb73-2"><a href="sagemath-cookbook.html#cb73-2" tabindex="-1"></a>load(<span class="st">&#39;threshold_elgamal.sage&#39;</span>)</span>
<span id="cb73-3"><a href="sagemath-cookbook.html#cb73-3" tabindex="-1"></a></span>
<span id="cb73-4"><a href="sagemath-cookbook.html#cb73-4" tabindex="-1"></a><span class="co"># Create an ElGamal key pair</span></span>
<span id="cb73-5"><a href="sagemath-cookbook.html#cb73-5" tabindex="-1"></a>(pk, sk) <span class="op">=</span> elgamal_keygen(<span class="dv">256</span>)</span>
<span id="cb73-6"><a href="sagemath-cookbook.html#cb73-6" tabindex="-1"></a></span>
<span id="cb73-7"><a href="sagemath-cookbook.html#cb73-7" tabindex="-1"></a></span>
<span id="cb73-8"><a href="sagemath-cookbook.html#cb73-8" tabindex="-1"></a><span class="co"># parse the public key</span></span>
<span id="cb73-9"><a href="sagemath-cookbook.html#cb73-9" tabindex="-1"></a>p, q, g, h <span class="op">=</span> (pk[<span class="st">&#39;p&#39;</span>], pk[<span class="st">&#39;q&#39;</span>], pk[<span class="st">&#39;g&#39;</span>], pk[<span class="st">&#39;h&#39;</span>])</span>
<span id="cb73-10"><a href="sagemath-cookbook.html#cb73-10" tabindex="-1"></a>Zp <span class="op">=</span> Integers(p)</span>
<span id="cb73-11"><a href="sagemath-cookbook.html#cb73-11" tabindex="-1"></a></span>
<span id="cb73-12"><a href="sagemath-cookbook.html#cb73-12" tabindex="-1"></a><span class="co"># get also the field F_q</span></span>
<span id="cb73-13"><a href="sagemath-cookbook.html#cb73-13" tabindex="-1"></a><span class="co"># The key is an F_q element so this is the correct field</span></span>
<span id="cb73-14"><a href="sagemath-cookbook.html#cb73-14" tabindex="-1"></a>F <span class="op">=</span> GF(q)</span>
<span id="cb73-15"><a href="sagemath-cookbook.html#cb73-15" tabindex="-1"></a></span>
<span id="cb73-16"><a href="sagemath-cookbook.html#cb73-16" tabindex="-1"></a><span class="co"># Secret share the public key to 12 parties, 3 of which </span></span>
<span id="cb73-17"><a href="sagemath-cookbook.html#cb73-17" tabindex="-1"></a><span class="co"># must collaborate to decrypt</span></span>
<span id="cb73-18"><a href="sagemath-cookbook.html#cb73-18" tabindex="-1"></a>shares <span class="op">=</span> shamir_share(F, sk, <span class="dv">3</span>, <span class="dv">12</span>)</span>
<span id="cb73-19"><a href="sagemath-cookbook.html#cb73-19" tabindex="-1"></a></span>
<span id="cb73-20"><a href="sagemath-cookbook.html#cb73-20" tabindex="-1"></a><span class="co"># encrypt a random message</span></span>
<span id="cb73-21"><a href="sagemath-cookbook.html#cb73-21" tabindex="-1"></a><span class="co"># recall the message should be a *subgroup* element</span></span>
<span id="cb73-22"><a href="sagemath-cookbook.html#cb73-22" tabindex="-1"></a>m <span class="op">=</span> Zp.random_element()</span>
<span id="cb73-23"><a href="sagemath-cookbook.html#cb73-23" tabindex="-1"></a><span class="cf">while</span> m.multiplicative_order() <span class="op">!=</span> q: </span>
<span id="cb73-24"><a href="sagemath-cookbook.html#cb73-24" tabindex="-1"></a>  m <span class="op">=</span> Zp.random_element()</span>
<span id="cb73-25"><a href="sagemath-cookbook.html#cb73-25" tabindex="-1"></a></span>
<span id="cb73-26"><a href="sagemath-cookbook.html#cb73-26" tabindex="-1"></a><span class="co"># encrypt the message  </span></span>
<span id="cb73-27"><a href="sagemath-cookbook.html#cb73-27" tabindex="-1"></a>(c1, c2) <span class="op">=</span> elgamal_encrypt(pk, m)</span>
<span id="cb73-28"><a href="sagemath-cookbook.html#cb73-28" tabindex="-1"></a></span>
<span id="cb73-29"><a href="sagemath-cookbook.html#cb73-29" tabindex="-1"></a><span class="co"># parties 1, 6, 7 want to decrypt c</span></span>
<span id="cb73-30"><a href="sagemath-cookbook.html#cb73-30" tabindex="-1"></a></span>
<span id="cb73-31"><a href="sagemath-cookbook.html#cb73-31" tabindex="-1"></a><span class="co"># Party 1 computes the partial decryption</span></span>
<span id="cb73-32"><a href="sagemath-cookbook.html#cb73-32" tabindex="-1"></a>y1 <span class="op">=</span> shares[<span class="dv">0</span>][<span class="dv">1</span>] </span>
<span id="cb73-33"><a href="sagemath-cookbook.html#cb73-33" tabindex="-1"></a>w1 <span class="op">=</span> compute_weight(F, [<span class="dv">6</span>,<span class="dv">7</span>], <span class="dv">1</span>, y1)</span>
<span id="cb73-34"><a href="sagemath-cookbook.html#cb73-34" tabindex="-1"></a><span class="co"># Partial decryption </span></span>
<span id="cb73-35"><a href="sagemath-cookbook.html#cb73-35" tabindex="-1"></a>c1_1 <span class="op">=</span> elgamal_partial_decrypt(c1, w1)</span>
<span id="cb73-36"><a href="sagemath-cookbook.html#cb73-36" tabindex="-1"></a></span>
<span id="cb73-37"><a href="sagemath-cookbook.html#cb73-37" tabindex="-1"></a><span class="co"># Party 6 computes the partial decryption</span></span>
<span id="cb73-38"><a href="sagemath-cookbook.html#cb73-38" tabindex="-1"></a>y6 <span class="op">=</span> shares[<span class="dv">5</span>][<span class="dv">1</span>] </span>
<span id="cb73-39"><a href="sagemath-cookbook.html#cb73-39" tabindex="-1"></a>w6 <span class="op">=</span> compute_weight(F, [<span class="dv">1</span>,<span class="dv">7</span>], <span class="dv">6</span>, y6)</span>
<span id="cb73-40"><a href="sagemath-cookbook.html#cb73-40" tabindex="-1"></a><span class="co"># Partial decryption </span></span>
<span id="cb73-41"><a href="sagemath-cookbook.html#cb73-41" tabindex="-1"></a>c1_6 <span class="op">=</span> elgamal_partial_decrypt(c1, w6)</span>
<span id="cb73-42"><a href="sagemath-cookbook.html#cb73-42" tabindex="-1"></a></span>
<span id="cb73-43"><a href="sagemath-cookbook.html#cb73-43" tabindex="-1"></a><span class="co"># Party 7 computes the partial decryption</span></span>
<span id="cb73-44"><a href="sagemath-cookbook.html#cb73-44" tabindex="-1"></a>y7 <span class="op">=</span> shares[<span class="dv">6</span>][<span class="dv">1</span>] </span>
<span id="cb73-45"><a href="sagemath-cookbook.html#cb73-45" tabindex="-1"></a>w7 <span class="op">=</span> compute_weight(F, [<span class="dv">1</span>,<span class="dv">6</span>], <span class="dv">7</span>, y7)</span>
<span id="cb73-46"><a href="sagemath-cookbook.html#cb73-46" tabindex="-1"></a><span class="co"># Partial decryption </span></span>
<span id="cb73-47"><a href="sagemath-cookbook.html#cb73-47" tabindex="-1"></a>c1_7 <span class="op">=</span> elgamal_partial_decrypt(c1, w7)</span>
<span id="cb73-48"><a href="sagemath-cookbook.html#cb73-48" tabindex="-1"></a></span>
<span id="cb73-49"><a href="sagemath-cookbook.html#cb73-49" tabindex="-1"></a><span class="co"># The parties share the partial decryptions with each other</span></span>
<span id="cb73-50"><a href="sagemath-cookbook.html#cb73-50" tabindex="-1"></a><span class="co"># Each party can now combine them</span></span>
<span id="cb73-51"><a href="sagemath-cookbook.html#cb73-51" tabindex="-1"></a>alpha <span class="op">=</span> c1_1 <span class="op">*</span> c1_6 <span class="op">*</span> c1_7</span>
<span id="cb73-52"><a href="sagemath-cookbook.html#cb73-52" tabindex="-1"></a></span>
<span id="cb73-53"><a href="sagemath-cookbook.html#cb73-53" tabindex="-1"></a><span class="co"># and decrypt </span></span>
<span id="cb73-54"><a href="sagemath-cookbook.html#cb73-54" tabindex="-1"></a>m_prime <span class="op">=</span> c2 <span class="op">*</span> alpha<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>) </span>
<span id="cb73-55"><a href="sagemath-cookbook.html#cb73-55" tabindex="-1"></a></span>
<span id="cb73-56"><a href="sagemath-cookbook.html#cb73-56" tabindex="-1"></a><span class="co"># in case of lifted el gamal everything is the shame, except that </span></span>
<span id="cb73-57"><a href="sagemath-cookbook.html#cb73-57" tabindex="-1"></a><span class="co"># now we need to brute force c2 * c1^(-1) to get the actual message</span></span>
<span id="cb73-58"><a href="sagemath-cookbook.html#cb73-58" tabindex="-1"></a></span>
<span id="cb73-59"><a href="sagemath-cookbook.html#cb73-59" tabindex="-1"></a><span class="cf">assert</span> m <span class="op">==</span> m_prime</span></code></pre></div>
</div>
</div>
<div id="zero-knowledge-proofs-1" class="section level2 hasAnchor" number="17.14">
<h2><span class="header-section-number">E.14</span> Zero Knowledge Proofs<a href="sagemath-cookbook.html#zero-knowledge-proofs-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section we present the Schnorr protocol for proving knowledge of discrete logarithms. We do this over secp256k1 just for the fun of it. It is easy to adapt it to safe prime groups.</p>
<div id="schnorr-protocol-over-secp256k1" class="section level3 unnumbered hasAnchor">
<h3>Schnorr Protocol over secp256k1<a href="sagemath-cookbook.html#schnorr-protocol-over-secp256k1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We next present the prove and verify algorithms for the Schnorr protocol. To derive the Fiat-Shamir challenge we use the SHA256 implementation
of <code>hashlib</code>. Note how we <em>hash the curve specs and the statement</em> to derive the challenge. The prover should always hash all the information
exchanged by both parties!</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="sagemath-cookbook.html#cb74-1" tabindex="-1"></a><span class="co"># HVZK proof to prove knowledge of the discrete logarithm of an </span></span>
<span id="cb74-2"><a href="sagemath-cookbook.html#cb74-2" tabindex="-1"></a><span class="co"># element in secp256k1 curve. SHA256 is used as a hash function</span></span>
<span id="cb74-3"><a href="sagemath-cookbook.html#cb74-3" tabindex="-1"></a></span>
<span id="cb74-4"><a href="sagemath-cookbook.html#cb74-4" tabindex="-1"></a><span class="co"># import sha256</span></span>
<span id="cb74-5"><a href="sagemath-cookbook.html#cb74-5" tabindex="-1"></a><span class="im">from</span> hashlib <span class="im">import</span> sha256</span>
<span id="cb74-6"><a href="sagemath-cookbook.html#cb74-6" tabindex="-1"></a></span>
<span id="cb74-7"><a href="sagemath-cookbook.html#cb74-7" tabindex="-1"></a><span class="co">###</span></span>
<span id="cb74-8"><a href="sagemath-cookbook.html#cb74-8" tabindex="-1"></a><span class="kw">def</span> schnorr_prove(h, x):</span>
<span id="cb74-9"><a href="sagemath-cookbook.html#cb74-9" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb74-10"><a href="sagemath-cookbook.html#cb74-10" tabindex="-1"></a><span class="co">  Create a proof pi that h = x*g</span></span>
<span id="cb74-11"><a href="sagemath-cookbook.html#cb74-11" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb74-12"><a href="sagemath-cookbook.html#cb74-12" tabindex="-1"></a></span>
<span id="cb74-13"><a href="sagemath-cookbook.html#cb74-13" tabindex="-1"></a>  <span class="co"># Define the curve and the scalar field</span></span>
<span id="cb74-14"><a href="sagemath-cookbook.html#cb74-14" tabindex="-1"></a>  (E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb74-15"><a href="sagemath-cookbook.html#cb74-15" tabindex="-1"></a>  Fq <span class="op">=</span> GF(q)</span>
<span id="cb74-16"><a href="sagemath-cookbook.html#cb74-16" tabindex="-1"></a></span>
<span id="cb74-17"><a href="sagemath-cookbook.html#cb74-17" tabindex="-1"></a>  <span class="co"># We first sample a random element r and the element r*g</span></span>
<span id="cb74-18"><a href="sagemath-cookbook.html#cb74-18" tabindex="-1"></a>  r <span class="op">=</span> Fq.random_element()</span>
<span id="cb74-19"><a href="sagemath-cookbook.html#cb74-19" tabindex="-1"></a>  u <span class="op">=</span> r <span class="op">*</span> g</span>
<span id="cb74-20"><a href="sagemath-cookbook.html#cb74-20" tabindex="-1"></a></span>
<span id="cb74-21"><a href="sagemath-cookbook.html#cb74-21" tabindex="-1"></a>  <span class="co"># We know should get the random challenge. We compute it </span></span>
<span id="cb74-22"><a href="sagemath-cookbook.html#cb74-22" tabindex="-1"></a>  <span class="co"># by hashing H(&quot;secp256k1&quot;, h, u).</span></span>
<span id="cb74-23"><a href="sagemath-cookbook.html#cb74-23" tabindex="-1"></a>  hash_input <span class="op">=</span> <span class="st">&#39;secp256k1&#39;</span> <span class="op">+</span> <span class="bu">str</span>(h) <span class="op">+</span> <span class="bu">str</span>(u)</span>
<span id="cb74-24"><a href="sagemath-cookbook.html#cb74-24" tabindex="-1"></a>  digest <span class="op">=</span> sha256(hash_input.encode()).hexdigest()</span>
<span id="cb74-25"><a href="sagemath-cookbook.html#cb74-25" tabindex="-1"></a></span>
<span id="cb74-26"><a href="sagemath-cookbook.html#cb74-26" tabindex="-1"></a>  <span class="co"># q has ~256 bits and the digest is exactly 256 bits. We therefore </span></span>
<span id="cb74-27"><a href="sagemath-cookbook.html#cb74-27" tabindex="-1"></a>  <span class="co"># keep only 252 bits of the ouptut to create c. Note that we encode</span></span>
<span id="cb74-28"><a href="sagemath-cookbook.html#cb74-28" tabindex="-1"></a>  <span class="co"># the message as an Fq element</span></span>
<span id="cb74-29"><a href="sagemath-cookbook.html#cb74-29" tabindex="-1"></a>  c <span class="op">=</span> Fq(<span class="bu">int</span>(<span class="st">&#39;0x&#39;</span><span class="op">+</span> digest[:<span class="op">-</span><span class="dv">1</span>], <span class="dv">16</span>))</span>
<span id="cb74-30"><a href="sagemath-cookbook.html#cb74-30" tabindex="-1"></a></span>
<span id="cb74-31"><a href="sagemath-cookbook.html#cb74-31" tabindex="-1"></a>  <span class="co"># Finally we create the last message z </span></span>
<span id="cb74-32"><a href="sagemath-cookbook.html#cb74-32" tabindex="-1"></a>  z <span class="op">=</span> r <span class="op">+</span> c<span class="op">*</span>x</span>
<span id="cb74-33"><a href="sagemath-cookbook.html#cb74-33" tabindex="-1"></a></span>
<span id="cb74-34"><a href="sagemath-cookbook.html#cb74-34" tabindex="-1"></a>  <span class="co"># We output the proof. Note that c is not included since the verifier </span></span>
<span id="cb74-35"><a href="sagemath-cookbook.html#cb74-35" tabindex="-1"></a>  <span class="co"># can compute it on its own</span></span>
<span id="cb74-36"><a href="sagemath-cookbook.html#cb74-36" tabindex="-1"></a>  proof <span class="op">=</span> (u, z)</span>
<span id="cb74-37"><a href="sagemath-cookbook.html#cb74-37" tabindex="-1"></a>  <span class="cf">return</span> proof</span>
<span id="cb74-38"><a href="sagemath-cookbook.html#cb74-38" tabindex="-1"></a></span>
<span id="cb74-39"><a href="sagemath-cookbook.html#cb74-39" tabindex="-1"></a><span class="kw">def</span> schnorr_verify(h, proof):</span>
<span id="cb74-40"><a href="sagemath-cookbook.html#cb74-40" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb74-41"><a href="sagemath-cookbook.html#cb74-41" tabindex="-1"></a><span class="co">  verify a proof of knowledge of dlog of h</span></span>
<span id="cb74-42"><a href="sagemath-cookbook.html#cb74-42" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb74-43"><a href="sagemath-cookbook.html#cb74-43" tabindex="-1"></a></span>
<span id="cb74-44"><a href="sagemath-cookbook.html#cb74-44" tabindex="-1"></a>  <span class="co"># Define the curve and the scalar field</span></span>
<span id="cb74-45"><a href="sagemath-cookbook.html#cb74-45" tabindex="-1"></a>  (E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb74-46"><a href="sagemath-cookbook.html#cb74-46" tabindex="-1"></a>  Fq <span class="op">=</span> GF(q)</span>
<span id="cb74-47"><a href="sagemath-cookbook.html#cb74-47" tabindex="-1"></a></span>
<span id="cb74-48"><a href="sagemath-cookbook.html#cb74-48" tabindex="-1"></a>  (u, z) <span class="op">=</span> proof</span>
<span id="cb74-49"><a href="sagemath-cookbook.html#cb74-49" tabindex="-1"></a></span>
<span id="cb74-50"><a href="sagemath-cookbook.html#cb74-50" tabindex="-1"></a>  <span class="co"># We compute the hash as the prover given  </span></span>
<span id="cb74-51"><a href="sagemath-cookbook.html#cb74-51" tabindex="-1"></a>  hash_input <span class="op">=</span> <span class="st">&#39;secp256k1&#39;</span> <span class="op">+</span> <span class="bu">str</span>(h) <span class="op">+</span> <span class="bu">str</span>(u)</span>
<span id="cb74-52"><a href="sagemath-cookbook.html#cb74-52" tabindex="-1"></a>  digest <span class="op">=</span> sha256(hash_input.encode()).hexdigest()</span>
<span id="cb74-53"><a href="sagemath-cookbook.html#cb74-53" tabindex="-1"></a>  c <span class="op">=</span> Fq(<span class="bu">int</span>(<span class="st">&#39;0x&#39;</span><span class="op">+</span> digest[:<span class="op">-</span><span class="dv">1</span>], <span class="dv">16</span>))</span>
<span id="cb74-54"><a href="sagemath-cookbook.html#cb74-54" tabindex="-1"></a>  </span>
<span id="cb74-55"><a href="sagemath-cookbook.html#cb74-55" tabindex="-1"></a>  <span class="co"># Finally we do the final verification by checking the </span></span>
<span id="cb74-56"><a href="sagemath-cookbook.html#cb74-56" tabindex="-1"></a>  <span class="co"># equation zg = ch+u</span></span>
<span id="cb74-57"><a href="sagemath-cookbook.html#cb74-57" tabindex="-1"></a></span>
<span id="cb74-58"><a href="sagemath-cookbook.html#cb74-58" tabindex="-1"></a>  <span class="cf">return</span> z<span class="op">*</span>g <span class="op">==</span> c<span class="op">*</span>h <span class="op">+</span> u</span></code></pre></div>
<p>Next we present an actual run of the protocol for a random statement. Note that this is exactly the proof of knowledge of an ElGamal secret key
over secp256k1!</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="sagemath-cookbook.html#cb75-1" tabindex="-1"></a><span class="co"># We use the schnorr recipe</span></span>
<span id="cb75-2"><a href="sagemath-cookbook.html#cb75-2" tabindex="-1"></a>load(<span class="st">&#39;schnorr.sage&#39;</span>)</span>
<span id="cb75-3"><a href="sagemath-cookbook.html#cb75-3" tabindex="-1"></a></span>
<span id="cb75-4"><a href="sagemath-cookbook.html#cb75-4" tabindex="-1"></a><span class="co"># define the curve and Fq</span></span>
<span id="cb75-5"><a href="sagemath-cookbook.html#cb75-5" tabindex="-1"></a>(E, p, q, g) <span class="op">=</span> secp256k1_params()</span>
<span id="cb75-6"><a href="sagemath-cookbook.html#cb75-6" tabindex="-1"></a>Fq <span class="op">=</span> GF(q)</span>
<span id="cb75-7"><a href="sagemath-cookbook.html#cb75-7" tabindex="-1"></a></span>
<span id="cb75-8"><a href="sagemath-cookbook.html#cb75-8" tabindex="-1"></a><span class="co"># sample a random element </span></span>
<span id="cb75-9"><a href="sagemath-cookbook.html#cb75-9" tabindex="-1"></a>x <span class="op">=</span> Fq.random_element()</span>
<span id="cb75-10"><a href="sagemath-cookbook.html#cb75-10" tabindex="-1"></a></span>
<span id="cb75-11"><a href="sagemath-cookbook.html#cb75-11" tabindex="-1"></a><span class="co"># define the statement h</span></span>
<span id="cb75-12"><a href="sagemath-cookbook.html#cb75-12" tabindex="-1"></a>h <span class="op">=</span> x<span class="op">*</span>g</span>
<span id="cb75-13"><a href="sagemath-cookbook.html#cb75-13" tabindex="-1"></a></span>
<span id="cb75-14"><a href="sagemath-cookbook.html#cb75-14" tabindex="-1"></a><span class="co"># Create a proof of knowledge of dlog of h</span></span>
<span id="cb75-15"><a href="sagemath-cookbook.html#cb75-15" tabindex="-1"></a>proof <span class="op">=</span> schnorr_prove(h, x)</span>
<span id="cb75-16"><a href="sagemath-cookbook.html#cb75-16" tabindex="-1"></a></span>
<span id="cb75-17"><a href="sagemath-cookbook.html#cb75-17" tabindex="-1"></a><span class="co"># verify the proof</span></span>
<span id="cb75-18"><a href="sagemath-cookbook.html#cb75-18" tabindex="-1"></a><span class="cf">assert</span> schnorr_verify(h, proof)</span></code></pre></div>

</div>
</div>
</div>

























































































































































            </section>

          </div>
        </div>
      </div>
<a href="refreshers.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
